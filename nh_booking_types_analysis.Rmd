---
title: "Sentence Statuses Analysis"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    theme: theme.css
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

# Load functions, packages, and data
source("code/00_library.R")
source("code/01_functions.R")
source("code/rdas.R")
```

## Sentence Statuses

The following booking patterns were found using jail administrative data submitted directly to CSG. DHHS matched-to-Medicaid data does not have information on sentence statuses. The "other" category includes federal holds, holds for other agencies, 24 hour and 72 hour holds, other holds, dual status, bail set, bond denied, dismissed, and sentence suspended.  

### Sentence Statuses State-wide

The majority of bookings result in a pretrial sentence status, followed by protective custody.  

```{r}
# count number of and proportion of bookings for different sentence statuses for pie chart
data1 <- bookings_entrances %>% 
  mutate(sentence_status_standard = ifelse(sentence_status_standard == "UNKNOWN", NA, sentence_status_standard)) %>% 
  group_by(sentence_status_standard) %>% 
  summarise(total = n_distinct(booking_id)) %>% 
  filter(!is.na(sentence_status_standard)) %>% 
  mutate(state = "New Hampshire",
         sentence_status_standard = str_to_title(sentence_status_standard)) %>%
  mutate(pct = total/sum(total)*100) %>%
  mutate(pct = round(pct, 0)) %>% 
  mutate(pct = paste0(pct, "%")) %>% 
  mutate(sentence_status_standard = factor(sentence_status_standard, levels = c("Pretrial", "Protective Custody","Sentenced", "Other")))

# Pie chart for all three years
ggplot(data1, aes(x = state, y = total, fill = sentence_status_standard)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c(jri_orange, jri_light_blue, jri_green, "gray")) +
  geom_text(aes(label = pct, 
                fontface = 'bold'), 
                position = position_fill(vjust = 0.5),
                size = 7.5,
                family = "Franklin Gothic Book",
                color = ifelse(data1$sentence_status_standard == "Other", "black", "white")
            ) +
  theme(legend.position = "top",
        legend.justification = c(0, 0),
        legend.title=element_blank(),
        axis.title.y = element_blank()) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank())

# ggsave(PRES_gg_pie_pretrial, file=paste0(sp_data_path, "/analysis/img/PRES_gg_pie_pretrial.png"), width = 8,  height = 8, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_pie_pretrial.png"))
### write out
ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_pie_pretrial.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 100,
    height = 8,
    width = 8,
    units = "in",
    bg = "transparent"
  )
```

```{r}
# If sentence status is unknown, make NA
data1 <- bookings_entrances %>% 
  select(sentence_status_standard, booking_id) %>% 
  distinct() %>% 
  mutate(sentence_status_standard = ifelse(sentence_status_standard == "UNKNOWN", NA, sentence_status_standard))

# get frequencies for different sentence statuses
data1 <- data.frame(summarytools::freq(data1$sentence_status_standard, order = "freq", cum.percent = FALSE))
data1 <- data1 %>% tibble::rownames_to_column("sentence_status_standard") %>%
  dplyr::select(`Sentence Status` = sentence_status_standard,
                `Unique Bookings (N)` = Freq,
                `Proportion of Bookings (%)` = X..Valid) %>% 
  mutate(`Proportion of Bookings (%)` = percent(`Proportion of Bookings (%)`/100))

# create kable table
kable(data1, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(6, bold = TRUE)
```

### Sentence Statuses by County (N)

The number of sentence statuses by county from 2019 to 2021.  

```{r}
# Df of total number of entrances by county
df_entrances_county <- bookings_entrances %>%
  dplyr::ungroup() %>%
  dplyr::select(booking_id, county) %>%
  dplyr::distinct() %>%
  dplyr::group_by(county) %>%
  dplyr::summarise(total = n_distinct(booking_id))

# Number of sentence types by county for all three years
# Reshape table for viewing
df_sentence_statuses_county <- bookings_entrances %>%
  dplyr::ungroup() %>%
  dplyr::select(booking_id, county, sentence_status_standard) %>%
  dplyr::distinct() %>%
  dplyr::group_by(county, sentence_status_standard) %>%
  dplyr::summarise(total = n_distinct(booking_id)) %>% 
  spread(sentence_status_standard, total) %>% clean_names() %>% 
  select(County                   = county,
         `Pretrial (N)`           = pretrial,
         `Protective Custody (N)` = protective_custody,
         `Sentenced (N)`          = sentenced,
         `Other (N)`              = other,
         `Unknown (N)`            = unknown) %>% 
  left_join(df_entrances_county, by = c("County" = "county")) %>% 
  rename(`Total Entrances (N)` = total)

# create kable table
kable(df_sentence_statuses_county, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
   column_spec(1, bold = T, width = "12em") %>% 
   column_spec(2, width = "8em") %>% 
   column_spec(3, width = "8em") %>% 
   column_spec(4, width = "8em") %>% 
   column_spec(5, width = "8em") %>% 
   column_spec(6, width = "8em") %>% 
   column_spec(7, width = "8em")
```

<br>

### Sentence Statuses by County (%)

The proportion of sentence statuses by county from 2019 to 2021.  

```{r}
# calculate proportion of sentence statuses out of all entrances
df_sentence_statuses_county_pct <- df_sentence_statuses_county %>% 
  mutate(`Pretrial %`             = percent(`Pretrial (N)`/`Total Entrances (N)`),
         `Protective Custody (%)` = percent(`Protective Custody (N)`/`Total Entrances (N)`),
         `Sentenced (%)`          = percent(`Sentenced (N)`/`Total Entrances (N)`),
         `Other (%)`              = percent(`Other (N)`/`Total Entrances (N)`),
         `Unknown (%)`            = percent(`Unknown (N)`/`Total Entrances (N)`)
         ) %>% 
  select(-c(
         `Pretrial (N)`,
         `Protective Custody (N)`,
         `Sentenced (N)`,
         `Other (N)`,
         `Unknown (N)`,
         `Total Entrances (N)`))

# create kable table
kable(df_sentence_statuses_county_pct, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
   column_spec(1, bold = T, width = "12em") %>% 
   column_spec(2, width = "8em") %>% 
   column_spec(3, width = "8em") %>% 
   column_spec(4, width = "8em") %>% 
   column_spec(5, width = "8em") %>% 
   column_spec(6, width = "8em") 
```

<br>

**Proportion of jail bookings that are pretrial by county**

There was substantial variation among counties for the proportion of bookings that were pretrial. Hillsborough had the highest proportion of bookings that were pretrial.  

```{r}
# number of pretrial by county for all three years
data1 <- bookings_entrances %>%
  dplyr::ungroup() %>%
  dplyr::select(booking_id, county, sentence_status_standard) %>%
    mutate(sentence_status_standard = case_when(
    sentence_status_standard == "OTHER"              ~ "Not Pretrial",
    sentence_status_standard == "PROTECTIVE CUSTODY" ~ "Not Pretrial",
    sentence_status_standard == "SENTENCED"          ~ "Not Pretrial",
    sentence_status_standard == "UNKNOWN"            ~ "Not Pretrial",
    sentence_status_standard == "PRETRIAL"           ~ "Pretrial"
  )) %>% 
  dplyr::distinct() %>%
  dplyr::group_by(county, sentence_status_standard) %>%
  dplyr::summarise(total = n()) %>% 
  filter(county != "Strafford") %>% 
  mutate(pct = round(total/sum(total)*100, 0))

# ggplot for proportion of pretrial by county
ggplot(data1, aes(x = county, y = total, fill = sentence_status_standard)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("gray",jri_orange),
                    na.value = "white",
                    labels = c("Not Pretrial      ","Pretrial", " ")
                    ) +
  geom_text(aes(label = ifelse(pct > 4, paste(pct, "%", sep = ""), ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(data1$sentence_status_standard == "Not Pretrial" ~ "black",
                              TRUE ~ "white")) +
  theme_no_grid_no_labels +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 0.85, color = "black"))

# ggsave(PRES_gg_pretrial_prop, file=paste0(sp_data_path, "/analysis/img/PRES_gg_pretrial_prop.png"), width = 13,  height = 8, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_pretrial_prop.png"))
ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_pretrial_prop.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 100,
    width = 14,
    height = 8,
    units = "in",
    bg = "transparent"
  )
```









<br>

## Sentence Statuses and Charge Types

### Charge Type by Sentence Status (Row sum)

The number and proportion of charge types by sentence statuses from 2019 to 2021. This table shows column sum. For example, of all sentence statuses that were pretrial, 31% of bookings had a violent charge type.  

```{r}
# get proportion of charge types by sentence status
data1 <- table(adm_all$crime_type_lookup, adm_all$sentence_status_standard)
table1 <- prop.table(data1, 2) # row sum
table1 <- as.data.frame(cbind(data1, table1))

# Rename variables
table1 <- table1 %>% 
       rename("Other (N)"              = 1,
              "Pretrial (N)"           = 2,
              "Protective Custody (N)" = 3,
              "Sentenced (N)"          = 4,
              "Unknown (N)"            = 5,
              "Other (%)"              = 6,
              "Pretrial (%)"           = 7,
              "Protective Custody (%)" = 8,
              "Sentenced (%)"          = 9,
              "Unknown (%)"            = 10) %>% 
  rownames_to_column("Charge Type")

# sep tables into N and % 
table_n   <- table1 %>% select(1:6)
table_pct <- table1 %>% select(1, 7:11)

# create reactable table for N
reactable(table_n,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold"))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)

# create reactable table for %
reactable(table_pct,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold")),
            `NH State Prisoner (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Other (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Pretrial (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Protective Custody (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Sentenced (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Unknown (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

<br>

### Charge Type by Sentence Status (Column sum)

The number and proportion of charge types by sentence statuses from 2019 to 2021. This table shows row sum. For example, of all charge types that were drug/alcohol, 73% resulted in a pretrial sentence status.   

```{r}
# get proportion of charge types by sentence status
data1 <- table(adm_all$crime_type_lookup, adm_all$sentence_status_standard)
table1 <- prop.table(data1, 1) # column sum
table1 <- as.data.frame(cbind(data1, table1))

# Rename variables
table1 <- table1 %>% 
       rename("Other (N)"              = 1,
              "Pretrial (N)"           = 2,
              "Protective Custody (N)" = 3,
              "Sentenced (N)"          = 4,
              "Unknown (N)"            = 5,
              "Other (%)"              = 6,
              "Pretrial (%)"           = 7,
              "Protective Custody (%)" = 8,
              "Sentenced (%)"          = 9,
              "Unknown (%)"            = 10) %>% 
  rownames_to_column("Charge Type")

# sep tables into N and % 
table_n   <- table1 %>% select(1:6)
table_pct <- table1 %>% select(1, 7:11)

# create reactable table for N
reactable(table_n,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold"))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)

# create reactable table for %
reactable(table_pct,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold")),
            `NH State Prisoner (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Other (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Pretrial (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Protective Custody (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Sentenced (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Unknown (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

<br>

### High Utilizers and Sentence Statuses (Row sum)

This table shows row sum. For example, of the bookings by tier 1 high utilizers, 40% were pretrial and 27% were protective custody.  

```{r}
# select HU entrances
df_hus_entrances <- adm_all %>% 
  select(id, 
         booking_id, 
         sentence_status_standard,
         county, 
         fy,
         num_entrances,
         hu_group_exclusive) %>% 
  distinct() %>% 
  filter(sentence_status_standard != "UNKNOWN")

# get proportion of sentence statuses by HU type
data1 <- table(df_hus_entrances$sentence_status_standard, df_hus_entrances$hu_group_exclusive)
table1 <- prop.table(data1, 2)
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>% 
  rename(`Tier 1 HU`   = 1,
         `Tier 2 HU`   = 2, 
         `Tier 3 HU`   = 3, 
         `Non-HU`      = 4,  
         `Tier 1 HU.1` = 5,  
         `Tier 2 HU.1` = 6,  
         `Tier 3 HU.1` = 7,     
         `Non-HU.1`    = 8) %>% 
  rownames_to_column("Entrance Type")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Entrance Type` = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Tier 1 HU`        = colDef(name = "Tier 1 HU (N)",  minWidth = 100),
            `Tier 2 HU`        = colDef(name = "Tier 2 HU (N)",  minWidth = 100),
            `Tier 3 HU`       = colDef(name = "Tier 3 HU (N)", minWidth = 100),
            `Non-HU%`       = colDef(name = "Non-HU (N)",  minWidth = 100),

            `Tier 1 HU.1`      = colDef(name = "Tier 1 HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Tier 2 HU.1`      = colDef(name = "Tier 2 HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Tier 3 HU.1`     = colDef(name = "Tier 3 HU (%)", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Non-HU.1`      = colDef(name = "Non-HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

<br>

### High Utilizers and Sentence Statuses (Column sum)

This table shows column sum. For example, of the bookings that resulted in a pretrial sentence status, 4% were by tier 1 high utilizers.    

```{r}
# get proportion of sentence statuses by HU type
data1 <- table(df_hus_entrances$sentence_status_standard, df_hus_entrances$hu_group_exclusive)
table1 <- prop.table(data1, 1)
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>%   
  rename(`Tier 1 HU`   = 1,
         `Tier 2 HU`   = 2, 
         `Tier 3 HU`   = 3, 
         `Non-HU`      = 4,  
         `Tier 1 HU.1` = 5,  
         `Tier 2 HU.1` = 6,  
         `Tier 3 HU.1` = 7,     
         `Non-HU.1`    = 8) %>% 
  rownames_to_column("Entrance Type")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Entrance Type` = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Tier 1 HU`        = colDef(name = "Tier 1 HU (N)",  minWidth = 100),
            `Tier 2 HU`        = colDef(name = "Tier 2 HU (N)",  minWidth = 100),
            `Tier 3 HU`       = colDef(name = "Tier 3 HU (N)", minWidth = 100),
            `Non-HU%`       = colDef(name = "Non-HU (N)",  minWidth = 100),

            `Tier 1 HU.1`      = colDef(name = "Tier 1 HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Tier 2 HU.1`      = colDef(name = "Tier 2 HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Tier 3 HU.1`     = colDef(name = "Tier 3 HU (%)", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Non-HU.1`      = colDef(name = "Non-HU (%)",  minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

















<br>

## Drug Courts

Only Cheshire, Hillsborough, and Rockingham County collect booking information related to [drug courts](https://www.courts.nh.gov/our-courts/drug-mental-health-courts).  

Specialty court programs for people involved in the criminal jusice system with substance abuse or mental health diagnoses are available in various Superior and Circuit Court District Division locations in New Hampshire. These treatment courts combine community based treatment programs with strict court supervision and progressive incentives and sanctions. By linking people to treatment services, the program aims to address offender's substance abuse and mental health diagnoses that led to criminal behavior, thereby reducing recidivism, and protecting public safety. These treatment court programs are designed to promote compliance with treatment programs as an alternative to jail time.

Felony drug court programs for adult offenders are available in Belknap, Carroll, Cheshire, Coos, Grafton, Hillsborough (North and South), Merrimack, Rockingham, and Strafford Counties. A defendant who enters those drug court programs must reside in the County where drug court is offered, in addition to having committed the crime in that county. 

```{r}
# select variables and counties to look at drug courts
# see if the booking is related to drug courts (sentenced or pretrial)
df_drug_courts <- adm_all %>% 
  filter(county == "Cheshire" |
         county == "Hillsborough" |
         county == "Rockingham") %>% 
  filter(pc_hold == "Non-PC Hold") %>% 
  select(id, 
         booking_id, 
         sentence_status,
         sentence_status_standard,
         county, 
         fy,
         num_entrances,
         hu_group_overall,
         hu_group_exclusive,
         drug_court_pretrial,
         drug_court_sentenced,
         crime_type_lookup,
         descriptor_lookup) %>%
  filter(!is.na(drug_court_pretrial) & !is.na(drug_court_sentenced)) %>% 
  distinct() %>% 
  mutate(drug_court = case_when(drug_court_pretrial == 1 | drug_court_sentenced == 1 ~ "Drug court-related booking", 
                                drug_court_pretrial == 0 | drug_court_sentenced == 0 ~ "Not a drug court-related booking"),
         hillsborough_drug_court_location = case_when(
           sentence_status == "SENTENCED-HSC NORTH DRUG COURT SANCTION" ~ "North",
           sentence_status == "SENTENCED-HSC SOUTH DRUG COURT SANCTION" ~ "South",
           TRUE ~ NA
         ))

# remove violent offenses - these should not be categorized as drug court
df_drug_courts <- df_drug_courts %>%
  mutate(drug_court = case_when(drug_court == "Drug court-related booking" & crime_type_lookup == "Violent" ~ "Not a drug court-related booking", TRUE ~ drug_court))
```

### Drug court-related bookings by county

Drug-court related bookings accounted for 5% of all jail bookings in Cheshire, Hillsborough, and Rockingham County jails.  

```{r}
# get proportion of bookings that were drug court-related
data1 <- table(df_drug_courts$county, df_drug_courts$drug_court)
table1 <- prop.table(data1, 1)
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>% 
  rename(`Drug court-related booking` = 1,
         `Not a drug court-related booking` = 2,
         `Drug court-related booking.1` = 3,
         `Not a drug court-related booking.1` = 4) %>% 
  rownames_to_column("County")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

<br>

```{r}
data1 <- df_drug_courts %>% 
  group_by(drug_court, county) %>%  
  summarise(total_bookings = n_distinct(booking_id),
            total_people   = n_distinct(id))

# create reactable table
reactable(data1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            drug_court     = colDef(name = "Booking Type", minWidth = 275, style = list(fontWeight = "bold")),
            county         = colDef(name = "County", minWidth = 100),
            total_bookings = colDef(name = "Bookings", minWidth = 100),
            total_people   = colDef(name = "People", minWidth = 100)
            )
          ) 
```


### Drug court-related bookings by high utilizers (Row sum)

High utilizers accounted for 85% of drug court-related bookings in Cheshire, Hillsborough, and Rockingham County jails.  

```{r}
# get proportion of HU bookings that were drug court related
data1 <- table(df_drug_courts$hu_group_exclusive, df_drug_courts$drug_court)
table1 <- prop.table(data1, 2) # row sum
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>% 
  rename(`Drug court-related booking` = 1,
         `Not a drug court-related booking` = 2,
         `Drug court-related booking.1` = 3,
         `Not a drug court-related booking.1` = 4) %>% 
  rownames_to_column("HU Type")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```
```{r}
# select variables and count number of drug court related bookings by HU type
data1 <- df_drug_courts %>%
  select(county,
         fy,
         id,
         booking_id,
         hu_group_exclusive,
         drug_court) %>%
  distinct() %>%
  filter(!is.na(drug_court)) %>%
  filter(drug_court == "Drug court-related booking") %>%
  group_by(drug_court, hu_group_exclusive) %>%
  summarise(total = n()) %>%
  mutate(pct = total/sum(total)*100) %>%
  mutate(pct = round(pct, 0))
data1 <- as.data.frame(data1)
data1 <- data1 %>% mutate(pct = paste0(pct, "%")) %>% 
  mutate(hu_group_exclusive = factor(hu_group_exclusive, levels = c("Non-HU", "Tier 3 HU","Tier 2 HU", "Tier 1 HU")))

# one stacked barplot for all three years and then make it a pie chart
ggplot(data1, aes(x = drug_court, y = total, fill = hu_group_exclusive )) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("gray", jri_orange, jri_green, jri_light_blue), labels = c("Non-HU", "Tier 3 HU","Tier 2 HU", "Tier 1 HU")) +
  geom_text(aes(label = pct, fontface = 'bold'), position = position_fill(vjust = 0.5),
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(data1$hu_group_exclusive == "Non-HU" ~ "black",
                  TRUE ~ "white")) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 18, color = "black"))

# ggsave(PRES_gg_pie_drug_court_bookings, file=paste0(sp_data_path, "/analysis/img/PRES_gg_pie_drug_court_bookings.png"), width = 6,  height = 6, dpi = 100, bg='transparent')
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_pie_drug_court_bookings.png"))
ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_pie_drug_court_bookings.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 100,
    width = 6,
    height = 6,
    units = "in",
    bg = "transparent"
  )
```

```{r}
data1 <- df_drug_courts %>% 
  group_by(drug_court, hu_group_exclusive) %>%  
  summarise(total_bookings = n_distinct(booking_id),
            total_people   = n_distinct(id))

# create reactable table
reactable(data1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            drug_court         = colDef(name = "Booking Type", minWidth = 275, style = list(fontWeight = "bold")),
            hu_group_exclusive = colDef(name = "HU Group", minWidth = 100),
            total_bookings     = colDef(name = "Bookings", minWidth = 100),
            total_people       = colDef(name = "People", minWidth = 100)
            )
          ) 
```


### Drug court-related bookings by high utilizers (Column sum)

This table shows column sum. For example, of all tier 1 hu bookings, 34% were drug court-related.  

```{r}
# get proportion of HUs with drug court related bookings
data1 <- table(df_drug_courts$hu_group_exclusive, df_drug_courts$drug_court)
table1 <- prop.table(data1, 1) # column sum
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>% 
  rename(`Drug court-related booking` = 1,
         `Not a drug court-related booking` = 2,
         `Drug court-related booking.1` = 3,
         `Not a drug court-related booking.1` = 4) %>% 
  rownames_to_column("HU Type")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

```{r}
# Create pie charts for proportion of bookings that are drug-court related by high utilizer (tier 1)
tier1hu <- table1 %>% filter(`HU Type` == "Tier 1 HU") %>% 
  select(`HU Type`,
         drug_court_related_booking = `Drug court-related booking.1`,
         not_drug_court_related_booking = `Not a drug court-related booking.1`)
tier1hu <- gather(tier1hu, type, pct, drug_court_related_booking:not_drug_court_related_booking, factor_key=TRUE)

ggplot(tier1hu, aes(x = "", y = pct, fill = type)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("#404040", "gray"),
                    labels = c("Drug-court related booking",
                               "Not a drug court-related booking")) +
  geom_text(aes(label = paste0(round(pct*100, 0), "%"),
                fontface = 'bold'),
                position = position_fill(vjust = 0.5),
                size = 7.5,
                family = "Franklin Gothic Book",
                color = ifelse(tier1hu$type == "drug_court_related_booking", "white", "gray")
            ) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 14, color = "black"))

# Create pie charts for proportion of bookings that are drug-court related by high utilizer (tier 2)
tier2hu <- table1 %>% filter(`HU Type` == "Tier 2 HU") %>% 
  select(`HU Type`,
         drug_court_related_booking = `Drug court-related booking.1`,
         not_drug_court_related_booking = `Not a drug court-related booking.1`)
tier2hu <- gather(tier2hu, type, pct, drug_court_related_booking:not_drug_court_related_booking, factor_key=TRUE)

ggplot(tier2hu, aes(x = "", y = pct, fill = type)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("#404040", "gray"),
                    labels = c("Drug-court related booking",
                               "Not a drug court-related booking")) +
  geom_text(aes(label = paste0(round(pct*100, 0), "%"),
                fontface = 'bold'),
                position = position_fill(vjust = 0.5),
                size = 7.5,
                family = "Franklin Gothic Book",
                color = ifelse(tier2hu$type == "drug_court_related_booking", "white", "gray")
            ) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 14, color = "black"))

# Create pie charts for proportion of bookings that are drug-court related by high utilizer (tier 3)
tier3hu <- table1 %>% filter(`HU Type` == "Tier 3 HU") %>% 
  select(`HU Type`,
         drug_court_related_booking = `Drug court-related booking.1`,
         not_drug_court_related_booking = `Not a drug court-related booking.1`)
tier3hu <- gather(tier3hu, type, pct, drug_court_related_booking:not_drug_court_related_booking, factor_key=TRUE)

ggplot(tier3hu, aes(x = "", y = pct, fill = type)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("#404040", "gray"),
                    labels = c("Drug-court related booking",
                               "Not a drug court-related booking")) +
  geom_text(aes(label = paste0(round(pct*100, 0), "%"),
                fontface = 'bold'),
                position = position_fill(vjust = 0.5),
                hjust = -.25,
                size = 7.5,
                family = "Franklin Gothic Book",
                color = ifelse(tier3hu$type == "drug_court_related_booking", "black", "gray")
            ) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 14, color = "black"))

# Create pie charts for proportion of bookings that are drug-court related by high utilizer (non-HU)
nonhu <- table1 %>% filter(`HU Type` == "Non-HU") %>% 
  select(`HU Type`,
         drug_court_related_booking = `Drug court-related booking.1`,
         not_drug_court_related_booking = `Not a drug court-related booking.1`)
nonhu <- gather(nonhu, type, pct, drug_court_related_booking:not_drug_court_related_booking, factor_key=TRUE)

ggplot(nonhu, aes(x = "", y = pct, fill = type)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("#404040", "gray"),
                    labels = c("Drug-court related booking",
                               "Not a drug court-related booking")) +
  geom_text(aes(label = paste0(round(pct*100, 0), "%"),
                fontface = 'bold'),
                position = position_fill(vjust = 0.5),
                hjust = -.25,
                size = 7.5,
                family = "Franklin Gothic Book",
                color = ifelse(nonhu$type == "drug_court_related_booking", "black", "gray")
            ) +
  coord_polar("y", start=0) +
  theme_no_grid_no_labels +
  theme(axis.ticks = element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 14, color = "black"))
```

Differences between North and South Hillsborough

```{r}
# Select Hillsborough drug court information
hillsborough_drug_courts <- df_drug_courts %>% 
  filter(!is.na(hillsborough_drug_court_location))

# get proportion of HU bookings that were drug court related
data1 <- table(hillsborough_drug_courts$hu_group_exclusive, hillsborough_drug_courts$hillsborough_drug_court_location)
table1 <- prop.table(data1, 1) # column sum
table1 <- as.data.frame(cbind(data1, table1))
table1 <- table1 %>% 
  rename(North     = 1,
         South     = 2,
         `North %` = 3,
         `South %` = 4) %>% 
  mutate(`North %` =  paste0(round(`North %`*100,0),"%"),
         `South %` =  paste0(round(`South %`*100,0),"%")) %>% 
  rownames_to_column("HU Type")

# create reactable table
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          fullWidth = FALSE
          ) 
```


```{r}
data1 <- hillsborough_drug_courts %>% 
  group_by(drug_court, hillsborough_drug_court_location, hu_group_exclusive) %>%  
  summarise(total_bookings = n_distinct(booking_id),
            total_people   = n_distinct(id))

# create reactable table
reactable(data1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            drug_court         = colDef(show = F),
            hillsborough_drug_court_location = colDef(name = "Hillsborough North or South", minWidth = 200),
            hu_group_exclusive = colDef(name = "HU Group", minWidth = 100),
            total_bookings     = colDef(name = "Bookings", minWidth = 100),
            total_people       = colDef(name = "People", minWidth = 100)
            )
          ) 
```

```{r}
data1 <- hillsborough_drug_courts %>% 
  group_by(crime_type_lookup, hillsborough_drug_court_location, hu_group_overall) %>%  
  summarise(total_bookings = n_distinct(booking_id),
            total_people   = n_distinct(id))

# create reactable table
reactable(data1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          fullWidth = FALSE,
          columns = list(
            crime_type_lookup = colDef(name = "Charge Type", minWidth = 200),
            hillsborough_drug_court_location = colDef(name = "Hillsborough North or South", minWidth = 150),
            hu_group_overall   = colDef(name = "HU Group", minWidth = 150),
            total_bookings     = colDef(name = "Bookings", minWidth = 150),
            total_people       = colDef(name = "People", minWidth = 150)
            )
          ) 
```

