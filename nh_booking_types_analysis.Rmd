---
title: "Booking Types Analysis"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    theme: theme.css
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

source("data_cleaning/00_library.R")
source("data_cleaning/01_functions.R")
source("data_cleaning/01_functions_visuals.R")
source("data_cleaning/rdas.R")
```

## Booking Types

The following booking patterns were found using jail administrative data submitted directly to CSG. DHHS matched data does not have information on booking types. The "other" category includes federal holds, holds for other agencies, 24 hour and 72 hour holds, other holds, dual satus, bail set, bond denied, dismissed, and sentence suspended.  

### Booking Types State-wide

```{r}
df_sentence_statuses <- bookings_entrances %>% select(sentence_status_standard, booking_id) %>% distinct() %>% 
  mutate(sentence_status_standard = ifelse(sentence_status_standard == "UNKNOWN", NA, sentence_status_standard)) 

df1 <- df_sentence_statuses %>% 
  group_by(sentence_status_standard) %>% 
  summarise(total = n()) %>% 
  filter(!is.na(sentence_status_standard)) %>% 
  mutate(sum = sum(total),
         yesno = "Yes") %>% 
  mutate(difference = sum-total)
temp <- df1 %>% 
    mutate(yesno = "No") %>% 
    select(-c(total, sum)) %>% 
    rename(total = difference)
df1 <- df1 %>% select(-c(sum, difference))
df1 <- rbind(df1, temp)

df1 <- group_by(df1, sentence_status_standard) %>% mutate(pct = total/sum(total)*100) %>%
  mutate(pct = round(pct, 0),
         sentence_status_standard = case_when(
           sentence_status_standard == "PRETRIAL" ~ "Pretrial",
           sentence_status_standard == "PROTECTIVE CUSTODY" ~ "Protective Custody",
           sentence_status_standard == "SENTENCED" ~ "Sentenced",
           sentence_status_standard == "OTHER" ~ "Other"))

df1 <- as.data.frame(df1)
df1 <- df1 %>% mutate(pct = paste0(pct, "%"))
df1$sentence_status_standard <- factor(df1$sentence_status_standard,levels = c("Other",
                                                                               "Sentenced",
                                                                               "Protective Custody",
                                                                               "Pretrial"))

# percent barchart of booking types
ggplot(df1, aes(x = sentence_status_standard, y = total, fill = yesno)) +
  geom_col(colour = NA, position = "fill") +
  scale_y_continuous(labels = scales::percent,
                     expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values=c("lightgray", jri_green)) +
  geom_text(aes(label = pct, fontface = 'bold'), position = position_fill(vjust = 0.5),
            size = 7.5, family = "Franklin Gothic Book",
            color = ifelse(df1$yesno == "No", "lightgray", "white")) +
  theme_no_axes +
  theme(legend.position = "none",
        legend.justification = c(0, 0),
        legend.title=element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  coord_flip() 
```

<br>

```{r}
df_sentence_statuses <- data.frame(summarytools::freq(df_sentence_statuses$sentence_status_standard, order = "freq", cum.percent = FALSE))
df_sentence_statuses <- df_sentence_statuses %>% tibble::rownames_to_column("sentence_status_standard") %>%
  dplyr::select(`Booking Type` = sentence_status_standard,
                `Unique Bookings (N)` = Freq,
                `Proportion of Bookings (%)` = X..Valid) 
df_sentence_statuses <- df_sentence_statuses %>% 
  mutate(`Proportion of Bookings (%)` = percent(`Proportion of Bookings (%)`/100))

kable(df_sentence_statuses, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(6, bold = TRUE)
```

<br>

### Booking Types by County (N)

```{r}
# Df of total number of entrances by county
df_entrances_county <- bookings_entrances %>%
  dplyr::ungroup() %>%
  dplyr::select(booking_id, county) %>%
  dplyr::distinct() %>%
  dplyr::group_by(county) %>%
  dplyr::summarise(total = n())

# Number of sentence types by county for all three years
df_sentence_statuses_county <- bookings_entrances %>%
  dplyr::ungroup() %>%
  dplyr::select(booking_id, county, sentence_status_standard) %>%
  dplyr::distinct() %>%
  dplyr::group_by(county, sentence_status_standard) %>%
  dplyr::summarise(total = n())

# Reshape table for viewing
df_sentence_statuses_county <- df_sentence_statuses_county %>% spread(sentence_status_standard, total) %>% clean_names() %>% 
  select(County                   = county,
         `Pretrial (N)`           = pretrial,
         `Protective Custody (N)` = protective_custody,
         `Sentenced (N)`          = sentenced,
         `Other (N)`              = other,
         `Unknown (N)`            = unknown) %>% 
  left_join(df_entrances_county, by = c("County" = "county")) %>% 
  rename(`Total Entrances (N)` = total)

df_sentence_statuses_county_pct <- df_sentence_statuses_county %>% 
  mutate(`Pretrial %`             = percent(`Pretrial (N)`/`Total Entrances (N)`),
         `Protective Custody (%)` = percent(`Protective Custody (N)`/`Total Entrances (N)`),
         `Sentenced (%)`          = percent(`Sentenced (N)`/`Total Entrances (N)`),
         `Other (%)`              = percent(`Other (N)`/`Total Entrances (N)`),
         `Unknown (%)`            = percent(`Unknown (N)`/`Total Entrances (N)`)
         ) %>% 
  select(-c(
         `Pretrial (N)`,
         `Protective Custody (N)`,
         `Sentenced (N)`,
         `Other (N)`,
         `Unknown (N)`,
         `Total Entrances (N)`
  ))
  
kable(df_sentence_statuses_county, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
   column_spec(1, bold = T, width = "12em") %>% 
   column_spec(2, width = "8em") %>% 
   column_spec(3, width = "8em") %>% 
   column_spec(4, width = "8em") %>% 
   column_spec(5, width = "8em") %>% 
   column_spec(6, width = "8em") %>% 
   column_spec(7, width = "8em")
```

<br>

### Booking Types by County (%)

```{r}
kable(df_sentence_statuses_county_pct, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
   column_spec(1, bold = T, width = "12em") %>% 
   column_spec(2, width = "8em") %>% 
   column_spec(3, width = "8em") %>% 
   column_spec(4, width = "8em") %>% 
   column_spec(5, width = "8em") %>% 
   column_spec(6, width = "8em") 
```

<br>

## Carroll County 

This is how we standardized booking types in Carroll County. It's possible that some of the booking types should be in "Pretrial" instead of "Other."

```{r}
df1 <- adm_all %>% 
  filter(county == "Carroll") %>% 
  group_by(sentence_status, sentence_status_standard) %>% 
  summarise(total = n()) %>% 
  arrange(sentence_status_standard) %>% 
  select(`Booking Type (Raw)` = sentence_status,
         `Booking Type (Standardized)` = sentence_status_standard,
         `Total Bookings (N)` = total)

kable(df1, 
      format.args = list(big.mark = ","), 
      align=rep('l')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
   column_spec(1, bold = T, width = "15em") %>% 
   column_spec(2, width = "15em") %>% 
   column_spec(3, width = "15em") 
```

<br>

## Booking Types and Charge Types

### Charge Type by Booking Type (Row Sums)

```{r}
df1 <- table(adm_all$crime_type_lookup, adm_all$sentence_status_standard)
table1 <- prop.table(df1, 1)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("Charge Type")

table1 <- table1 %>% 
       rename("Charge Type"            = 1,
              "Other (N)"              = 2,
              "Pretrial (N)"           = 3,
              "Protective Custody (N)" = 4,
              "Sentenced (N)"          = 5,
              "Unknown (N)"            = 6,
              "Other (%)"              = 7,
              "Pretrial (%)"           = 8,
              "Protective Custody (%)" = 9,
              "Sentenced (%)"          = 10,
              "Unknown (%)"            = 11) 
table_n   <- table1 %>% select(1:6)
table_pct <- table1 %>% select(1, 7:11)

reactable(table_n,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold"))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)

reactable(table_pct,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold")),
            `NH State Prisoner (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Other (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Pretrial (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Protective Custody (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Sentenced (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Unknown (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```
### Charge Type by Booking Type (Column Sums)

```{r}
df1 <- table(adm_all$crime_type_lookup, adm_all$sentence_status_standard)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("Charge Type")

table1 <- table1 %>% 
       rename("Charge Type"            = 1,
              "Other (N)"              = 2,
              "Pretrial (N)"           = 3,
              "Protective Custody (N)" = 4,
              "Sentenced (N)"          = 5,
              "Unknown (N)"            = 6,
              "Other (%)"              = 7,
              "Pretrial (%)"           = 8,
              "Protective Custody (%)" = 9,
              "Sentenced (%)"          = 10,
              "Unknown (%)"            = 11) 
table_n   <- table1 %>% select(1:6)
table_pct <- table1 %>% select(1, 7:11)

reactable(table_n,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold"))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)

reactable(table_pct,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("NH State Prisoner (N)", "Other (N)", "Pretrial (N)", "Protective Custody (N)", "Sentenced (N)", "Unknown (N)")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Charge Type` = colDef(minWidth = 200, style = list(fontWeight = "bold")),
            `NH State Prisoner (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Other (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Pretrial (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Protective Custody (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Sentenced (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1)),
            `Unknown (%)` = colDef(minWidth = 100, format = colFormat(percent = TRUE, digits = 1))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

```{r layout="l-body-outset",echo=FALSE,message=FALSE,warning=FALSE}
df1 <- gather(table_pct, booking_type, percent, `Other (%)`:`Unknown (%)`, factor_key=TRUE)
df1 <- df1 %>% filter(booking_type != "Unknown (%)" & booking_type != "Protective Custody (%)") %>% 
  mutate(percent_label = scales::percent(percent,
                                         accuracy = 1))

ggplot(data = df1, 
       aes(y = percent, 
           x = booking_type, 
           fill = forcats::fct_rev(`Charge Type`))) + 
  geom_bar(stat = "identity", 
           color = "gray80") +
  scale_x_discrete(limits = rev) +
  scale_y_continuous(labels = scales::percent,
                   expand = expansion(mult = c(0, .1))) +
  scale_fill_manual(values = c("#2F7084",
                               "#1F4A58",
                               "#E17619",
                               "#779F38",
                               "#87C2D4",
                               "#61C280",
                               "#DA70D6"
                               )) +
  guides(fill = guide_legend(reverse = TRUE,
                             title.position = "top",
                             label.position = "bottom",
                             keywidth = 3,
                             nrow = 1)) +
  geom_label(aes(y = percent, label = ifelse(percent > 0.05, percent_label, NA), fontface = "bold"), position = position_stack(vjust = .5), size = 5, colour = "white", show.legend = FALSE) +
  labs(x = NULL, y = NULL,
       fill = "Charge Type",
       caption = NULL,
       title = NULL,
       subtitle = NULL) +
  theme_minimal()+
  theme(legend.position = "top",
        legend.title.align=0.5,
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5),
        axis.text.y = element_markdown(face = "bold", hjust = 1, size = 12),
        axis.text.x = element_text(face = "bold", hjust = 1, size = 12),
        axis.ticks.length = unit(0, "cm"),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank()) +
  coord_flip() +
  theme(aspect.ratio=10/50)
```


<br>

## High Utilizers and Booking Types

### Top 1%

```{r}
df_hus_entrances <- adm_all %>% 
  select(id, 
         booking_id, 
         sentence_status_standard,
         county, 
         fy,
         num_entrances,
         high_utilizer_4_times,
         high_utilizer_1_pct,
         high_utilizer_5_pct,
         high_utilizer_10_pct) %>% 
  distinct() %>% 
  filter(sentence_status_standard != "UNKNOWN")

df1 <- table(df_hus_entrances$sentence_status_standard, df_hus_entrances$high_utilizer_1_pct)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("Entrance Type")
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Top 1% HU", columns = c("Yes", "Yes.1")),
            colGroup(name = "Not Top 1% HU", columns = c("No", "No.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Entrance Type` = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `No`    = colDef(name = "N", minWidth = 100),
            `Yes`   = colDef(name = "N", minWidth = 100),
            `No.1`  = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Yes.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

### Top 5%

```{r}
df1 <- table(df_hus_entrances$sentence_status_standard, df_hus_entrances$high_utilizer_5_pct)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("Entrance Type")
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Top 5% HU", columns = c("Yes", "Yes.1")),
            colGroup(name = "Not Top 5% HU", columns = c("No", "No.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Entrance Type` = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `No`    = colDef(name = "N", minWidth = 100),
            `Yes`   = colDef(name = "N", minWidth = 100),
            `No.1`  = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Yes.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

### Top 10%

```{r}
df1 <- table(df_hus_entrances$sentence_status_standard, df_hus_entrances$high_utilizer_10_pct)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("Entrance Type")
reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Top 10% HU", columns = c("Yes", "Yes.1")),
            colGroup(name = "Not Top 10% HU", columns = c("No", "No.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `Entrance Type` = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `No`    = colDef(name = "N", minWidth = 100),
            `Yes`   = colDef(name = "N", minWidth = 100),
            `No.1`  = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Yes.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

<br>

## Drug Courts

Only Cheshire, Hillsborough, and Rockingham County collect booking information related to [drug courts](https://www.courts.nh.gov/our-courts/drug-mental-health-courts).  

Specialty court programs for people involved in the criminal jusice system with substance abuse or mental health diagnoses are available in various Superior and Circuit Court District Division locations in New Hampshire. These treatment courts combine community based treatment programs with strict court supervision and progressive incentives and sanctions. By linking people to treatment services, the program aims to address offender's substance abuse and mental health diagnoses that led to criminal behavior, thereby reducing recidivism, and protecting public safety. These treatment court programs are designed to promote compliance with treatment programs as an alternative to jail time.

Felony drug court programs for adult offenders are available in Belknap, Carroll, Cheshire, Coos, Grafton, Hillsborough (North and South), Merrimack, Rockingham, and Strafford Counties. A defendant who enters those drug court programs must reside in the County where drug court is offered, in addition to having committed the crime in that county. 

```{r}
# Select variables and remove duplicates
df_drug_courts <- adm_all %>% 
  filter(pc_hold == "Non-PC Hold") %>% 
  select(id, 
         booking_id, 
         sentence_status_standard,
         county, 
         fy,
         num_entrances,
         high_utilizer_4_times,
         high_utilizer_1_pct,
         high_utilizer_5_pct,
         high_utilizer_10_pct,
         drug_court_pretrial,
         drug_court_sentenced,
         crime_type_lookup,
         descriptor_lookup) %>% 
  distinct()

# Select variables and counties to look at drug courts
df_drug_courts <- df_drug_courts %>% 
  filter(county == "Cheshire" |
         county == "Hillsborough" |
         county == "Rockingham") %>% 
  select(id, 
         booking_id, 
         sentence_status_standard,
         county, 
         fy,
         num_entrances,
         high_utilizer_4_times,
         high_utilizer_1_pct,
         high_utilizer_5_pct,
         high_utilizer_10_pct,
         drug_court_pretrial,
         drug_court_sentenced,
         crime_type_lookup,
         descriptor_lookup) %>%
  filter(!is.na(drug_court_pretrial) & !is.na(drug_court_sentenced)) %>% 
  distinct() %>% 
  mutate(drug_court = case_when(drug_court_pretrial == 1 | drug_court_sentenced == 1 ~ "Drug court-related booking", 
                                drug_court_pretrial == 0 | drug_court_sentenced == 0 ~ "Not a drug court-related booking"),
         high_utilizer_1_pct = case_when(high_utilizer_1_pct == "Yes" ~ "High Utilizer (Top 1%)",
                                         high_utilizer_1_pct == "No"  ~ "Not High Utilizer (Top 1%)"),
         high_utilizer_5_pct = case_when(high_utilizer_5_pct == "Yes" ~ "High Utilizer (Top 5%)",
                                         high_utilizer_5_pct == "No"  ~ "Not High Utilizer (Top 5%)"),
         high_utilizer_10_pct = case_when(high_utilizer_10_pct == "Yes" ~ "High Utilizer (Top 10%)",
                                         high_utilizer_10_pct == "No"  ~ "Not High Utilizer (Top 10%)"))
```

### Overview

#### Drug court-related bookings by county

```{r}
df1 <- table(df_drug_courts$county, df_drug_courts$drug_court)
table1 <- prop.table(df1, 1)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("County")

reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```



### High Utilizers

#### Drug court-related bookings for top 1% high utilizers

```{r}
df1 <- table(df_drug_courts$high_utilizer_1_pct, df_drug_courts$drug_court)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("HU Type")

reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

#### Drug court-related bookings for top 5% high utilizers

```{r}
df1 <- table(df_drug_courts$high_utilizer_5_pct, df_drug_courts$drug_court)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("HU Type")

reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

#### Drug court-related bookings for top 10% high utilizers

```{r}
df1 <- table(df_drug_courts$high_utilizer_10_pct, df_drug_courts$drug_court)
table1 <- prop.table(df1, 2)
table1 <- as.data.frame(cbind(df1, table1))
table1 <- table1 %>% rownames_to_column("HU Type")

reactable(table1,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          pagination = FALSE,
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center"),
                                 headerStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(
            format = colFormat(separators = TRUE), align = "left", minWidth = 100,
            footer = function(values, name) {
              if (name %in% c("Drug court-related booking", "Not a drug court-related booking")) {
                htmltools::div(paste0("", formatC(
                  x = sum(values),
                  digits = 0,
                  big.mark = ",",
                  format = "f"
                )))
              }
            },
            footerStyle = list(fontWeight = "bold")
          ),
          columnGroups = list(
            colGroup(name = "Drug court-related booking", columns = c("Drug court-related booking", "Drug court-related booking.1")),
            colGroup(name = "Not a drug court-related booking", columns = c("Not a drug court-related booking", "Not a drug court-related booking.1"))
          ),
          compact = TRUE,
          fullWidth = FALSE,
          columns = list(
            `HU Type`                            = colDef(name = "", minWidth = 200, style = list(fontWeight = "bold")),
            `Drug court-related booking`         = colDef(name = "N", minWidth = 100),
            `Not a drug court-related booking`   = colDef(name = "N", minWidth = 100),
            `Drug court-related booking.1`       = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0)),
            `Not a drug court-related booking.1` = colDef(name = "%", minWidth = 100, format = colFormat(percent = TRUE, digits = 0))
            )
          ) %>%
add_source(paste(""), font_style = "italic", font_size = 14)
```

