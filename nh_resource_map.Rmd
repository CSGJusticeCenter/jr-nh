---
title: "Mapping NH Resource Availability"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
---

Here is where we gathered location-level resource information: 

*	Community mental health programs (CMHC): https://www.dhhs.nh.gov/sites/g/files/ehbemt476/files/documents/2021-12/bdas-list-map.pdf
 
I then compiled individual resource locations from each listed organizations’ website


*	Recovery Community Organizations (State-funded RCOs): https://www.dhhs.nh.gov/programs-services/health-care/recovery-support-services

* SUD Treatment: https://findtreatment.gov/locator

I filtered on “Substance Use” and “Opioid Treatment Programs” for NH


*	DHHS/Bureau of Homeless and Housing Services (BHHS) Cold Weather/Emergency Shelters: https://www.dhhs.nh.gov/programs-services/housing-services/homeless-assistance-prevention-services/shelter-services

* Non-DHHS Funded Shelters/Housing: https://www.dhhs.nh.gov/sites/g/files/ehbemt476/files/documents2/non-dhhs-contracted-emergency-shelters.pdf

* NH Coalition of Recovery Residences: https://www.dhhs.nh.gov/sites/g/files/ehbemt476/files/documents2/nhvregistry.pdf **and** https://www.nhcorr.org/certified-homes

NOTE: NHCORR Certified Recovery Residences are often gender-specific 

```{r include=FALSE,message=FALSE,warning=FALSE}
### call libraries
### NOTE: for now, I'm just calling packages separately b/c there are a few that I need specifically for mapping and don't want to update the library R file just for this purpose
library(easypackages)
libraries("tidyverse","foreign","lubridate","reshape2", "ggplot2","RColorBrewer","knitr","forcats","openxlsx","statar","svDialogs","xlsx", "magrittr","stringr", "data.table","janitor","kableExtra","leaflet", "readr", "rmarkdown","rowr", "gganimate", "gifski","tidycensus","sf","htmltools","acs","tigris","mapview","rgeos", "ggrepel", "censusxy","gdata","lavaan","mclust","tmap","scales", "raster","rgeos","gmapsdistance","viridis","cowplot","lintr","leaflet.extras","censusapi","data.table","gridGraphics","readxl","haven","ggridges","extrafont","extrafontdb","datamodelr","Lahman","DiagrammeR","fs","readxl","rsvg","V8","ragg","ggtext","csgjcr","distill","highcharter","censusr")

# Load functions, packages, and data
source("code/00_library.R")
source("code/01_functions.R")
source("code/rdas.R")
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### set chunk output specifications
knitr::opts_chunk$set(
  echo = TRUE,
  dev = "ragg_png",
  cache = FALSE)

### set theme
theme_set(theme_minimal())
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### set constants for mapping
default_font_color <- "#4e4d47"
default_font_family <- "Franklin Gothic Book"
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### pull in resource data
nh_resource_locations_raw <- readxl::read_xlsx(file.path(sp_data_path,"Data","nh_resource_map_data.xlsx")) %>% 
  clean_names() %>% 
  mutate(unique_resource_id = paste0(resource_name,row_number())) 


# ### pull idoc supervision level data (# of unique clients who were on supervision level 4 or 5 at some point in 2020 per 10,000 county residents/population)
# 
# ### write out supervision_level_4_5_county_for_map_supervision_race
# supervision_level_4_5_county_for_map_supervision_race <- read_rds(file.path(sharepoint_idoc_resources, "supervision_level_4_5_county_for_map_supervision_race.rds")) %>% 
#   mutate(fips_code = as.character(fips_code))
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### commenting out syntax below because we've already run it and simply need to pull in geocoded data to make knitting more efficient

# ### geocode addresses in nh_resource_locations_raw 
# 
# ### clean address and prepare for geocoding format
# nh_resource_locations_raw_addresses <- nh_resource_locations_raw %>%
#   mutate(street =  gsub("Apt .*","",address)) %>%
#   mutate(street =  gsub("apt .*","",street)) %>%
#   mutate(street =  gsub("Fl .*","",street)) %>%
#   mutate(street =  gsub("Unit .*","",street)) %>%
#   mutate(street =  gsub("\\.","",street)) %>%
#   mutate(zip = as.character(zip),
#          state = "New Hampshire") %>%
#   dplyr::select(unique_resource_id, street, city, state, zip)
# 
# ### obtain lat/lon from address via censusxy::cxy_geocode()
# nh_resource_location_geo <- censusxy::cxy_geocode(nh_resource_locations_raw_addresses, 
#                                                   street = "street", 
#                                                   city = "city", 
#                                                   state = "state", 
#                                                   zip = "zip", 
#                                                   return = "geographies", 
#                                                   benchmark = "Public_AR_Census2020", 
#                                                   vintage = "Census2020_Census2020", 
#                                                   output = "full") %>% 
#   dplyr::select(-c(cxy_address:cxy_tiger_side,cxy_tract_id,cxy_block_id))
# 
# ### seems like we have a pretty good match rate -- but might as well hard code the missing fields
# ### export and then hard code lat/lon for records with missing data using google maps
# 
# ### write out iowa_idoc_resource_facility_geo
# openxlsx::write.xlsx(nh_resource_location_geo,
#           file.path(sp_data_path,"Data",
#                     "nh_resource_location_geo_fix.xlsx"))

## pull file back in now that i've manually geocoded the missing records
nh_resource_location_prelim_geo_clean <- openxlsx::read.xlsx(file.path(sp_data_path,"Data",
                    "nh_resource_location_geo_fix_with_county.xlsx")) %>%
  dplyr::select(unique_resource_id,lon=cxy_lon,lat=cxy_lat,street,cxy_county_id) %>% 
  right_join(nh_resource_locations_raw, by = "unique_resource_id") %>%
  dplyr::select(-c(address,unique_resource_id)) %>% 
  ### add county name to geocoded fips county number obtained
  ### see codes here: https://tigerweb.geo.census.gov/tigerwebmain/Files/bas22/tigerweb_bas22_county_nh.html
  mutate(county = case_when(
    cxy_county_id == 1 ~ "Belknap",
    cxy_county_id == 3 ~ "Carroll",
    cxy_county_id == 5 ~ "Cheshire",
    cxy_county_id == 7 ~ "Coos",
    cxy_county_id == 9 ~ "Grafton", 
    cxy_county_id == 11 ~ "Hillsborough", 
    cxy_county_id == 13 ~ "Merrimack", 
    cxy_county_id == 15 ~ "Rockingham", 
    cxy_county_id == 17 ~ "Strafford", 
    cxy_county_id == 19 ~ "Sullivan", 
    TRUE ~ as.character(NA))) %>% 
  dplyr::select(resource_type,resource_name,organization,county,lat,lon)

## now import sud treatment file (already has lat/lon and county) and append to nh_resource_location_geo_full
nh_sud_treatment_resources <- openxlsx::read.xlsx(file.path(sp_data_path,"Data",
                    "nh_sud_treatment_resources.xlsx")) %>% 
  dplyr::select(resource_type,resource_name,organization,county,lat,lon)

## append both files to create final resource file with lat, lon, and county
nh_resource_location_geo_full <- rbind(nh_resource_location_prelim_geo_clean,
                                               nh_sud_treatment_resources) %>% 
  ### create unique id for counts
  mutate(unique_resource_id = paste0(resource_name,row_number()))

### create county-level file with counts of resources by type
nh_resource_location_county_level <- nh_resource_location_geo_full %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(overall_resource_count = n_distinct(unique_resource_id),
            cmhc_resource_count = n_distinct(unique_resource_id[resource_type=="CMHC"]),
            rco_resource_count = n_distinct(unique_resource_id[resource_type=="RCO"]),
            bhhs_shelter_resource_count = n_distinct(unique_resource_id[resource_type=="Cold Weather/Emergency Shelter (DHHS-funded)"]),
            non_bhhs_shelter_resource_count = n_distinct(unique_resource_id[resource_type=="Non-DHHS Funded Shelters/Housing"]),
            nhcorr_recovery_resource_count = n_distinct(unique_resource_id[resource_type=="NHCORR Certified Recovery Residences"]),
            sud_treatment_resource_count = n_distinct(unique_resource_id[resource_type=="SUD Treatment"])) %>% 
  ungroup()

```

```{r include=FALSE,message=FALSE,warning=FALSE}
### pull census/acs data via tidycensus package

### read in census/acs api key from environmnent
### this allows us to pull census/acs data via the tidycensus package
readRenviron("~/.Renviron")

### pull list of acs vars that are availabe to pull
acs_2021_vars <- tidycensus::load_variables(2021, "acs5", cache = TRUE)

### adult (18+) population by county from 2021 acs
nh_county_adult_pop_2021 <- tidycensus::get_acs(geography = "County", 
                                           state = "NH",
                                           variables = "S0101_C01_026",
                                           year = 2021,
                                            geometry = FALSE) %>% 
  clean_names() %>%
  dplyr::select(geoid,name,county_total_pop = estimate) 

### weighted estimate of percentage of county residents living below federal poverty threshold
nh_poverty_status <- tidycensus::get_acs(geography = "County", 
                                              state = "NH",
                                              variables = "S1701_C03_001", 
                                              geometry = FALSE) %>% 
  clean_names() %>% 
  dplyr::select(geoid,estimate) %>% 
  dplyr::rename(estimate_below_poverty = estimate)

### weighted estimate of income
nh_median_income <- tidycensus::get_acs(geography = "County", 
                                             state = "NH",
                                             variables = "S1901_C01_012", 
                                             geometry = FALSE) %>% 
  clean_names() %>% 
  dplyr::select(geoid,estimate) %>% 
  dplyr::rename(estimate_income = estimate)

### counts of race from 2020 census
### these are the ids of race variables that we want to pull 
race_vars = c(
        all = "P2_001N",
        hispanic = "P2_002N",
        white = "P2_005N",
        black = "P2_006N",
        am_indian = "P2_007N",
        asian = "P2_008N"
        )

nh_race_2020 <- tidycensus::get_decennial(geography = "County", 
                                               state = "NH",
                                               variables = race_vars, ### use race vars that i've specified
                                               summary_var = "P2_001N", ### summary column for % calculation
                                               year = 2020,
                                               geometry = FALSE) %>% 
  clean_names() %>% 
  ### create percent estimate from estimated counts
  mutate(percent = (value/summary_value)*100) %>% 
  ### pivot race file to be wide and unique by census tract 
  dplyr::select(geoid,variable,percent) %>% 
  spread(variable,percent, fill = NA) 
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### join all acs variables together in one file
nh_acs_census_county <- left_join(nh_poverty_status, nh_median_income, by="geoid")

nh_acs_census_county <- left_join(nh_acs_census_county, nh_county_adult_pop_2021, by="geoid")

nh_acs_census_county <- left_join(nh_acs_census_county, nh_race_2020, by="geoid") %>% 
  mutate(county = stringr::word(name, 1))

```

```{r include=FALSE,message=FALSE,warning=FALSE}
nh_resource_location_geo_full_acs_census <- left_join(nh_resource_location_county_level, 
                                                      nh_acs_census_county,
                                                      by = "county") %>% 
  group_by(county) %>% 
  ### create resource rate -- resources per 10,000 county residents 
  mutate(overall_resources_rate = overall_resource_count/county_total_pop*100000,
         cmhc_resource_rate = cmhc_resource_count/county_total_pop*100000,
         rco_resource_rate = rco_resource_count/county_total_pop*100000,
         bhhs_shelter_resource_rate = bhhs_shelter_resource_count/county_total_pop*100000,
         non_bhhs_shelter_resource_rate = non_bhhs_shelter_resource_count/county_total_pop*100000,
         nhcorr_recovery_resource_rate = nhcorr_recovery_resource_count/county_total_pop*100000,
         sud_treatment_resource_rate = sud_treatment_resource_count/county_total_pop*100000) %>% 
  ungroup()

```

```{r include=FALSE,message=FALSE,warning=FALSE}
### read in county-level nh data to create county,state, geoid crosswalk with acs/census data 
### this is the official nh county shapefile, obtained here: https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html 
### this is not used for mapping, however, hence we remove geography below; it's just a crosswalk across county name, geoid, and county fip code

### read in nh county-level shape file    
nh_county_shape <- read_sf("C:\\Users\\abyrum\\OneDrive - The Council of State Governments\\Geospatial_Mapping\\US County Geo Data\\tl_2019_us_county\\tl_2019_us_county.shp") %>%
  clean_names() %>% 
  filter(statefp=="33") %>% ### filter by state fip code 
  dplyr::rename(county=name, 
                county_fip=countyfp)

### use group_by and st_union to create statewide polygon using the county-level geography
### we'll use this shapefile for a state border when mapping
nh_state_shape <- nh_county_shape %>%
  group_by(statefp) %>% 
  summarize(geometry = st_union(geometry)) %>% 
  ungroup()

```

```{r include=FALSE,message=FALSE,warning=FALSE}
### import jail_medicaid_analytic_individual_booking_level -- the individual-level analytic file created with all DHHS files
### file is unique by individual/booking
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
jail_medicaid_analytic_individual_booking_level <- read_rds("D:/Analytic/jail_medicaid_analytic_individual_booking_level.rds") 

### de-dup (there are a few duplicate bookings) and create booking id for analysis
jail_medicaid_analytic_individual_booking_level_dedup <- jail_medicaid_analytic_individual_booking_level %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
jail_medicaid_analytic_individual_booking_level_dedup_hu_recode <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  ### to ensure each individual/booking is in correct grouping, start with Non-HU, then 10% and move down to 1%
  mutate(hu_group_exclusive = case_when(
    high_utilizer_10_pct=="No" ~ 4,
    high_utilizer_10_pct=="Yes" & high_utilizer_5_pct=="No" & high_utilizer_1_pct=="No" ~ 3,
    high_utilizer_5_pct=="Yes" & high_utilizer_1_pct=="No" ~ 2,
    high_utilizer_1_pct=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_exclusive = factor(hu_group_exclusive,
         levels = c(1,2,3,4),
         labels = c("Top 1%", "Top 5%", "Top 10%", "Non-HU")))

### group by county and create the following measures
# % of bookings w/ BH match
# % of bookings w/ co-occurring disorders
# % of bookings w/ homelessness history
# % of bookings w/ ED BH visits 
# % of bookings w/ ED CMHC visits 

jail_medicaid_analytic_county_level_to_map <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Overall Bookings (N)` = n_distinct(unique_person_booking_id),
                   `Bookings w/ any Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any Medicaid Match (%)` = `Bookings w/ any Medicaid Match (N)`/`Overall Bookings (N)`,
                   `Bookings w/ BH Encounter (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_flag==1]),
                   `Bookings w/ BH Encounter (%)` = `Bookings w/ BH Encounter (N)`/`Bookings w/ any Medicaid Match (N)`,
                   `Bookings w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_booking_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Bookings w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = `Bookings w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/`Bookings w/ any Medicaid Match (N)`,
                   `Bookings w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_booking_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Bookings w/ BH Service provided by CMHC (%)` = `Bookings w/ BH Service provided by CMHC (N)`/`Bookings w/ any Medicaid Match (N)`,
                   `Bookings w/ BH Service provided by ED (N)` = n_distinct(unique_person_booking_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Bookings w/ BH Service provided by ED (%)` = `Bookings w/ BH Service provided by ED (N)`/`Bookings w/ any Medicaid Match (N)`,
                    `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   
                   `Bookings w/ any experience of homelessness (%)` = `Bookings w/ any experience of homelessness (N)`/`Bookings w/ any Medicaid Match (N)`) %>% 
  ungroup() %>% 
  dplyr::select(county,`Bookings w/ any Medicaid Match (%)`,`Bookings w/ BH Encounter (%)`,`Bookings w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)`,`Bookings w/ BH Service provided by CMHC (%)`,`Bookings w/ BH Service provided by ED (%)`,`Bookings w/ any experience of homelessness (%)`)

### join in other county information
nh_resource_location_acs_census_medicaid <- left_join(nh_resource_location_geo_full_acs_census,
                                                      jail_medicaid_analytic_county_level_to_map,
                                                      by = "county")


```

```{r include=FALSE,message=FALSE,warning=FALSE}
source("data_cleaning/rdas.R")

# Proportion of PC holds by county
county_level_pc_holds <- df_pch %>%
  group_by(county, pc_hold_in_booking) %>% summarise(total = n()) %>% 
  group_by(county) %>% 
  mutate(pc_hold_percent = total/sum(total)) %>% 
  ungroup() %>% 
  filter(pc_hold_in_booking=="PC Hold") %>% 
  dplyr::select(county,pc_hold_percent)

### now join in other county information again
nh_resource_location_acs_census_medicaid_pc_holds <- left_join(nh_resource_location_acs_census_medicaid,
                                                      county_level_pc_holds,
                                                      by = "county")

```


```{r include=FALSE,message=FALSE,warning=FALSE}
### merge county shapefile to acs, census, and iowa data to attach geography and render the file map-able
### this will be the file we use to map
nh_acs_census_county_geo <- merge(nh_county_shape, 
                                    nh_resource_location_acs_census_medicaid_pc_holds,
                                    by = "county") 
```

```{r include=FALSE,message=FALSE,warning=FALSE}
### create static map theme (based on https://timogrossenbacher.ch/2019/04/bivariate-maps-with-ggplot2-and-sf/)
theme_map <- function(...) {
  theme_minimal() +
  theme(
    text = element_text(family = default_font_family,
                        color = default_font_color),
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    # add a subtle grid
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # borders and margins
    plot.margin = unit(c(.5, .5, .2, .5), "cm"),
    panel.border = element_blank(),
    panel.spacing = unit(c(-.1, 0.2, .2, 0.2), "cm"),
    # titles
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 9, hjust = 0,
                               color = default_font_color),
    plot.title = element_text(size = 15, hjust = 0.5,
                              color = default_font_color),
    # plot.subtitle = element_text(size = 10, hjust = 0.5,
    #                              color = default_font_color,
    #                              margin = margin(b = -0.1,
    #                                              t = -0.1,
    #                                              l = 2,
    #                                              unit = "cm"),
    #                              debug = F),
    # # captions
    # plot.caption = element_text(size = 7,
    #                             hjust = .5,
    #                             margin = margin(t = 0.2,
    #                                             b = 0,
    #                                             unit = "cm"),
    #                             color = default_font_color),
    ...
  )
}
```

<br>

### Map of all BH and Housing Resources by County (locations per 100k residents)

There isn't a lot of variation here, interestingly. Though we should keep in mind our data collection may not be 100% complete. 

```{r layout="l-page",echo=FALSE,message=FALSE,warning=FALSE}
### create quantiles object
no_classes <- 4

### extract quantiles from var we're mapping
quantiles <- nh_acs_census_county_geo %>%
  pull(overall_resources_rate) %>%
  quantile(probs = seq(0, 1, length.out = no_classes + 1), na.rm=TRUE) %>%
  as.vector() 

### make labels for map's legend
label_resource_rate <- c("16 per 100k and Greater","14 to 16 per 100k","12 to 14 per 100k","12 per 100k and Lower")

### create a new variable with the specified quantiles
nh_acs_census_county_geo_to_map <- nh_acs_census_county_geo %>%
  mutate(resource_rate_quartile = cut(-overall_resources_rate,
                               breaks = -quantiles,
                               right = TRUE,
                               labels = label_resource_rate,
                               include.lowest = T)) 


### map via ggplot 
ggplot(
  # define main data source
  data = nh_acs_census_county_geo_to_map
) +
  scale_alpha(name = "",
              range = c(0.6, 0),
              guide = F) + # suppress legend
  # add main fill aesthetic
  # use thin white stroke for municipality borders
  # geom_sf(
  #   mapping = aes(
  #     fill = resource_rate_quartile
  #     ),
  #   color = "white",
  #   size = 0.1
  # ) +
  geom_sf(
    mapping = aes(
      fill = overall_resources_rate
      ),
    color = "white",
    size = 0.3
  ) +
    scale_fill_distiller(
    labels = scales::number_format(accuracy=1),
    direction = 1,
    name = "Overall Behavioral Health and Housing\nResources per 100k Adults"
  ) +
  ### use jr palette here
    scale_colour_gradientn(colours = c("#D7EBF1","#AFD6E2","#87C2D4","#2F7084","#1F4A58")) +
 # scale_fill_manual(
 #    values = c("#1F4A58","#2F7084","#87C2D4","#AFD6E2"),
 #    name = "Overall Behavioral Health and Housing\nResources per 100k Residents",
 #    na.value = "grey50",
 #    guide = guide_legend(
 #     keyheight = unit(7.5, units = "mm"),
 #     title.position = "top",
 #     reverse = F # display highest on top
 #  )) +
  # use white stroke borders for county boundaries
  geom_sf(
    data = nh_acs_census_county_geo,
    fill = "transparent",
    color = "white",
    size = 1
  )  +
  # use additional state-level shapefile for state border
  geom_sf(
    data = nh_state_shape,
    fill = "transparent",
    color = "grey40",
    size = .05
  )  +
 geom_label(
     data = nh_acs_census_county_geo_to_map, 
     aes(geometry = geometry, 
         label = paste0(county,"\n",round(overall_resources_rate,digits=0)," per 100k")),
    vjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ 1.15,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Merrimack"] ~ .75,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .6,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Rockingham"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Cheshire"] ~ .25,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Belknap"] ~ .15,
                      TRUE ~ 0),
    hjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .4,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Grafton"] ~ .61,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ .4,
                      TRUE ~ .5),
    family = "Franklin Gothic Demi",
    color = "gray25",
    size = 2.8,
    fontface = "bold",
    stat = "sf_coordinates") +
  guides(fill = guide_colorbar(barwidth = 8),
           direction = "horizontal",
      barheight = unit(2, units = "mm"),
      barwidth = unit(50, units = "mm"),
      draw.ulim = F,
      title.position = 'top',
      # some shifting around
      title.hjust = 0.5,
      label.hjust = 0.5) +
  labs(
    title = NULL,
    subtitle = NULL,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  # add theme
  theme_map() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.5, 0.5),
    legend.text = element_text(size = 11),
    legend.margin=margin(-10,0,0,0),
    legend.box.margin=margin(-10,0,0,0)
  ) 


### write out
ggsave(
    filename = file.path(sp_viz_output_path, "nh_resource_availability_map_overall_continuous.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    height = 5.25,
    width = 10,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

### Map of all Community Mental Health Center (CMHC) Resources by County (locations per 100k residents)

```{r layout="l-page",echo=FALSE,message=FALSE,warning=FALSE}
# ### create quantiles object
# no_classes <- 4
# 
# ### extract quantiles from var we're mapping
# quantiles <- nh_acs_census_county_geo %>%
#   pull(cmhc_resource_rate) %>%
#   quantile(probs = seq(0, 1, length.out = no_classes + 1), na.rm=TRUE) %>%
#   as.vector() 
# 
# ### make labels for map's legend
# label_resource_rate <- c("5 per 100k and Greater","4 to 5 per 100k","2 to 4 per 100k","2 per 100k and Lower")
# 
# ### create a new variable with the specified quantiles
# nh_acs_census_county_geo_to_map <- nh_acs_census_county_geo %>%
#   mutate(resource_rate_quartile = cut(-cmhc_resource_rate,
#                                breaks = -quantiles,
#                                right = TRUE,
#                                labels = label_resource_rate,
#                                include.lowest = T)) 


### map via ggplot 
ggplot(
  # define main data source
  data = nh_acs_census_county_geo
) +
  scale_alpha(name = "",
              range = c(0.6, 0),
              guide = F) + # suppress legend
  # add main fill aesthetic
  # use thin white stroke for municipality borders
  geom_sf(
    mapping = aes(
      fill = cmhc_resource_rate
      ),
    color = "white",
    size = 0.3
  ) +
    scale_fill_distiller(
    labels = scales::number_format(accuracy=1),
    direction = 1,
    name = "CMHC Resources\nper 100k Adults"
  ) +
  ### use jr palette here
    scale_colour_gradientn(colours = c("#D7EBF1","#AFD6E2","#87C2D4","#2F7084","#1F4A58")) +
 # scale_fill_manual(
 #    values = c("#1F4A58","#2F7084","#87C2D4","#AFD6E2"),
 #    name = "CMHC Resources\nper 100k Residents",
 #    na.value = "grey50",
 #    guide = guide_legend(
 #     keyheight = unit(7.5, units = "mm"),
 #     title.position = "top",
 #     reverse = F # display highest on top
 #  )) +
  # use white stroke borders for county boundaries
  geom_sf(
    data = nh_acs_census_county_geo,
    fill = "transparent",
    color = "white",
    size = 1
  )  +
  # use additional state-level shapefile for state border
  geom_sf(
    data = nh_state_shape,
    fill = "transparent",
    color = "grey40",
    size = .05
  )  +
 geom_label(
     data = nh_acs_census_county_geo_to_map, 
     aes(geometry = geometry, 
         label = paste0(county,"\n",round(cmhc_resource_rate,digits=0)," per 100k")),
    vjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ 1.15,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Merrimack"] ~ .75,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .6,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Rockingham"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Cheshire"] ~ .25,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Belknap"] ~ .15,
                      TRUE ~ 0),
    hjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .4,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Grafton"] ~ .61,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ .4,
                      TRUE ~ .5),
    family = "Franklin Gothic Demi",
    color = "gray25",
    size = 2.8,
    fontface = "bold",
    stat = "sf_coordinates") +
  guides(fill = guide_colorbar(barwidth = 8),
           direction = "horizontal",
      barheight = unit(2, units = "mm"),
      barwidth = unit(50, units = "mm"),
      draw.ulim = F,
      title.position = 'top',
      # some shifting around
      title.hjust = 0.5,
      label.hjust = 0.5) +
  labs(
    title = NULL,
    subtitle = NULL,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  # add theme
  theme_map() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.5, 0.5),
    legend.text = element_text(size = 11),
    legend.margin=margin(-10,0,0,0),
    legend.box.margin=margin(-10,0,0,0)
  ) 


### write out
ggsave(
    filename = file.path(sp_viz_output_path, "nh_resource_availability_map_cmhc.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    height = 5.25,
    width = 10,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

### Map of all Substance Use Disorder (SUD) Resources by County (locations per 100k residents)

```{r layout="l-page",echo=FALSE,message=FALSE,warning=FALSE}
# ### create quantiles object
# no_classes <- 4
# 
# ### extract quantiles from var we're mapping
# quantiles <- nh_acs_census_county_geo %>%
#   pull(sud_treatment_resource_rate) %>%
#   quantile(probs = seq(0, 1, length.out = no_classes + 1), na.rm=TRUE) %>%
#   as.vector() 
# 
# ### make labels for map's legend
# label_resource_rate <- c("5 per 100k and Greater","4 to 5 per 100k","2 to 4 per 100k","2 per 100k and Lower")
# 
# ### create a new variable with the specified quantiles
# nh_acs_census_county_geo_to_map <- nh_acs_census_county_geo %>%
#   mutate(resource_rate_quartile = cut(-cmhc_resource_rate,
#                                breaks = -quantiles,
#                                right = TRUE,
#                                labels = label_resource_rate,
#                                include.lowest = T)) 


### map via ggplot 
ggplot(
  # define main data source
  data = nh_acs_census_county_geo
) +
  scale_alpha(name = "",
              range = c(0.6, 0),
              guide = F) + # suppress legend
  # add main fill aesthetic
  # use thin white stroke for municipality borders
  geom_sf(
    mapping = aes(
      fill = sud_treatment_resource_rate
      ),
    color = "white",
    size = 0.3
  ) +
    scale_fill_distiller(
    labels = scales::number_format(accuracy=1),
    direction = 1,
    name = "SUD Resources\nper 100k Adults"
  ) +
  ### use jr palette here
    scale_colour_gradientn(colours = c("#D7EBF1","#AFD6E2","#87C2D4","#2F7084","#1F4A58")) +
 # scale_fill_manual(
 #    values = c("#1F4A58","#2F7084","#87C2D4","#AFD6E2"),
 #    name = "CMHC Resources\nper 100k Residents",
 #    na.value = "grey50",
 #    guide = guide_legend(
 #     keyheight = unit(7.5, units = "mm"),
 #     title.position = "top",
 #     reverse = F # display highest on top
 #  )) +
  # use white stroke borders for county boundaries
  geom_sf(
    data = nh_acs_census_county_geo,
    fill = "transparent",
    color = "white",
    size = 1
  )  +
  # use additional state-level shapefile for state border
  geom_sf(
    data = nh_state_shape,
    fill = "transparent",
    color = "grey40",
    size = .05
  )  +
 geom_label(
     data = nh_acs_census_county_geo_to_map, 
     aes(geometry = geometry, 
         label = paste0(county,"\n",round(sud_treatment_resource_rate,digits=0)," per 100k")),
    vjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ 1.15,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Merrimack"] ~ .75,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .6,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Rockingham"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Cheshire"] ~ .25,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Belknap"] ~ .15,
                      TRUE ~ 0),
    hjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .4,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Grafton"] ~ .61,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ .4,
                      TRUE ~ .5),
    family = "Franklin Gothic Demi",
    color = "gray25",
    size = 2.8,
    fontface = "bold",
    stat = "sf_coordinates") +
  guides(fill = guide_colorbar(barwidth = 8),
           direction = "horizontal",
      barheight = unit(2, units = "mm"),
      barwidth = unit(50, units = "mm"),
      draw.ulim = F,
      title.position = 'top',
      # some shifting around
      title.hjust = 0.5,
      label.hjust = 0.5) +
  labs(
    title = NULL,
    subtitle = NULL,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  # add theme
  theme_map() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.5, 0.5),
    legend.text = element_text(size = 11),
    legend.margin=margin(-10,0,0,0),
    legend.box.margin=margin(-10,0,0,0)
  ) 

### write out
ggsave(
    filename = file.path(sp_viz_output_path, "nh_resource_availability_map_sud.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    height = 5.25,
    width = 10,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

### Map of all Recovery Community Organizations (RCO) Resources by County (locations per 100k residents)

```{r layout="l-page",echo=FALSE,message=FALSE,warning=FALSE}
### map via ggplot 
ggplot(
  # define main data source
  data = nh_acs_census_county_geo
) +
  scale_alpha(name = "",
              range = c(0.6, 0),
              guide = F) + # suppress legend
  # add main fill aesthetic
  # use thin white stroke for municipality borders
  geom_sf(
    mapping = aes(
      fill = rco_resource_rate
      ),
    color = "white",
    size = 0.3
  ) +
    scale_fill_distiller(
    labels = scales::number_format(accuracy=1),
    direction = 1,
    name = "RCO Resources\nper 100k Adults"
  ) +
  ### use jr palette here
    scale_colour_gradientn(colours = c("#D7EBF1","#AFD6E2","#87C2D4","#2F7084","#1F4A58")) +
 # scale_fill_manual(
 #    values = c("#1F4A58","#2F7084","#87C2D4","#AFD6E2"),
 #    name = "CMHC Resources\nper 100k Residents",
 #    na.value = "grey50",
 #    guide = guide_legend(
 #     keyheight = unit(7.5, units = "mm"),
 #     title.position = "top",
 #     reverse = F # display highest on top
 #  )) +
  # use white stroke borders for county boundaries
  geom_sf(
    data = nh_acs_census_county_geo,
    fill = "transparent",
    color = "white",
    size = 1
  )  +
  # use additional state-level shapefile for state border
  geom_sf(
    data = nh_state_shape,
    fill = "transparent",
    color = "grey40",
    size = .05
  )  +
 geom_label(
     data = nh_acs_census_county_geo_to_map, 
     aes(geometry = geometry, 
         label = paste0(county,"\n",round(rco_resource_rate,digits=0)," per 100k")),
    vjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ 1.15,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Merrimack"] ~ .75,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .6,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Rockingham"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Cheshire"] ~ .25,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Belknap"] ~ .15,
                      TRUE ~ 0),
    hjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .4,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Grafton"] ~ .61,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ .4,
                      TRUE ~ .5),
    family = "Franklin Gothic Demi",
    color = "gray25",
    size = 2.8,
    fontface = "bold",
    stat = "sf_coordinates") +
  guides(fill = guide_colorbar(barwidth = 8),
           direction = "horizontal",
      barheight = unit(2, units = "mm"),
      barwidth = unit(50, units = "mm"),
      draw.ulim = F,
      title.position = 'top',
      # some shifting around
      title.hjust = 0.5,
      label.hjust = 0.5) +
  labs(
    title = NULL,
    subtitle = NULL,
    x = NULL,
    y = NULL,
    fill = NULL
  ) +
  # add theme
  theme_map() +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.5, 0.5),
    legend.text = element_text(size = 11),
    legend.margin=margin(-10,0,0,0),
    legend.box.margin=margin(-10,0,0,0)
  ) 


### write out
ggsave(
    filename = file.path(sp_viz_output_path, "nh_resource_availability_map_rco.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    height = 5.25,
    width = 10,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

### Map of all New Hampshire Coaliton of Recovery Residences (NHCORR) by County (locations per 100k residents)

```{r layout="l-page",echo=FALSE,message=FALSE,warning=FALSE}
### map via ggplot 
ggplot(
  # define main data source
  data = nh_acs_census_county_geo
) +
  scale_alpha(name = "",
              range = c(0.6, 0),
              guide = F) + # suppress legend
  # add main fill aesthetic
  # use thin white stroke for municipality borders
  geom_sf(
    mapping = aes(
      fill = nhcorr_recovery_resource_rate
      ),
    color = "white",
    size = 0.3
  ) +
    scale_fill_distiller(
    labels = scales::number_format(accuracy=1),
    direction = 1,
    name = "NHCORR-Certified Locations\nper 100k Adults"
  ) +
  ### use jr palette here
    scale_colour_gradientn(colours = c("#D7EBF1","#AFD6E2","#87C2D4","#2F7084","#1F4A58")) +
 # scale_fill_manual(
 #    values = c("#1F4A58","#2F7084","#87C2D4","#AFD6E2"),
 #    name = "CMHC Resources\nper 100k Residents",
 #    na.value = "grey50",
 #    guide = guide_legend(
 #     keyheight = unit(7.5, units = "mm"),
 #     title.position = "top",
 #     reverse = F # display highest on top
 #  )) +
  # use white stroke borders for county boundaries
  geom_sf(
    data = nh_acs_census_county_geo,
    fill = "transparent",
    color = "white",
    size = 1
  )  +
  # use additional state-level shapefile for state border
  geom_sf(
    data = nh_state_shape,
    fill = "transparent",
    color = "grey40",
    size = .05
  )  +
 geom_label(
     data = nh_acs_census_county_geo_to_map, 
     aes(geometry = geometry, 
         label = paste0(county,"\n",round(nhcorr_recovery_resource_rate,digits=0)," per 100k")),
    vjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ 1.15,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Merrimack"] ~ .75,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .6,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Rockingham"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Cheshire"] ~ .25,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Belknap"] ~ .15,
                      TRUE ~ 0),
    hjust = case_when(nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Carroll"] ~ .4,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Strafford"] ~ .35,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Grafton"] ~ .61,
                      nh_acs_census_county_geo_to_map$geometry==nh_acs_census_county_geo_to_map$geometry[nh_acs_census_county_geo_to_map$county=="Hillsborough"] ~ .4,
                      TRUE ~ .5),
    family = "Franklin Gothic Demi",
    color = "gray25",
    size = 2.8,
    fontface = "bold",
    stat = "sf_coordinates") +
  guides(fill = guide_colorbar(barwidth = 8),
           direction = "horizontal",
      barheight = unit(2, units = "mm"),
      barwidth = unit(50, units = "mm"),
      draw.ulim = F,
      title.position = 'top',
      # some shifting around
      title.hjust = 0.5,
      label.hjust = 0.5) +
  labs(
    title = NULL,
    subtitle = NULL,
    x = NULL,
    y = NULL,
    fill = NULL,
    caption = NULL
  ) +
  # add theme
  theme_map() +
  theme(
    # plot.margin = margin(),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.5, 0.5),
    legend.text = element_text(size = 11))


# ### write out
# ggsave(
#     filename = file.path(sp_viz_output_path, "nh_resource_availability_overall.png"),
#     plot = last_plot(),
#     device = ragg::agg_png,
#     dpi = 300,
#     height = 5.25,
#     width = 10,
#     units = "in",
#     bg = "transparent"
#   )
```

<br><br>
