---
title: "Medicaid Behavioral Health Encounters, County-Level"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
---

```{r include=FALSE}
# load packages
source("data_cleaning/00_library.R")
```

```{r include=FALSE}
### set chunk output 
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

### set path using csg_sp_path
# sp_data_path <- csg_sp_path(file.path("JR_NH"))

```

```{r include=FALSE}
### import adm_all -- jail administrative that we'll compare to the numbers from the medicaid match files
load(paste0(sp_data_path, "/Data/r_data/adm_all.Rda", 
            sep = "")) 

### de-dup by individual and booking -- these are the two units of analysis for comparisons to the medicaid data
### here we are de-duping bookings with multiple charges as we don't need that information for this comparison
adm_all_dedup <- adm_all %>% 
  ungroup() %>% 
  distinct(id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs


### import medicaid_jail_all -- medicaid jail data that we'll compare to the numbers from the jail administrative files
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
medicaid_jail_all <- read_rds("D:/Analytic/medicaid_jail_all.rds") 

### de-dup (there are a few duplicate bookings) and create booking id for analysis
medicaid_jail_all_dedup <- medicaid_jail_all %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

### import jail_medicaid_analytic_individual_booking_level -- the individual-level analytic file created with all DHHS files
### file is unique by individual/booking
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
jail_medicaid_analytic_individual_booking_level <- read_rds("D:/Analytic/jail_medicaid_analytic_individual_booking_level.rds") 

### de-dup (there are a few duplicate bookings) and create booking id for analysis
jail_medicaid_analytic_individual_booking_level_dedup <- jail_medicaid_analytic_individual_booking_level %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
jail_medicaid_analytic_individual_booking_level_dedup_hu_recode <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  ### to ensure each individual/booking is in correct grouping, start with Non-HU, then 10% and move down to 1%
  mutate(hu_group_exclusive = case_when(
    high_utilizer_10_pct=="No" ~ 4,
    high_utilizer_10_pct=="Yes" & high_utilizer_5_pct=="No" & high_utilizer_1_pct=="No" ~ 3,
    high_utilizer_5_pct=="Yes" & high_utilizer_1_pct=="No" ~ 2,
    high_utilizer_1_pct=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_exclusive = factor(hu_group_exclusive,
         levels = c(1,2,3,4),
         labels = c("Top 1%", "Top 5%", "Top 10%", "Non-HU"))) %>% 
  ### now create overall hu grouping -- either yes or no
  mutate(hu_group_overall = case_when(
    high_utilizer_10_pct=="No" ~ 2,
    high_utilizer_10_pct=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_overall = factor(hu_group_overall,
         levels = c(1,2),
         labels = c("High Utilizer", "Non-High Utilizer")))

### read in and merge cdc_county_rural_urban_crosswalk: https://www.cdc.gov/nchs/data_access/urban_rural.htm
cdc_county_rural_urban_crosswalk <- openxlsx::read.xlsx(file.path(sp_data_path,"Data/US County Geo Data/CDC_NCHSURCodes2013.xlsx"), 
                                                        sheet = "NCHSURCodes2013") %>%
  clean_names() %>%
  dplyr::filter(state_abr == "NH") %>%
  mutate(cdc_urban_rural_classification = case_when(
    x2013_code=="1" ~ "Urban Center",
    x2013_code=="2" ~ "Suburb",
    x2013_code=="3" ~ "Medium City",
    x2013_code=="4" ~ "Small City",
    x2013_code=="5" ~ "Town", 
    x2013_code=="6" ~ "Rural Area",### see: https://www.cdc.gov/nchs/data/data_acces_files/NCHSUrbruralFileDocumentationInternet2.pd
# from matt:
# Large central metro > Urban centers
# Large fringe metro > Suburbs
# Medium metro > Medium cities
# Small metro > Small cities
# Micropolitan > Towns
# Non-core > Rural areas
    TRUE ~ as.character(NA))) %>% 
  dplyr::select(county_name,cdc_urban_rural_classification) %>% 
  mutate(county = str_remove(county_name,
                             pattern = " County"))

### join cdc_county_rural_urban_crosswalk to jail_medicaid_analytic_individual_booking_level_dedup_hu_recode
jail_medicaid_analytic_individual_booking_level_dedup_hu_recode_cdc <- left_join(jail_medicaid_analytic_individual_booking_level_dedup_hu_recode,
                                                  cdc_county_rural_urban_crosswalk,
                                                  by = "county") 
```         

# DHHS Medicaid Match and Jail Booking Descriptive Analysis: Behavioral Health Encounters by County

<br>

## Tables


### Table 1. Percentage of Individuals with Behavioral Health "Encounters" by Treatment, Service, and Programming Type

Note: "Encounters" include any behavioral health-related medical/clinical or pharmacy visitation. Examples include ED visits or pharmacy services linked to mental health or substance use disorder diagnoses. We should probably ask Uma for a DHHS definition for the presentation. For this analysis, encounter type is broken down into mental health, substance use disorder, whether service is affiliated with CMHC provider (Community Mental Health Centers), emergency department visit, pharmacy service for mental health, pharmacy service for substance use disorder, as well as other services. Co-Occurring Disorders indicates that individual had at least one Mental Health- and one Substance Use Disorder-related primary diagnoses in the Medicaid data. 

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

**For definitions of each column/flag created in the analytic file, see full data dictionary here (Individual-level File tab): https://csgorg.sharepoint.com/:x:/s/Team-JC-Research/EUJfEABIuNNBvKARa4Kq1nwBvSLwsK4aH7K9oZDOWxbc1w?e=JADcH8** 

```{r echo=FALSE,message=FALSE,warning=FALSE} 
### create table of highlighting the percentage of the medicaid sample that is matched to medicaid data (using pre_or_study_window_medicaid_match_flag_overall) by county using the medicaid_jail_all file

# by county
medicaid_jail_county_bh_service_type_table <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_bh_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Individuals w/ BH Service provided by CMHC (%)` = scales::percent(`Individuals w/ BH Service provided by CMHC (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by ED (N)` = n_distinct(unique_person_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Individuals w/ BH Service provided by ED (%)` = scales::percent(`Individuals w/ BH Service provided by ED (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Individuals w/ MH Pharmacy Service (%)` = scales::percent(`Individuals w/ MH Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Individuals w/ SUD Pharmacy Service (%)` = scales::percent(`Individuals w/ SUD Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ Other BH Service (N)` = n_distinct(unique_person_id[pre_or_study_other_service_flag==1]),
                   `Individuals w/ Other BH Service (%)` = scales::percent(`Individuals w/ Other BH Service (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`Jail` = county) 

# statewide
medicaid_jail_overall_bh_service_type_table <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_bh_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Individuals w/ BH Service provided by CMHC (%)` = scales::percent(`Individuals w/ BH Service provided by CMHC (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by ED (N)` = n_distinct(unique_person_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Individuals w/ BH Service provided by ED (%)` = scales::percent(`Individuals w/ BH Service provided by ED (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Individuals w/ MH Pharmacy Service (%)` = scales::percent(`Individuals w/ MH Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Individuals w/ SUD Pharmacy Service (%)` = scales::percent(`Individuals w/ SUD Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ Other BH Service (N)` = n_distinct(unique_person_id[pre_or_study_other_service_flag==1]),
                   `Individuals w/ Other BH Service (%)` = scales::percent(`Individuals w/ Other BH Service (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`Jail` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_county_statewide_bh_service_type_table <- rbind(medicaid_jail_county_bh_service_type_table,
                                                              medicaid_jail_overall_bh_service_type_table)

### print table via kableextra
kable(medicaid_jail_county_statewide_bh_service_type_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(10, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  column_spec(14, bold = TRUE) %>% 
  column_spec(16, bold = TRUE) %>% 
  column_spec(18, bold = TRUE) %>% 
  column_spec(20, bold = TRUE) %>% 
  column_spec(22, bold = TRUE) %>% 
  column_spec(24, bold = TRUE) %>% 
  scroll_box(width = "130%")
```

<br><br>

### Table 2. Percentage of Individuals with Behavioral Health "Encounters" by Treatment, Service, and Programming Type (by rural/urban classification)

Note: "Encounters" include any behavioral health-related medical/clinical or pharmacy visitation. Examples include ED visits or pharmacy services linked to mental health or substance use disorder diagnoses. We should probably ask Uma for a DHHS definition for the presentation. For this analysis, encounter type is broken down into mental health, substance use disorder, whether service is affiliated with CMHC provider (Community Mental Health Centers), emergency department visit, pharmacy service for mental health, pharmacy service for substance use disorder, as well as other services. Co-Occurring Disorders indicates that individual had at least one Mental Health- and one Substance Use Disorder-related primary diagnoses in the Medicaid data. 

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period. Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

**County-level CDC rural/urban county classification comes from https://www.cdc.gov/nchs/data_access/urban_rural.htm**

**For definitions of each column/flag created in the analytic file, see full data dictionary here (Individual-level File tab): https://csgorg.sharepoint.com/:x:/s/Team-JC-Research/EUJfEABIuNNBvKARa4Kq1nwBvSLwsK4aH7K9oZDOWxbc1w?e=JADcH8** 

```{r echo=FALSE,message=FALSE,warning=FALSE} 
### create table of highlighting the percentage of the medicaid sample that is matched to medicaid data (using pre_or_study_window_medicaid_match_flag_overall) by county using the medicaid_jail_all file

# by county
medicaid_jail_cdc_bh_service_type_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode_cdc %>% 
  dplyr::group_by(cdc_urban_rural_classification) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_bh_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Individuals w/ BH Service provided by CMHC (%)` = scales::percent(`Individuals w/ BH Service provided by CMHC (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by ED (N)` = n_distinct(unique_person_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Individuals w/ BH Service provided by ED (%)` = scales::percent(`Individuals w/ BH Service provided by ED (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Individuals w/ MH Pharmacy Service (%)` = scales::percent(`Individuals w/ MH Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Individuals w/ SUD Pharmacy Service (%)` = scales::percent(`Individuals w/ SUD Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ Other BH Service (N)` = n_distinct(unique_person_id[pre_or_study_other_service_flag==1]),
                   `Individuals w/ Other BH Service (%)` = scales::percent(`Individuals w/ Other BH Service (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`CDC County Classification` = cdc_urban_rural_classification) 

# statewide
medicaid_jail_cdc_overall_bh_service_type_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode_cdc %>%   dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_bh_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Individuals w/ BH Service provided by CMHC (%)` = scales::percent(`Individuals w/ BH Service provided by CMHC (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ BH Service provided by ED (N)` = n_distinct(unique_person_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Individuals w/ BH Service provided by ED (%)` = scales::percent(`Individuals w/ BH Service provided by ED (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ MH Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Individuals w/ MH Pharmacy Service (%)` = scales::percent(`Individuals w/ MH Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Individuals w/ SUD Pharmacy Service (%)` = scales::percent(`Individuals w/ SUD Pharmacy Service (N)`/`Individuals w/ any Medicaid Match (N)`),
                   `Individuals w/ Other BH Service (N)` = n_distinct(unique_person_id[pre_or_study_other_service_flag==1]),
                   `Individuals w/ Other BH Service (%)` = scales::percent(`Individuals w/ Other BH Service (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`CDC County Classification` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_cdc_statewide_bh_service_type_table <- rbind(medicaid_jail_cdc_bh_service_type_table,
                                                              medicaid_jail_cdc_overall_bh_service_type_table)

### print table via kableextra
kable(medicaid_jail_cdc_statewide_bh_service_type_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  column_spec(14, bold = TRUE) %>% 
  column_spec(16, bold = TRUE) %>% 
  column_spec(18, bold = TRUE) %>% 
  column_spec(20, bold = TRUE) %>% 
  column_spec(22, bold = TRUE) %>% 
  column_spec(24, bold = TRUE) %>% 
  scroll_box(width = "130%")
```

<br><br>

### Table 3. Percentage of Bookings with Behavioral Health "Encounters" by Treatment, Service, and Programming Type

Note: "Encounters" include any behavioral health-related medical/clinical or pharmacy visitation. Examples include ED visits or pharmacy services linked to mental health or substance use disorder diagnoses. We should probably ask Uma for a DHHS definition for the presentation. I am currently using all behavioral health data from the Medicaid Encounter file, regardless of timing (before, during, or after the study period). For this analysis, encounter type is broken down into mental health, substance use disorder, whether service is affiliated with CMHC provider (Community Mental Health Centers), emergency department visit, pharmacy service for mental health, pharmacy service for substance use disorder, as well as other services. 

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period. Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

```{r echo=FALSE,message=FALSE,warning=FALSE} 
### create table of highlighting the percentage of the medicaid sample that is matched to medicaid data (using pre_or_study_window_medicaid_match_flag_overall) by county using the medicaid_jail_all file by booking (unique_person_booking_id)

# by county
medicaid_jail_county_bh_service_type_booking_table <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Overall Bookings (N)` = n_distinct(unique_person_booking_id),
                   `Bookings w/ any Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any Medicaid Match (%)` = scales::percent(`Bookings w/ any Medicaid Match (N)`/`Overall Bookings (N)`),
                   `Bookings w/ BH Encounter (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_flag==1]),
                   `Bookings w/ BH Encounter (%)` = scales::percent(`Bookings w/ BH Encounter (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ MH Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ SUD Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_booking_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Bookings w/ BH Service provided by CMHC (%)` = scales::percent(`Bookings w/ BH Service provided by CMHC (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by ED (N)` = n_distinct(unique_person_booking_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Bookings w/ BH Service provided by ED (%)` = scales::percent(`Bookings w/ BH Service provided by ED (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Bookings w/ MH Pharmacy Service (%)` = scales::percent(`Bookings w/ MH Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Bookings w/ SUD Pharmacy Service (%)` = scales::percent(`Bookings w/ SUD Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ Other BH Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_other_service_flag==1]),
                   `Bookings w/ Other BH Service (%)` = scales::percent(`Bookings w/ Other BH Service (N)`/`Bookings w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`Jail` = county) 

# statewide
medicaid_jail_overall_bh_service_type_booking_table <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  dplyr::summarise(`Overall Bookings (N)` = n_distinct(unique_person_booking_id),
                   `Bookings w/ any Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any Medicaid Match (%)` = scales::percent(`Bookings w/ any Medicaid Match (N)`/`Overall Bookings (N)`),
                   `Bookings w/ BH Encounter (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_flag==1]),
                   `Bookings w/ BH Encounter (%)` = scales::percent(`Bookings w/ BH Encounter (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ MH Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ SUD Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_booking_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Bookings w/ BH Service provided by CMHC (%)` = scales::percent(`Bookings w/ BH Service provided by CMHC (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by ED (N)` = n_distinct(unique_person_booking_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Bookings w/ BH Service provided by ED (%)` = scales::percent(`Bookings w/ BH Service provided by ED (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Bookings w/ MH Pharmacy Service (%)` = scales::percent(`Bookings w/ MH Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Bookings w/ SUD Pharmacy Service (%)` = scales::percent(`Bookings w/ SUD Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ Other BH Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_other_service_flag==1]),
                   `Bookings w/ Other BH Service (%)` = scales::percent(`Bookings w/ Other BH Service (N)`/`Bookings w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`Jail` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_county_statewide_bh_service_type_booking_table <- rbind(medicaid_jail_county_bh_service_type_booking_table,
                                                                      medicaid_jail_overall_bh_service_type_booking_table)

### print table via kableextra
kable(medicaid_jail_county_statewide_bh_service_type_booking_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(10, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  column_spec(14, bold = TRUE) %>% 
  column_spec(16, bold = TRUE) %>% 
  column_spec(18, bold = TRUE) %>% 
  column_spec(20, bold = TRUE) %>% 
  column_spec(22, bold = TRUE) %>% 
  scroll_box(width = "130%")
```

<br><br>

### Table 4. Percentage of Bookings with Behavioral Health "Encounters" by Treatment, Service, and Programming Type (by rural/urban classification)

Note: "Encounters" include any behavioral health-related medical/clinical or pharmacy visitation. Examples include ED visits or pharmacy services linked to mental health or substance use disorder diagnoses. We should probably ask Uma for a DHHS definition for the presentation. I am currently using all behavioral health data from the Medicaid Encounter file, regardless of timing (before, during, or after the study period). For this analysis, encounter type is broken down into mental health, substance use disorder, whether service is affiliated with CMHC provider (Community Mental Health Centers), emergency department visit, pharmacy service for mental health, pharmacy service for substance use disorder, as well as other services. 

**County-level CDC rural/urban county classification comes from https://www.cdc.gov/nchs/data_access/urban_rural.htm**

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period. Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

```{r echo=FALSE,message=FALSE,warning=FALSE} 
### create table of highlighting the percentage of the medicaid sample that is matched to medicaid data (using pre_or_study_window_medicaid_match_flag_overall) by county using the medicaid_jail_all file by booking (unique_person_booking_id)

# by county
medicaid_jail_cdc_bh_service_type_booking_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode_cdc %>% 
  dplyr::group_by(cdc_urban_rural_classification) %>% 
  dplyr::summarise(`Number of Counties (N)` = n_distinct(county,
                                                         na.rm = TRUE),
                   `Overall Bookings (N)` = n_distinct(unique_person_booking_id),
                   `Bookings w/ any Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any Medicaid Match (%)` = scales::percent(`Bookings w/ any Medicaid Match (N)`/`Overall Bookings (N)`),
                   `Bookings w/ BH Encounter (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_flag==1]),
                   `Bookings w/ BH Encounter (%)` = scales::percent(`Bookings w/ BH Encounter (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ MH Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ SUD Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_booking_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Bookings w/ BH Service provided by CMHC (%)` = scales::percent(`Bookings w/ BH Service provided by CMHC (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by ED (N)` = n_distinct(unique_person_booking_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Bookings w/ BH Service provided by ED (%)` = scales::percent(`Bookings w/ BH Service provided by ED (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Bookings w/ MH Pharmacy Service (%)` = scales::percent(`Bookings w/ MH Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Bookings w/ SUD Pharmacy Service (%)` = scales::percent(`Bookings w/ SUD Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ Other BH Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_other_service_flag==1]),
                   `Bookings w/ Other BH Service (%)` = scales::percent(`Bookings w/ Other BH Service (N)`/`Bookings w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`CDC County Classification` = cdc_urban_rural_classification) 

# statewide
medicaid_jail_cdc_overall_bh_service_type_booking_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode_cdc %>% 
  dplyr::summarise(`Number of Counties (N)` = n_distinct(county,
                                                         na.rm = TRUE),
                   `Overall Bookings (N)` = n_distinct(unique_person_booking_id),
                   `Bookings w/ any Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any Medicaid Match (%)` = scales::percent(`Bookings w/ any Medicaid Match (N)`/`Overall Bookings (N)`),
                   `Bookings w/ BH Encounter (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_flag==1]),
                   `Bookings w/ BH Encounter (%)` = scales::percent(`Bookings w/ BH Encounter (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Bookings w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ MH Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Bookings w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Bookings w/ SUD Service Encounter, Primary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_booking_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Bookings w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by CMHC (N)` = n_distinct(unique_person_booking_id[pre_or_study_service_provided_by_cmhc_provider_flag==1]),
                   `Bookings w/ BH Service provided by CMHC (%)` = scales::percent(`Bookings w/ BH Service provided by CMHC (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ BH Service provided by ED (N)` = n_distinct(unique_person_booking_id[pre_or_study_ed_visit_or_service_flag==1]),
                   `Bookings w/ BH Service provided by ED (%)` = scales::percent(`Bookings w/ BH Service provided by ED (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ MH Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_mental_health_pharmacy_service_flag==1]),
                   `Bookings w/ MH Pharmacy Service (%)` = scales::percent(`Bookings w/ MH Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ SUD Pharmacy Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_sud_pharmacy_service_flag==1]),
                   `Bookings w/ SUD Pharmacy Service (%)` = scales::percent(`Bookings w/ SUD Pharmacy Service (N)`/`Bookings w/ any Medicaid Match (N)`),
                   `Bookings w/ Other BH Service (N)` = n_distinct(unique_person_booking_id[pre_or_study_other_service_flag==1]),
                   `Bookings w/ Other BH Service (%)` = scales::percent(`Bookings w/ Other BH Service (N)`/`Bookings w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`CDC County Classification` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_cdc_statewide_bh_service_type_booking_table <- rbind(medicaid_jail_cdc_bh_service_type_booking_table,
                                                                      medicaid_jail_cdc_overall_bh_service_type_booking_table)

### print table via kableextra
kable(medicaid_jail_cdc_statewide_bh_service_type_booking_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(5, bold = TRUE) %>% 
  column_spec(7, bold = TRUE) %>% 
  column_spec(9, bold = TRUE) %>% 
  column_spec(11, bold = TRUE) %>% 
  column_spec(13, bold = TRUE) %>% 
  column_spec(15, bold = TRUE) %>% 
  column_spec(17, bold = TRUE) %>% 
  column_spec(19, bold = TRUE) %>% 
  column_spec(21, bold = TRUE) %>% 
  column_spec(23, bold = TRUE) %>% 
  scroll_box(width = "130%")
```

<br><br>


## Visuals

TBD


<br><br>

