---
title: "Charge Analysis"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    theme: theme.css
    self_contained: false
---

**Counties Included**: All New Hampshire counties except Grafton and Strafford. Strafford is excluded because their data does not include any charge information (neither charge code nor charge description). 

The following analysis uses jail administrative data submitted directly to CSG in addition to a NH offense look-up table with offense codes, descriptions, and degrees (e.g., Class A Misdemeanor, etc.). However, we will not be able to analyze severity/degree of charges with the data we've received. With only offense statute and description, we can’t accurately tell if a given charge is a misdemeanor or felony (or even class A misdemeanor versus class B misdemeanor). For this level of detail, we would need either the ‘Smart Code’ or the ‘ODDSY Code’ – which may not even be known at the time of booking. For instance, there are 8 entries for ‘criminal trespass’/’statute ‘635:2’ in the look-up file – which degrees ranging from violations to class A and B misdemeanors to class B felonies. 

It appears that the best option, at this point, is to categorize the charges into violent, public order, drugs/alcohol, property, and probation/parole violation. Drawing from approaches used by the NH Department of Safety (see https://crimestats.dos.nh.gov/public/Dim/dimension.aspx) as well as FBI definitions for both NIBRS and UCR data (see https://www.waspc.org/assets/CJIS/trainingmanualsandreference/nibrsvssummaryoverview.pdf), I categorized certain offenses into these categories. For full list of which offenses are grouped into each crime type, see table below.

**Business Rules**: When cleaning the charge data, I first de-duplicated by individual (id + inmate_id), booking (booking_id), and charge (either charge_code or charge_desc depending on data availability). There appear to be some duplicates across these fields, but we have no way of knowing if two identical charges for the same booking represents a duplicated entry or multiple counts of the same charge. Unfortunately, this will likely just be a limitation of this analysis. After joining the jail charge data to the updated look-up table with crime type data, I de-duplicated the file again by individual and booking -- keeping the most serious charge type. Here is the crime type hierarchy (in order of severity) I used for this decision: violent, property, drug/alcohol, public order, violation of probation/parole, and then other/missing categories. One limitation is that we are not able to account for degree/severity of charge (felony vs. misdemeanor) with this approach. Does this make sense?


**Remaining Questions**:

* There is missing charge code/charge description data across most counties. How should we interpret this? Belknap seems to have the hightest rates of missingness with about 11% of non-PC hold booking have no charge code or charge description. In general, how should we interpret missing charge data? Why is it missing? Is it missing at random? 

<br>


```{r setup, include=FALSE}
### set chunk output 
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

### call libraries and functions
# source("data_cleaning/00_library.R")
source("data_cleaning/01_functions.R")
source("data_cleaning/01_functions_visuals.R")
source("data_cleaning/00_library_ab_path.R")

# import cleaned charge analytic file (for all eight counties with charge data)
load(paste0(sp_data_path, "/Data/r_data/offenses_clean/nh_eight_county_charge_clean_final.Rda", sep = ""))

### import and clean raw charge codes look-up table
charge_codes_crime_type_lookup <- read_excel(paste0(sp_data_path, "/Data/Offense Information/CPI_DMV_COURT_crime_type_clean.xls"), 
                                sheet = "charge_lookup_crime_type_full") %>%
  clean_names() %>%
  mutate(descriptor_lookup = str_to_title(descriptor),
         statute_title_lookup = str_to_title(statute_title),
         charge_code_lookup = str_to_title(offense_statute)) %>% 
### Based on the jail charge data we've received, I don't think we can look at severity/degree of charges
### With only offense statute and description, we can't accurately tell if a given charge is a misdemeanor or felony (or even class A misdemeanor versus class B misdemeanor)
### For this level of detail, we'd need either the 'Smart Code' or the 'ODDSY Code' - which may not even be known at the time of booking
### For instance, there are 8 entries for 'criminal trespass'/'statute '635:2' in the lookup file - which degrees ranging from violations to class A and B misdemeanors to class B felonies
### I think the best option, at this point, is to just categorize the charges into violent, public order, drugs/alcohol, and property
  distinct(statute_title_lookup,
           crime_type,
           .keep_all = TRUE) %>% ### de-dup by offense information and crime type 
  select(charge_code_lookup, descriptor_lookup, statute_title_lookup, crime_type_lookup=crime_type) 
```

# Raw Charges and Coded Charge Type

Here is a list of all charges that were categorized as either violent, property, drug/alcohol, public order, or probation/parole violations. These are not necessarily charges associated with jail bookings or individuals in the jail data files. 

Note: The charge descriptions still need to be cleaned/standardized in some cases (e.g., "Willful Concealment" and "Willful Concealment and Shoplifting")

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create table of unique statute titles and associated crime/charge type (only for charges with crime type value)
table_charge_codes_crime_type_lookup <- charge_codes_crime_type_lookup %>% 
  filter(!is.na(crime_type_lookup)) %>% 
  dplyr::group_by(statute_title_lookup,
                  crime_type_lookup) %>% 
  dplyr::summarise(`Unique Descriptions (N)` = n_distinct(descriptor_lookup)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup,
                `Charge Type` = crime_type_lookup) %>% 
  select(-`Unique Descriptions (N)`)

### print table via kableextra
kable(table_charge_codes_crime_type_lookup, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l")
```

<br><br>

# Bookings by Charge Type (most serious) across New Hampshire

Note: I am considering a booking to be 'unique' if the following values are together unique: id, inmate_id, booking_id, county (including county as we can't verify that each county is using different IDs for individuals and bookings). The count reported in the following tables is the unique number of bookings for which the most serious charge type is a violent charge, property charge, etc.

```{r include=FALSE,message=FALSE,warning=FALSE}
nh_eight_county_charge_clean_final_id <- nh_eight_county_charge_clean_final %>%
  mutate(unique_booking_id_nh = paste0(id,
                                       inmate_id,
                                       booking_id,
                                       county)) %>% 
  mutate(descriptor_lookup = str_to_title(descriptor_lookup),
         statute_title_lookup = str_to_title(statute_title_lookup)) ### clean up descriptor and statute title for tables
```

<br>

### Most Common Charges across Charge Type, Statewide (top 20)

Note: This table excludes non-PC holds as well as charges that were not categorized into a specific charge type. The charge descriptions still need to be cleaned/standardized in some cases (e.g., "Willful Concealment" and "Willful Concealment and Shoplifting").

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample excluding pc-holds
unique_bookings_all_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$pc_hold=="Non-PC Hold" & nh_eight_county_charge_clean_final_id$statute_title_lookup!="Missing"])

### unique bookings per charge description
df_nh_all_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(pc_hold=="Non-PC Hold",
         statute_title_lookup!="Missing") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_all_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  arrange(desc(`Unique Bookings (N)`)) %>% 
  head(20) %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### print table via kableextra
kable(df_nh_all_offense_desc_count, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br>

### Violent Offenses, Statewide

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_violent_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Violent"])

### unique bookings per charge description
df_nh_violent_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Violent") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_violent_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### overall
df_nh_violent_offense_count_overall <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Violent") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_violent_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description` = "Overall")

### combine tables for kable
table_nh_violent_offense_desc_count_final <- rbind(df_nh_violent_offense_desc_count,
                                                   df_nh_violent_offense_count_overall)

### print table via kableextra
kable(table_nh_violent_offense_desc_count_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(21, bold = TRUE)
```

<br>

### Property Offenses, Statewide

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_property_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Property"])

### unique bookings per charge description
df_nh_property_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Property") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_property_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### overall
df_nh_property_offense_count_overall <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Property") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_property_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description` = "Overall")

### combine tables for kable
table_nh_property_offense_desc_count_final <- rbind(df_nh_property_offense_desc_count,
                                                    df_nh_property_offense_count_overall)

### print table via kableextra
kable(table_nh_property_offense_desc_count_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(21, bold = TRUE)
```

<br>

### Drug/Alcohol Offenses, Statewide

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_drug_alc_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Drug/Alcohol"])

### unique bookings per charge description
df_nh_drug_alc_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Drug/Alcohol") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_drug_alc_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### overall
df_nh_drug_alc_offense_count_overall <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Drug/Alcohol") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_drug_alc_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description` = "Overall")

### combine tables for kable
table_nh_drug_alc_offense_desc_count_final <- rbind(df_nh_drug_alc_offense_desc_count,
                                                    df_nh_drug_alc_offense_count_overall)

### print table via kableextra
kable(table_nh_drug_alc_offense_desc_count_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE)
```

<br>

### Drug/Alcohol Offenses, Statewide 

Note: This table is broken down further as the broader categories above don't say much for drug/alcohol charges

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_drug_alc_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Drug/Alcohol"])

### unique bookings per charge description
df_nh_drug_alc_offense_desc_count_2 <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Drug/Alcohol") %>% 
  dplyr::group_by(descriptor_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_drug_alc_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description (Detailed)` = descriptor_lookup) 

### overall
df_nh_drug_alc_offense_count_overall_2 <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Drug/Alcohol") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_drug_alc_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description (Detailed)` = "Overall")

### combine tables for kable
table_nh_drug_alc_offense_desc_count_final_2 <- rbind(df_nh_drug_alc_offense_desc_count_2,
                                                      df_nh_drug_alc_offense_count_overall_2)

### print table via kableextra
kable(table_nh_drug_alc_offense_desc_count_final_2, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(34, bold = TRUE)
```

<br>

### Public Order Offenses, Statewide

Note: 'Transporting Alcoholic Beverages' appears to be the same as 'Open Container'

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_public_order_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Public Order"])

### unique bookings per charge description
df_nh_public_order_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Public Order") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_public_order_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### overall
df_nh_public_order_offense_count_overall <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Public Order") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_public_order_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description` = "Overall")

### combine tables for kable
table_nh_public_order_offense_desc_count_final <- rbind(df_nh_public_order_offense_desc_count,
                                                        df_nh_public_order_offense_count_overall)

### print table via kableextra
kable(table_nh_public_order_offense_desc_count_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(9, bold = TRUE)
```

<br>

### Probation/Parole Violations, Statewide

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create denominator -- unique bookings for sub-sample
unique_bookings_vop_denom <- n_distinct(nh_eight_county_charge_clean_final_id$unique_booking_id_nh[nh_eight_county_charge_clean_final_id$crime_type_lookup=="Probation/Parole Violation"])

### unique bookings per charge description
df_nh_vop_offense_desc_count <- nh_eight_county_charge_clean_final_id %>% 
  filter(crime_type_lookup=="Probation/Parole Violation") %>% 
  dplyr::group_by(statute_title_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_vop_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description` = statute_title_lookup) 

### overall
df_nh_vop_offense_count_overall <- nh_eight_county_charge_clean_final_id %>% 
 filter(crime_type_lookup=="Probation/Parole Violation") %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_vop_denom,
                                                                       accuracy = .1)) %>% 
  mutate(`Charge Description` = "Overall")

### combine tables for kable
table_nh_vop_offense_desc_count_final <- rbind(df_nh_vop_offense_desc_count,
                                               df_nh_vop_offense_count_overall)

### print table via kableextra
kable(table_nh_vop_offense_desc_count_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(2, bold = TRUE)
```


<br>

### Other/Uncoded Charges, Statewide (20 most common charges)

Note: These are charges that were not grouped into either violent, property, drug/alcohol, public order, or probation/parole violation categories based on the resources we used as guides. We may want to group additional charges into one of these categories, though. Values of "NA" indicate the charge data provided by jails was missing.

```{r echo=FALSE,message=FALSE,warning=FALSE}
### create df without pc holds and recode missing charge types as other (for now)
nh_eight_county_charge_clean_final_crime_type_recode_non_pc <- nh_eight_county_charge_clean_final_id %>% 
  filter(pc_hold=="Non-PC Hold") %>% 
  mutate(crime_type_clean = ifelse(is.na(crime_type_lookup)==TRUE,
                                   "Other",
                                   crime_type_lookup))

### create denominator -- unique bookings for sub-sample
unique_bookings_other_denom <- n_distinct(nh_eight_county_charge_clean_final_crime_type_recode_non_pc$unique_booking_id_nh[nh_eight_county_charge_clean_final_crime_type_recode_non_pc$crime_type_clean=="Other"])

### unique bookings per charge description
df_nh_other_offense_desc_count <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  filter(crime_type_clean=="Other") %>% 
  dplyr::group_by(descriptor_lookup) %>% 
  dplyr::summarise(`Unique Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings, Percent of Sample (%)` = scales::percent(`Unique Bookings (N)`/unique_bookings_other_denom,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  dplyr::rename(`Charge Description (Detailed)` = descriptor_lookup) %>% 
  arrange(desc(`Unique Bookings (N)`)) %>% 
  head(20) ### take top 20


### print table via kableextra
kable(df_nh_other_offense_desc_count, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br><br>

### Charge Type by Jail (Non-PC Holds Only)

```{r echo=FALSE,message=FALSE,warning=FALSE}
### unique bookings per charge type by county
df_county_level_charge_type_summary <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  distinct() %>% 
  dplyr::rename(`County` = county) 

### overall bookings by charge type for nh
df_county_level_charge_type_summary_statewide <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  mutate(`County` = "Statewide")

### combine tables for kable
table_county_level_charge_type_summary_final <- rbind(df_county_level_charge_type_summary,
                                               df_county_level_charge_type_summary_statewide)

### print table via kableextra
kable(table_county_level_charge_type_summary_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(9, bold = TRUE)
```

<br><br>

### Charge Type over Time (Non-PC Holds Only)

Note: These booking frequencies by charge type are grouped by fiscal year of booking

```{r echo=FALSE,message=FALSE,warning=FALSE}
### unique bookings per charge type by fiscal year
df_fy_charge_type_summary <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  dplyr::group_by(fy) %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  distinct() %>% 
  dplyr::rename(`Fiscal Year` = fy) 

### overall bookings by charge type for nh
df_fy_charge_type_summary_statewide <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  mutate(`Fiscal Year` = "Overall")

### combine tables for kable
table_fy_charge_type_summary_final <- rbind(df_fy_charge_type_summary,
                                               df_fy_charge_type_summary_statewide)

### print table via kableextra
kable(table_fy_charge_type_summary_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(4, bold = TRUE)
```

<br><br>

### Charge Type for Individuals who are High Utilizers (based on all three years of data) 

Note: This output excludes charge type analysis for PC bookings, as no charge information exists, but the high utilizer percentile grouping (developed by Mari) does include PC bookings -- does this make sense?

Below is the preliminary grouping I am using to confirm with the team. With this approach, this is not overlap of groups -- one individual is in one of the four groups (i.e., someone in the top 1% of jail entrances is only included in the 1% grouping, not the 5% and 10% grouping). I'm thinking that this may help us better see any differences between groupings of high utilizers, if they exist. Open to suggestions, though!

* **Top 1%:** individual is in top 1% of jail entrances for all 3 years of sample

* **Top 5%:** individual is in top 5% of jail entrances for all 3 years of sample (really this is 1% to 5%)

* **Top 10%:** individual is in top 10% of jail entrances for all 3 years of sample (really this is 5% to 10%)

* **Non-HU:** individual is not in top 10% of jail entrances for all 3 years of sample


```{r echo=FALSE,message=FALSE,warning=FALSE}
### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  ### to ensure each individual/booking is in correct grouping, start with Non-HU, then 10% and move down to 1%
  mutate(hu_group_exclusive = case_when( 
    high_utilizer_10_pct=="No" ~ 4,
    high_utilizer_10_pct=="Yes" & high_utilizer_5_pct=="No" & high_utilizer_1_pct=="No" ~ 3,
    high_utilizer_5_pct=="Yes" & high_utilizer_1_pct=="No" ~ 2,
    high_utilizer_1_pct=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_exclusive = factor(hu_group_exclusive,
         levels = c(1,2,3,4),
         labels = c("Top 1%", "Top 5%", "Top 10%", "Non-HU")))
    

### unique bookings per charge type by HU grouping
df_hu_charge_type_summary <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  distinct() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

### overall bookings by charge type for nh
df_hu_charge_type_summary_overall <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  mutate(`High Utilizer Percentiles` = "Overall")

### combine tables for kable
table_hu_charge_type_summary_final <- rbind(df_hu_charge_type_summary,
                                            df_hu_charge_type_summary_overall)

### print table via kableextra
kable(table_hu_charge_type_summary_final, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE)
```

<br><br>


### Charge Type for Individuals who are High Utilizers (based on single fiscal year calculations) 

Note: This output excludes charge type analysis for PC bookings, as no charge information exists, but the high utilizer percentile grouping (developed by Mari) does include PC bookings -- does this make sense?

Below is the preliminary grouping I am using to confirm with the team. With this approach, this is not overlap of groups -- one individual is in one of the four groups (i.e., someone in the top 1% of jail entrances is only included in the 1% grouping, not the 5% and 10% grouping). I'm thinking that this may help us better see any differences between groupings of high utilizers, if they exist. Open to suggestions, though!

* **Top 1%:** individual is in top 1% of jail entrances for the given fiscal year of booking

* **Top 5%:** individual is in top 5% of jail entrances for the given fiscal year of booking(really this is 1% to 5%)

* **Top 10%:** individual is in top 10% of jail entrances for the given fiscal year of booking (really this is 5% to 10%)

* **Non-HU:** individual is not in top 10% of jail entrances for the given fiscal year of booking


```{r echo=FALSE,message=FALSE,warning=FALSE}
### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode_fy <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc %>% 
  ### to ensure each individual/booking is in correct grouping, start with Non-HU, then 10% and move down to 1%
  mutate(hu_group_exclusive_fy = case_when( 
    high_utilizer_10_pct_fy=="No" ~ 4,
    high_utilizer_10_pct_fy=="Yes" & high_utilizer_5_pct_fy=="No" & high_utilizer_1_pct_fy=="No" ~ 3,
    high_utilizer_5_pct_fy=="Yes" & high_utilizer_1_pct_fy=="No" ~ 2,
    high_utilizer_1_pct_fy=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_exclusive_fy = factor(hu_group_exclusive_fy,
         levels = c(1,2,3,4),
         labels = c("Top 1%", "Top 5%", "Top 10%", "Non-HU")))
    

### unique bookings per charge type by HU grouping
df_hu_charge_type_summary_fy <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode_fy %>% 
  dplyr::group_by(hu_group_exclusive_fy) %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  ungroup() %>% 
  distinct() %>% 
  dplyr::rename(`High Utilizer Percentiles (FY)` = hu_group_exclusive_fy) 

### overall bookings by charge type for nh
df_hu_charge_type_summary_overall_fy <- nh_eight_county_charge_clean_final_crime_type_recode_non_pc_hu_recode_fy %>% 
  dplyr::summarise(`Unique Non-PC Bookings (N)` = n_distinct(unique_booking_id_nh),
                   `Bookings for Violent Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Violent"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Property Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Property"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Drug/Alcohol Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Drug/Alcohol"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Public Order Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Public Order"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                    `Bookings for Probation/Parole Violation (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Probation/Parole Violation"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1),
                   `Bookings for Other Charge (%)` = scales::percent(n_distinct(unique_booking_id_nh[crime_type_clean=="Other"])/`Unique Non-PC Bookings (N)`,
                                                                       accuracy = .1)) %>% 
  mutate(`High Utilizer Percentiles (FY)` = "Overall")

### combine tables for kable
table_hu_charge_type_summary_final_fy <- rbind(df_hu_charge_type_summary_fy,
                                            df_hu_charge_type_summary_overall_fy)

### print table via kableextra
kable(table_hu_charge_type_summary_final_fy, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE)
```

<br><br>

