---
title: "Medicaid Behavioral Health Encounters, Focusing on MH and SUD"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
---

```{r include=FALSE}
# Load functions, packages, and data
source("code/00_library.R")
source("code/01_functions.R")
source("code/rdas.R")

# Set chunk output 
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

##########
# Import files
##########

# import medicaid_jail_all -- medicaid jail data that we'll compare to the numbers from the jail administrative files
# this file lives on the external hard drive (created and exported in `14_medicaid.R`)
medicaid_jail_all <- read_rds("D:/Analytic/medicaid_jail_all.rds") 

# import jail_medicaid_analytic_individual_booking_level -- the individual-level analytic file created with all DHHS files
# file is unique by individual/booking
# this file lives on the external hard drive (created and exported in `14_medicaid.R`)
jail_medicaid_analytic_individual_booking_level <- read_rds("D:/Analytic/jail_medicaid_analytic_individual_booking_level.rds") 

# import medicaid encounters with costs and individual diagnoses created in `14_medicaid.R`
medicaid_encounters_costs_all <- read_rds("D:/Analytic/medicaid_enrollment_categories_encounters.rds") 

##########
# Set up files
##########

#####
entrances_dhhs <- medicaid_jail_all %>% 
  mutate(id = unique_person_id,
         fy = case_when(booking_date > "2018-06-30" & booking_date < "2019-07-01" ~ 2019,
                        booking_date > "2019-06-30" & booking_date < "2020-07-01" ~ 2020,
                        booking_date > "2020-06-30" & booking_date < "2021-07-01" ~ 2021)) %>% 
   filter(booking_date >= "2018-06-30" & booking_date < "2021-07-01")
#####



#####
# de-dup (there are a few duplicate bookings) and create booking id for analysis
jail_medicaid_analytic_individual_booking_level_dedup <- jail_medicaid_analytic_individual_booking_level %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

# recode high utilizer percentile grouping
jail_medicaid_analytic_individual_booking_level_dedup_hu_recode <- fnc_hu_group_exclusive(jail_medicaid_analytic_individual_booking_level_dedup) 
#####



#####
# save ids and HU status, flags
unique_ids_hu <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  select(unique_person_id, 
         hu_group_exclusive,
         hu_group_overall,
         pre_or_study_window_medicaid_match_flag_overall,
         pre_or_study_smi_flag) %>% 
  mutate(unique_person_id = as.character(unique_person_id))
#####



#####
# medicaid encounters with cost and diagnoses information ############################ Andrew, please check this!
# create unique case id using id and dose date
medicaid_encounters_costs <- medicaid_encounters_costs_all
medicaid_encounters_costs$claim_id <- medicaid_encounters_costs %>% 
  dplyr::group_indices(unique_person_id, first_dos_dt) 

# reorganize variables
medicaid_encounters_costs <- medicaid_encounters_costs %>% 
  dplyr::select(unique_person_id,
                claim_id,
                everything())

# create data of just primary diagnosis costs by subsetting to claims that are MH or SUD or both
# remove pharmacy visits
medicaid_encounters_costs_primary_dx_2018_2021 <- medicaid_encounters_costs %>% 
  filter(mh_service_categorized_using_primary_dx_code  == 1 |
         sud_service_categorized_using_primary_dx_code == 1 |
         mental_health_pharmacy_service == 1 |
         sud_pharmacy_service == 1 
         # other_service == 1
         ) %>% 
    # filter(mh_service_categorized_using_primary_dx_code  == 1 |
    #        sud_service_categorized_using_primary_dx_code == 1) %>%
  # subset to FY 2019 to FY 2021
  filter(first_dos_dt > "2018-06-30" & first_dos_dt < "2021-07-01")

# group SMI's and other categories together 
medicaid_encounters_cleaned_2018_2021 <- medicaid_encounters_costs_primary_dx_2018_2021 %>% 
mutate(dx_prmry_clinical_classification_new = case_when(
  
  # SMI-related disorders
  dx_prmry_clinical_classification == "Schizophrenia and other psychotic disorders"          ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Schizophrenia spectrum and other psychotic disorders" ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Depressive disorders"                                 ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Bipolar and related disorders"                        ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Trauma- and stressor-related disorders"               ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Personality disorders"                                ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Obsessive-compulsive and related disorders"           ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Disruptive, impulse-control and conduct disorder"     ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Mood disorders"                                       ~ "SMI-related disorders",
  dx_prmry_clinical_classification == "Other specified and unspecified mood disorders"       ~ "SMI-related disorders",
  
  # Suicidal ideation/attempt/intentional self-harm
  dx_prmry_clinical_classification == "Suicidal ideation/attempt/intentional self-harm"             ~ "Suicidal ideation/attempt/intentional self-harm",
  dx_prmry_clinical_classification == "Suicide attempt/intentional self-harm; subsequent encounter" ~ "Suicidal ideation/attempt/intentional self-harm",
  
  # Other substance-related disorders
  dx_prmry_clinical_classification == "Sedative-related disorders"                  ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Cannabis-related disorders"                  ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Tobacco-related disorders"                   ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Hallucinogen-related disorders"              ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Inhalant-related disorders"                  ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Other specified substance-related disorders" ~ "Other substance-related disorders",
  dx_prmry_clinical_classification == "Stimulant-related disorders"                 ~ "Other substance-related disorders",
  # dx_prmry_clinical_classification == "Alcohol-related disorders"                   ~ "Other substance-related disorders",

  # Other mh-related disorders
  dx_prmry_clinical_classification == "Adjustment disorders"                                     ~ "Other BH-related disorders",
  dx_prmry_clinical_classification == "Feeding and eating disorders"                             ~ "Other BH-related disorders",
  dx_prmry_clinical_classification == "Somatic disorders"                                        ~ "Other BH-related disorders",
  dx_prmry_clinical_classification == "Disruptive, impulse-control and conduct disorders"        ~ "Other BH-related disorders",
  dx_prmry_clinical_classification == "Miscellaneous mental and behavioral disorders/conditions" ~ "Other BH-related disorders",

  dx_prmry_clinical_classification == "Mental and substance use disorders in remission" ~ "Mental and SUD's in remission",

  
  TRUE ~ dx_prmry_clinical_classification)) %>% 
  
  # join with info on person - HU, Medicaid match, etc
  mutate(unique_person_id = as.character(unique_person_id),
         study_suicide_ideation = ifelse(dx_prmry_clinical_classification_new == "Suicidal ideation/attempt/intentional self-harm", 1, 0)) 

# merge with person info created from jail_medicaid_analytic_individual_booking_level_dedup_hu_recode
medicaid_encounters_cleaned_2018_2021 <- unique_ids_hu %>% 
  left_join(medicaid_encounters_cleaned_2018_2021, "unique_person_id") %>% 
  distinct() %>% 

  # remove people who aren't in unique_ids_hu - dont have an HU variable
  filter(!is.na(hu_group_exclusive)) %>% 
  filter(pre_or_study_window_medicaid_match_flag_overall == 1) 

# remove variables that seem to be causing a lot of duplicates
medicaid_encounters_cleaned_2018_2021 <- medicaid_encounters_cleaned_2018_2021 %>% 
  select(unique_person_id,
         claim_id,
         pre_or_study_window_medicaid_match_flag_overall,
         dx_prmry_clinical_classification,
         dx_prmry_clinical_classification_new,
         medicaid_reimb_amt,
         ed_visit_or_service,
         hu_group_overall,
         hu_group_exclusive
         ) %>% 
  distinct()

medicaid_encounters_cleaned_2018_2021 <- medicaid_encounters_cleaned_2018_2021 %>% 
  filter(!is.na(dx_prmry_clinical_classification_new)) 
#####
```         

# DHHS Medicaid Match and Jail Booking Descriptive Analysis: Behavioral Health Encounters by High Jail Utilizer Grouping

<br>

## Tables

### Table 1a: Mental Health and Substance Use Disorder Service Medicaid Encounters by **Overall** High Utilizer Grouping

Note: Co-Occurring Disorders indicates that individual had at least one Mental Health- and one Substance Use Disorder-related primary diagnoses in the Medicaid data.

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

```{r echo=FALSE,message=FALSE,warning=FALSE} 
# by hu_group_exclusive
medicaid_jail_county_bh_service_type_hu_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_overall) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)`     = scales::percent(n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (%)`                             = scales::percent(n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)`  = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)`  = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]))) %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Status` = hu_group_overall) 

# statewide
medicaid_jail_overall_bh_service_type_hu_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)`     = scales::percent(n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (%)`                             = scales::percent(n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)`  = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)`  = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                  
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]))) %>% 
  ungroup() %>% 
  dplyr::mutate(`High Utilizer Status` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_county_statewide_bh_service_type_hu_table <- rbind(medicaid_jail_county_bh_service_type_hu_table, medicaid_jail_overall_bh_service_type_hu_table)

### print table via kableextra
kable(medicaid_jail_county_statewide_bh_service_type_hu_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(3, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  scroll_box(width = "130%")
```

<br>

**Mental Health Encounters**

```{r}
# By HU group
medicaid_match_mh_hu <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_overall) %>% 
  summarise(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
            `Individuals w/ MH Service Encounter, Primary Diagnosis` = `Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
            `Individuals w/out MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==0]),
            `Individuals w/out MH Service Encounter, Primary Diagnosis` = `Individuals w/out MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])
            )

# By state
medicaid_match_mh_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  summarise(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
            `Individuals w/ MH Service Encounter, Primary Diagnosis` = `Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
            `Individuals w/out MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==0]),
            `Individuals w/out MH Service Encounter, Primary Diagnosis` = `Individuals w/out MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])
            ) %>%  
  mutate(hu_group_overall = "Statewide") 

# Rbind HU group and state
medicaid_match_mh_all <- rbind(medicaid_match_mh_hu, medicaid_match_mh_state)

# Change from wide to long format
medicaid_match_mh_all <- medicaid_match_mh_all %>% 
  select(hu_group_overall,
         `Individuals w/ MH Service Encounter, Primary Diagnosis`,
         `Individuals w/out MH Service Encounter, Primary Diagnosis`) 
medicaid_match_mh_all <- gather(medicaid_match_mh_all, population, pct, `Individuals w/ MH Service Encounter, Primary Diagnosis`:`Individuals w/out MH Service Encounter, Primary Diagnosis`, factor_key=TRUE)

# Change from wide to long format
medicaid_match_mh_all <- medicaid_match_mh_all %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out MH Service Encounter, Primary Diagnosis",
                                        "Individuals w/ MH Service Encounter, Primary Diagnosis"),
                             labels = c("Individuals w/out MH Service Encounter",
                                        "Individuals w/ MH Service Encounter"))) %>% 
  mutate(pct1 = round(pct*100, 0))

PRES_gg_medicaid_mh <- ggplot(medicaid_match_mh_all, aes(x = reorder(hu_group_overall, desc(hu_group_overall)), y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_light_blue),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 10, family = "Franklin Gothic Book",
            color = case_when(medicaid_match_mh_all$population == "Individuals w/ MH Service Encounter" ~ "white",
                              TRUE ~ "black")) +
  theme_minimal() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 28, color = "black"),
        axis.text.y = element_text(size = 28, color = "black"),
        # legend.position = "right",
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 28, color = "black"))
```

```{r, out.width="50%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_mh, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_mh.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_mh.png"))
```

<br>

**Substance Use Disorder Encounters**

```{r}
# By HU group
medicaid_match_sud_hu <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_overall) %>% 
  summarise(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
            `Individuals w/ SUD Service Encounter, Primary Diagnosis` = `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
            `Individuals w/out SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==0]),
            `Individuals w/out SUD Service Encounter, Primary Diagnosis` = `Individuals w/out SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])
  )

# By state
medicaid_match_sud_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  summarise(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
            `Individuals w/ SUD Service Encounter, Primary Diagnosis` = `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
            `Individuals w/out SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==0]),
            `Individuals w/out SUD Service Encounter, Primary Diagnosis` = `Individuals w/out SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])
  ) %>%  
  mutate(hu_group_overall = "State") 

# Rbind HU group and state
medicaid_match_sud_all <- rbind(medicaid_match_sud_hu, medicaid_match_sud_state)

# Change from wide to long format
medicaid_match_sud_all <- medicaid_match_sud_all %>% 
  select(hu_group_overall,
         `Individuals w/ SUD Service Encounter, Primary Diagnosis`,
         `Individuals w/out SUD Service Encounter, Primary Diagnosis`) 
medicaid_match_sud_all <- gather(medicaid_match_sud_all, population, pct, `Individuals w/ SUD Service Encounter, Primary Diagnosis`:`Individuals w/out SUD Service Encounter, Primary Diagnosis`, factor_key=TRUE)

# Change from wide to long format
medicaid_match_sud_all <- medicaid_match_sud_all %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out SUD Service Encounter, Primary Diagnosis",
                                        "Individuals w/ SUD Service Encounter, Primary Diagnosis"),
                             labels = c("Individuals w/out SUD Service Encounter",
                                        "Individuals w/ SUD Service Encounter"))) %>% 
  mutate(pct1 = round(pct*100, 0))

PRES_gg_medicaid_sud <- ggplot(medicaid_match_sud_all, aes(x = reorder(hu_group_overall, desc(hu_group_overall)), y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_green),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 10, family = "Franklin Gothic Book",
            color = case_when(medicaid_match_sud_all$population == "Individuals w/ SUD Service Encounter" ~ "white",
                              TRUE ~ "black")) +
  theme_minimal() +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 28, color = "black"),
        axis.text.y = element_text(size = 28, color = "black"),
        # legend.position = "right",
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 28, color = "black"))
```

```{r, out.width="50%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_sud, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_sud.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_sud.png"))
```

<br><br>

### Table 1b: Mental Health and Substance Use Disorder Service Medicaid Encounters by High Utilizer Grouping

Note: Co-Occurring Disorders indicates that individual had at least one Mental Health- and one Substance Use Disorder-related primary diagnoses in the Medicaid data.

**Update**: I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during  the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")

```{r echo=FALSE,message=FALSE,warning=FALSE} 
# by hu_group_exclusive
medicaid_jail_county_bh_service_type_hu_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (%)`                         = scales::percent(n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]))) %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

# statewide
medicaid_jail_overall_bh_service_type_hu_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])/`Overall Individuals (N)`),
                   `Individuals w/ BH Encounter (%)`                         = scales::percent(n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ MH Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ MH Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ SUD Service Encounter, Primary Diagnosis (%)` = scales::percent(`Individuals w/ SUD Service Encounter, Primary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (%)` = scales::percent(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
                   
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_bh_mh_or_sud_service_secondary_dx_flag==1]),
                   `Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (%)` = scales::percent(`Individuals w/ MH or SUD Service Encounter, Secondary Diagnosis (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]))) %>% 
  ungroup() %>% 
  dplyr::mutate(`High Utilizer Percentiles` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_county_statewide_bh_service_type_hu_table <- rbind(medicaid_jail_county_bh_service_type_hu_table,
                                                                 medicaid_jail_overall_bh_service_type_hu_table)

### print table via kableextra
kable(medicaid_jail_county_statewide_bh_service_type_hu_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br>

```{r}
# BH encounters
# by HU
medicaid_match_bh <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 

  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ BH Encounter`    = n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/out BH Encounter` = n_distinct(unique_person_id[pre_or_study_bh_flag==0])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])) %>% 
  ungroup() %>% 
  select(hu_group_exclusive,
         `Individuals w/ BH Encounter`,
         `Individuals w/out BH Encounter`)

# by state
medicaid_match_bh_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ BH Encounter`    = n_distinct(unique_person_id[pre_or_study_bh_flag==1])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/out BH Encounter` = n_distinct(unique_person_id[pre_or_study_bh_flag==0])/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])) %>% 
  ungroup() %>% 
  select(`Individuals w/ BH Encounter`,
         `Individuals w/out BH Encounter`) %>% 
  mutate(hu_group_exclusive = "State")

# rbind HU group and state
medicaid_match_bh <- rbind(medicaid_match_bh, medicaid_match_bh_state)

# Change from wide to long format
medicaid_match_bh <- gather(medicaid_match_bh, population, pct, `Individuals w/ BH Encounter`:`Individuals w/out BH Encounter`, factor_key=TRUE) 
medicaid_match_bh <- medicaid_match_bh %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out BH Encounter",
                                        "Individuals w/ BH Encounter")))
  
# Stacked bar chart showing the proportion of people matched to Medicaid by hu_group_exclusive
PRES_gg_medicaid_match_bh <- ggplot(medicaid_match_bh, aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_orange),
                    na.value = "white") +
  geom_text(aes(label = ifelse(pct > .03, paste(round(pct*100, 0), "%", sep = ""), ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(medicaid_match_bh$population == "Individuals w/ BH Encounter" ~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", color = "black")) 
  #geom_hline(yintercept = mean(medicaid_match$pct), color="black", linetype='dotted', lwd=1.5)
```

```{r, out.width="75%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_match_bh, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_match_bh.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_match_bh.png"))
```
<br>

```{r}
# Cooccurring disorders
# by hu_group_exclusive
medicaid_match_cooccurring <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders` = `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/out MH and SUD Service Encounters, Co-Occurring Disorders` = 1-`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders`) %>% 
  ungroup() %>% 
  select(-`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`)

# by state
medicaid_match_cooccurring_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1 & pre_or_study_sud_service_primary_dx_flag==1]),
                   `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders` = `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`/n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/out MH and SUD Service Encounters, Co-Occurring Disorders` = 1-`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders`) %>% 
  ungroup() %>% 
  select(-`Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders (N)`) %>% 
  mutate(hu_group_exclusive = "State")

medicaid_match_cooccurring <- rbind(medicaid_match_cooccurring, medicaid_match_cooccurring_state)

# change from wide to long format
medicaid_match_cooccurring <- gather(medicaid_match_cooccurring, population, pct, `Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders`:`Individuals w/out MH and SUD Service Encounters, Co-Occurring Disorders`, factor_key=TRUE) 
medicaid_match_cooccurring <- medicaid_match_cooccurring %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out MH and SUD Service Encounters, Co-Occurring Disorders",
                                        "Individuals w/ MH and SUD Service Encounters, Co-Occurring Disorders"),
                             labels = c("Individuals w/out Co-Occurring Disorders",
                                        "Individuals w/ Co-Occurring Disorders")))

# Stacked bar chart showing the proportion of people matched to Medicaid by hu_group_exclusive
PRES_gg_medicaid_match_cooccurring <- ggplot(medicaid_match_cooccurring, aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1.3)) +
  scale_fill_manual(values=c("gray",jri_dark_blue),
                    na.value = "white") +
  geom_text(aes(label = ifelse(pct > .03, paste(round(pct*100, 0), "%", sep = ""), ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(medicaid_match_cooccurring$population == "Individuals w/ Co-Occurring Disorders" ~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book",
                                   color = "black"))
```

```{r, out.width="75%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_match_cooccurring, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_match_cooccurring.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_match_cooccurring.png"))
```

<br><br>

























































### Table 2a: Percentage of Individuals with SMI or Opioid-related Primary Diagnoses (Individual-level) by **Overall** High Utilizer Grouping

**Update**: Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample"). I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period. The following primary diagnoses are coded as "SMI" -- based on National Alliance on Mental Illness New Hampshire's definition (NAMI NH), which David shared:

*	Schizophrenia (dx_prmry_clinical_classification = "Schizophrenia and other psychotic disorders", "Schizophrenia spectrum and other psychotic disorders")

*	Bipolar Disorder (dx_prmry_clinical_classification = "Bipolar and related disorders")

*	Major Depression (dx_prmry_clinical_classification = "Depressive disorders")

*	Post-Traumatic Stress Disorder (dx_prmry_clinical_classification = "Trauma- and stressor-related disorders")

*	Borderline Personality Disorder (dx_prmry_clinical_classification = "Personality disorders")

*	Obsessive-Compulsive Disorder (dx_prmry_clinical_classification = "Obsessive-compulsive and related disorders", "Disruptive, impulse-control and conduct disorder")

*	Panic Disorder (nothing coded)

*	Phobias (nothing coded)

*	Eating Disorders (nothing coded)

*	I also included the following diagnoses because it seems like they fit within the definition: dx_prmry_clinical_classification = "Mood disorders" or "Other specified and unspecified mood disorders"


```{r echo=FALSE,message=FALSE,warning=FALSE} 
# by hu_group_exclusive
medicaid_jail_smi_opioid_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_overall) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis (%)` = scales::percent(`Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (%)` = scales::percent(`Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Status` = hu_group_overall) 

# statewide
medicaid_jail_smi_opioid_statewide <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis (%)` = scales::percent(`Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (%)` = scales::percent(`Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`High Utilizer Status` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_smi_opioid_hu_grouping_statewide_table <- rbind(medicaid_jail_smi_opioid_hu_grouping,
                                                               medicaid_jail_smi_opioid_statewide)

### print table via kableextra
kable(medicaid_jail_smi_opioid_hu_grouping_statewide_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(3, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br><br>

### Table 2b: Percentage of Individuals with SMI or Opioid-related Primary Diagnoses (Individual-level)

**Update**: Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample"). I am currently using all behavioral health data from the Medicaid Encounter file that occurred either before or during the study period. The following primary diagnoses are coded as "SMI" -- based on National Alliance on Mental Illness New Hampshire's definition (NAMI NH), which David shared:

*	Schizophrenia (dx_prmry_clinical_classification = "Schizophrenia and other psychotic disorders", "Schizophrenia spectrum and other psychotic disorders")

*	Bipolar Disorder (dx_prmry_clinical_classification = "Bipolar and related disorders")

*	Major Depression (dx_prmry_clinical_classification = "Depressive disorders")

*	Post-Traumatic Stress Disorder (dx_prmry_clinical_classification = "Trauma- and stressor-related disorders")

*	Borderline Personality Disorder (dx_prmry_clinical_classification = "Personality disorders")

*	Obsessive-Compulsive Disorder (dx_prmry_clinical_classification = "Obsessive-compulsive and related disorders", "Disruptive, impulse-control and conduct disorder")

*	Panic Disorder (nothing coded)

*	Phobias (nothing coded)

*	Eating Disorders (nothing coded)

*	I also included the following diagnoses because it seems like they fit within the definition: dx_prmry_clinical_classification = "Mood disorders" or "Other specified and unspecified mood disorders"

```{r echo=FALSE,message=FALSE,warning=FALSE} 
# by hu_group_exclusive
medicaid_jail_smi_opioid_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis (%)` = scales::percent(`Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (%)` = scales::percent(`Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

# statewide
medicaid_jail_smi_opioid_statewide <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any Medicaid Match (% of Overall Sample)` = scales::percent(`Individuals w/ any Medicaid Match (N)`/`Overall Individuals (N)`),
                   
                   `Individuals w/ BH Encounter (N)` = n_distinct(unique_person_id[pre_or_study_mh_service_primary_dx_flag==1]),
                   `Individuals w/ BH Encounter (%)` = scales::percent(`Individuals w/ BH Encounter (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis (%)` = scales::percent(`Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`),
                   
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (%)` = scales::percent(`Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`)) %>% 
  dplyr::mutate(`High Utilizer Percentiles` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_smi_opioid_hu_grouping_statewide_table <- rbind(medicaid_jail_smi_opioid_hu_grouping,
                                                               medicaid_jail_smi_opioid_statewide)

### print table via kableextra
kable(medicaid_jail_smi_opioid_hu_grouping_statewide_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br>

**High utilizers were more likely to have a serious mental illness (SMI) than non-high utilizers.**

```{r}
# # by hu_group_exclusive
# medicaid_jail_smi_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
#   dplyr::group_by(hu_group_exclusive) %>% 
#   dplyr::summarise(`Individuals w/ any Medicaid Match` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
#                    `Individuals w/ SMI Primary Diagnosis` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
#                    `Individuals w/out SMI Primary Diagnosis` = `Individuals w/ any Medicaid Match`-`Individuals w/ SMI Primary Diagnosis`,
#                    pct = `Individuals w/ SMI Primary Diagnosis`/`Individuals w/ any Medicaid Match`) %>% 
#   ungroup() %>% 
#   select(-`Individuals w/ any Medicaid Match`) %>% 
#   filter(hu_group_exclusive != "Non-HU")
# 
# # change from wide to long format
# medicaid_jail_smi_hu_grouping <- gather(medicaid_jail_smi_hu_grouping, population, total, `Individuals w/ SMI Primary Diagnosis`:`Individuals w/out SMI Primary Diagnosis`, factor_key=TRUE) 
# medicaid_jail_smi_hu_grouping <- medicaid_jail_smi_hu_grouping %>% 
#   mutate(population = factor(population, 
#                              levels = c("Individuals w/out SMI Primary Diagnosis",
#                                         "Individuals w/ SMI Primary Diagnosis"),
#                              labels = c("Individuals w/out SMI Primary Diagnosis",
#                                         "Individuals w/ SMI Primary Diagnosis")))
# 
# PRES_gg_medicaid_jail_smi_hu_grouping <- ggplot(medicaid_jail_smi_hu_grouping, aes(fill=population, y=total, x=hu_group_exclusive)) + 
#     geom_bar(position="stack", stat="identity") +
#     geom_text(aes(label = ifelse(medicaid_jail_smi_hu_grouping$population == "Individuals w/ SMI Primary Diagnosis", paste0(round(pct*100, 0), "%", sep = ""), "")),
#               position = position_stack(vjust = .5),
#               size = 7.5, family = "Franklin Gothic Book",
#               color = "white",
#               fontface = "bold") + 
#     scale_fill_manual(values=c("gray",jri_orange),
#                     na.value = "white") +
#     scale_y_continuous(labels = label_number(big.mark = ",")) +
#     xlab("") + ylab("Number of Individuals\n Matched to Medicaid") +
#     theme_with_grid_with_labels +
#     theme(legend.justification = c(0.5, 0.5),
#           legend.direction = "vertical",
#           legend.box = "horizontal",
#           legend.position = "bottom",
#           legend.title=element_blank(),
#           legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
# ggsave(PRES_gg_medicaid_jail_smi_hu_grouping, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_hu_grouping.png"), width = 7,  height = 6, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_hu_grouping.png"))
```

```{r}
# # by non-HU
# medicaid_jail_smi_nonhu <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
#   dplyr::group_by(hu_group_exclusive) %>% 
#   dplyr::summarise(`Individuals w/ any Medicaid Match` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
#                    `Individuals w/ SMI Primary Diagnosis` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
#                    `Individuals w/out SMI Primary Diagnosis` = `Individuals w/ any Medicaid Match`-`Individuals w/ SMI Primary Diagnosis`,
#                    pct = `Individuals w/ SMI Primary Diagnosis`/`Individuals w/ any Medicaid Match`) %>% 
#   ungroup() %>% 
#   select(-`Individuals w/ any Medicaid Match`) %>% 
#   filter(hu_group_exclusive == "Non-HU")
# 
# # change from wide to long format
# medicaid_jail_smi_nonhu <- gather(medicaid_jail_smi_nonhu, population, total, `Individuals w/ SMI Primary Diagnosis`:`Individuals w/out SMI Primary Diagnosis`, factor_key=TRUE) 
# medicaid_jail_smi_nonhu <- medicaid_jail_smi_nonhu %>% 
#   mutate(population = factor(population, 
#                              levels = c("Individuals w/out SMI Primary Diagnosis",
#                                         "Individuals w/ SMI Primary Diagnosis"),
#                              labels = c("Individuals w/out SMI Primary Diagnosis",
#                                         "Individuals w/ SMI Primary Diagnosis")))
# 
# PRES_gg_medicaid_jail_smi_nonhu <- ggplot(medicaid_jail_smi_nonhu, aes(fill=population, y=total, x=hu_group_exclusive)) + 
#     geom_bar(position="stack", stat="identity") +
#     geom_text(aes(label = ifelse(medicaid_jail_smi_nonhu$population == "Individuals w/ SMI Primary Diagnosis", paste0(round(pct*100, 0), "%", sep = ""), "")),
#               position = position_stack(vjust = .5),
#               size = 7.5, family = "Franklin Gothic Book",
#               color = "white",
#               fontface = "bold") + 
#     scale_fill_manual(values=c("gray",jri_orange),
#                     na.value = "white") +
#     scale_y_continuous(labels = label_number(big.mark = ",")) +
#     xlab("") + ylab("Number of Individuals\n Matched to Medicaid") +
#     theme_with_grid_with_labels +
#     theme(legend.position = "none",
#           legend.title=element_blank(),
#           legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
# ggsave(PRES_gg_medicaid_jail_smi_nonhu, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_nonhu.png"), width = 4,  height = 6, dpi = 100)
#knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_nonhu.png"))
```

```{r, echo=FALSE, fig.align='center'}
# knitr::include_graphics(c(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_hu_grouping.png",paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_nonhu.png"))
```

```{r}
# Proportion of people with SMI
# by hu_group_exclusive
medicaid_jail_smi_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis` = `Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out SMI Primary Diagnosis` = 1-`Individuals w/ SMI Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ SMI Primary Diagnosis (N)`))

# by state
medicaid_jail_smi_hu_grouping_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis` = `Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out SMI Primary Diagnosis` = 1-`Individuals w/ SMI Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ SMI Primary Diagnosis (N)`)) %>% 
  mutate(hu_group_exclusive = "State")

# add data together
medicaid_jail_smi_hu_grouping <- rbind(medicaid_jail_smi_hu_grouping, medicaid_jail_smi_hu_grouping_state)

# change from wide to long format
medicaid_jail_smi_hu_grouping <- gather(medicaid_jail_smi_hu_grouping, population, pct, `Individuals w/ SMI Primary Diagnosis`:`Individuals w/out SMI Primary Diagnosis`, factor_key=TRUE) 
medicaid_jail_smi_hu_grouping <- medicaid_jail_smi_hu_grouping %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out SMI Primary Diagnosis",
                                        "Individuals w/ SMI Primary Diagnosis"),
                             labels = c("Individuals w/out SMI Primary Diagnosis",
                                        "Individuals w/ SMI Primary Diagnosis")))


PRES_gg_medicaid_jail_smi_hu_grouping1 <- 
  ggplot(medicaid_jail_smi_hu_grouping,
         aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_orange),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(medicaid_jail_smi_hu_grouping$population == "Individuals w/ SMI Primary Diagnosis"~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_jail_smi_hu_grouping1, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_hu_grouping1.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_hu_grouping1.png"))
```

<br>

```{r}
# Proportion of people with SMI
# by county
medicaid_jail_smi_county <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis` = `Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out SMI Primary Diagnosis` = 1-`Individuals w/ SMI Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ SMI Primary Diagnosis (N)`))

# by state
medicaid_jail_smi_county_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ SMI Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_smi_flag==1]),
                   `Individuals w/ SMI Primary Diagnosis` = `Individuals w/ SMI Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out SMI Primary Diagnosis` = 1-`Individuals w/ SMI Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ SMI Primary Diagnosis (N)`)) %>% 
  mutate(county = "State")

# add data together
medicaid_jail_smi_county <- rbind(medicaid_jail_smi_county, medicaid_jail_smi_county_state)

# change from wide to long format
medicaid_jail_smi_county <- gather(medicaid_jail_smi_county, population, pct, `Individuals w/ SMI Primary Diagnosis`:`Individuals w/out SMI Primary Diagnosis`, factor_key=TRUE) 
medicaid_jail_smi_county <- medicaid_jail_smi_county %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out SMI Primary Diagnosis",
                                        "Individuals w/ SMI Primary Diagnosis"),
                             labels = c("Individuals w/out SMI Primary Diagnosis",
                                        "Individuals w/ SMI Primary Diagnosis")))

# Stacked bar chart showing the proportion of people with SMI by county
PRES_gg_medicaid_jail_smi_county <- ggplot(medicaid_jail_smi_county, aes(x = county, y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("gray",jri_orange),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 10, family = "Franklin Gothic Book",
            color = case_when(medicaid_jail_smi_county$population == "Individuals w/ SMI Primary Diagnosis" ~ "white",
                              TRUE ~ "black")) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 0.85, size = 28, color = "black"),
        axis.text.y = element_text(size = 28, color = "black"),
        legend.title=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.text = element_text(family = "Franklin Gothic Book", size = 28, color = "black"))
```

```{r, out.width="75%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_jail_smi_county, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_county.png"), width = 9,  height = 7, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_smi_county.png"))
```

<br><br>

**High utilizers were more likely to have a an opioid-related primary diagnosis than non-high utilizers.**

```{r}
# # Proportion of people with opioid-related primary diagnosis
# # by hu_group_exclusive
# medicaid_jail_opioid_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
#   dplyr::group_by(hu_group_exclusive) %>% 
#   dplyr::summarise(`Individuals w/ any Medicaid Match` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
#                    `Individuals w/ Opioid-related Primary Diagnosis` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
#                    `Individuals w/out Opioid-related Primary Diagnosis` = `Individuals w/ any Medicaid Match` - `Individuals w/ Opioid-related Primary Diagnosis`,
#                    `pct` = `Individuals w/ Opioid-related Primary Diagnosis`/`Individuals w/ any Medicaid Match`) %>% 
#   ungroup() %>% 
#   select(-`Individuals w/ any Medicaid Match`) %>% 
#   filter(hu_group_exclusive != "Non-HU")
# # change from wide to long format
# medicaid_jail_opioid_hu_grouping <- gather(medicaid_jail_opioid_hu_grouping, population, total, `Individuals w/ Opioid-related Primary Diagnosis`:`Individuals w/out Opioid-related Primary Diagnosis`, factor_key=TRUE) 
# medicaid_jail_opioid_hu_grouping <- medicaid_jail_opioid_hu_grouping %>% 
#   mutate(population = factor(population, 
#                              levels = c("Individuals w/out Opioid-related Primary Diagnosis",
#                                         "Individuals w/ Opioid-related Primary Diagnosis"),
#                              labels = c("Individuals w/out Opioid-related Primary Diagnosis",
#                                         "Individuals w/ Opioid-related Primary Diagnosis")))
# PRES_gg_medicaid_jail_opioid_hu_grouping <- ggplot(medicaid_jail_opioid_hu_grouping, aes(fill=population, y=total, x=hu_group_exclusive)) + 
#     geom_bar(position="stack", stat="identity") +
#     geom_text(aes(label = ifelse(medicaid_jail_opioid_hu_grouping$population == "Individuals w/ Opioid-related Primary Diagnosis", paste0(round(pct*100, 0), "%", sep = ""), "")),
#               position = position_stack(vjust = .5),
#               size = 7.5, family = "Franklin Gothic Book",
#               color = "white",
#               fontface = "bold") + 
#     scale_fill_manual(values=c("gray",jri_green),
#                     na.value = "white") +
#     # expand_limits(y = 1400) +
#     scale_y_continuous(labels = label_number(big.mark = ",")) +
#     xlab("") + ylab("Number of Individuals\n Matched to Medicaid") +
#     theme_with_grid_with_labels +
#     theme(legend.justification = c(0.85, 0.5),
#           legend.direction = "vertical",
#           legend.box = "horizontal",
#           legend.position = "bottom",
#           legend.title=element_blank(),
#           legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
# ggsave(PRES_gg_medicaid_jail_opioid_hu_grouping, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_hu_grouping.png"), width = 7,  height = 6, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_hu_grouping.png"))
```

```{r}
# # by hu_group_exclusive
# medicaid_jail_opioid_nonhu <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
#   dplyr::group_by(hu_group_exclusive) %>% 
#   dplyr::summarise(`Individuals w/ any Medicaid Match` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
#                    `Individuals w/ Opioid-related Primary Diagnosis` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
#                    `Individuals w/out Opioid-related Primary Diagnosis` = `Individuals w/ any Medicaid Match` - `Individuals w/ Opioid-related Primary Diagnosis`,
#                    `pct` = `Individuals w/ Opioid-related Primary Diagnosis`/`Individuals w/ any Medicaid Match`) %>% 
#   ungroup() %>% 
#   select(-`Individuals w/ any Medicaid Match`) %>% 
#   filter(hu_group_exclusive == "Non-HU")
# 
# # change from wide to long format
# medicaid_jail_opioid_nonhu <- gather(medicaid_jail_opioid_nonhu, population, total, `Individuals w/ Opioid-related Primary Diagnosis`:`Individuals w/out Opioid-related Primary Diagnosis`, factor_key=TRUE) 
# medicaid_jail_opioid_nonhu <- medicaid_jail_opioid_nonhu %>% 
#   mutate(population = factor(population, 
#                              levels = c("Individuals w/out Opioid-related Primary Diagnosis",
#                                         "Individuals w/ Opioid-related Primary Diagnosis"),
#                              labels = c("Individuals w/out Opioid-related Primary Diagnosis",
#                                         "Individuals w/ Opioid-related Primary Diagnosis")))
# PRES_gg_medicaid_jail_opioid_nonhu <- ggplot(medicaid_jail_opioid_nonhu, aes(fill=population, y=total, x=hu_group_exclusive)) + 
#     geom_bar(position="stack", stat="identity") +
#     geom_text(aes(label = ifelse(medicaid_jail_opioid_nonhu$population == "Individuals w/ Opioid-related Primary Diagnosis", paste0(round(pct*100, 0), "%", sep = ""), "")),
#               position = position_stack(vjust = .5),
#               size = 7.5, family = "Franklin Gothic Book",
#               color = "white",
#               fontface = "bold") + 
#     scale_fill_manual(values=c("gray",jri_green),
#                     na.value = "white") +
#     # expand_limits(y = 1400) +
#     scale_y_continuous(labels = label_number(big.mark = ",")) +
#     xlab("") + ylab("Number of Individuals\n Matched to Medicaid") +
#     theme_with_grid_with_labels +
#     theme(legend.position = "none",
#           legend.title=element_blank(),
#           legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
# ggsave(PRES_gg_medicaid_jail_opioid_nonhu, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_nonhu.png"), width = 4,  height = 6, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_nonhu.png"))
```

```{r, echo=FALSE, fig.align='center'}
# knitr::include_graphics(c(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_hu_grouping.png"),paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_nonhu.png")))
```

```{r}
# proportion of opioid-related primary diagnosis claims 
# by hu_group_exclusive
medicaid_jail_opioid_hu_grouping <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis` = `Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out Opioid-related Primary Diagnosis` = 1-`Individuals w/ Opioid-related Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ Opioid-related Primary Diagnosis (N)`))

# by state
medicaid_jail_opioid_hu_grouping_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis` = `Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out Opioid-related Primary Diagnosis` = 1-`Individuals w/ Opioid-related Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ Opioid-related Primary Diagnosis (N)`)) %>% 
  mutate(hu_group_exclusive = "State")

# add data together
medicaid_jail_opioid_hu_grouping <- rbind(medicaid_jail_opioid_hu_grouping, medicaid_jail_opioid_hu_grouping_state)

# change from wide to long format
medicaid_jail_opioid_hu_grouping <- gather(medicaid_jail_opioid_hu_grouping, population, pct, `Individuals w/ Opioid-related Primary Diagnosis`:`Individuals w/out Opioid-related Primary Diagnosis`, factor_key=TRUE) 
medicaid_jail_opioid_hu_grouping <- medicaid_jail_opioid_hu_grouping %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out Opioid-related Primary Diagnosis",
                                        "Individuals w/ Opioid-related Primary Diagnosis"),
                             labels = c("Individuals w/out Opioid-related Primary Diagnosis",
                                        "Individuals w/ Opioid-related Primary Diagnosis")))

PRES_gg_medicaid_jail_opioid1 <- 
  ggplot(medicaid_jail_opioid_hu_grouping,
         aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_green),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(medicaid_jail_opioid_hu_grouping$population == "Individuals w/ Opioid-related Primary Diagnosis" ~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        # legend.position = "right",
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_jail_opioid1, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid1.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid1.png"))
```

<br>

```{r}
# proportion of opioid-related primary diagnosis claims 
# by county
medicaid_jail_opioid_county <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis` = `Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out Opioid-related Primary Diagnosis` = 1-`Individuals w/ Opioid-related Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ Opioid-related Primary Diagnosis (N)`))

# by state
medicaid_jail_opioid_county_state <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ any Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis (N)` = n_distinct(unique_person_id[pre_or_study_opioid_related_flag==1]),
                   `Individuals w/ Opioid-related Primary Diagnosis` = `Individuals w/ Opioid-related Primary Diagnosis (N)`/`Individuals w/ any Medicaid Match (N)`,
                   `Individuals w/out Opioid-related Primary Diagnosis` = 1-`Individuals w/ Opioid-related Primary Diagnosis`) %>% 
  ungroup() %>% 
  select(-c(`Individuals w/ any Medicaid Match (N)`,
            `Individuals w/ Opioid-related Primary Diagnosis (N)`)) %>% 
  mutate(county = "State")

# add data together
medicaid_jail_opioid_county <- rbind(medicaid_jail_opioid_county, medicaid_jail_opioid_county_state)

# change from wide to long format
medicaid_jail_opioid_county <- gather(medicaid_jail_opioid_county, population, pct, `Individuals w/ Opioid-related Primary Diagnosis`:`Individuals w/out Opioid-related Primary Diagnosis`, factor_key=TRUE) 
medicaid_jail_opioid_county <- medicaid_jail_opioid_county %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out Opioid-related Primary Diagnosis",
                                        "Individuals w/ Opioid-related Primary Diagnosis"),
                             labels = c("Individuals w/out Opioid-related Primary Diagnosis",
                                        "Individuals w/ Opioid-related Primary Diagnosis")))

# Stacked bar chart showing the proportion of people with opioid by county
PRES_gg_medicaid_jail_opioid_county <- ggplot(medicaid_jail_opioid_county, aes(x = county, y = pct, fill = population)) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("gray",jri_green),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 10, family = "Franklin Gothic Book",
            color = case_when(medicaid_jail_opioid_county$population == "Individuals w/ Opioid-related Primary Diagnosis" ~ "white",
                              TRUE ~ "black")) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 0.85, size = 28, color = "black"),
        axis.text.y = element_text(size = 28, color = "black"),
        legend.title=element_blank(),
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.text = element_text(family = "Franklin Gothic Book", size = 28, color = "black"))
```

```{r, out.width="75%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_jail_opioid_county, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_county.png"), width = 9,  height = 7, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_jail_opioid_county.png"))
```


<br><br>

# Trends for Medicaid Claims (FY2019-2021) 

### Common primary diagnoses for Medicaid claims between FY2019-2021.

Most of the Medicaid claims were for opioid-related disorders.  

```{r}
# Find top primary diagnoses and the proportion of claims for each
top_primary_diagnoses_grouped <- medicaid_encounters_cleaned_2018_2021 %>% 
  group_by(dx_prmry_clinical_classification_new) %>% 
  summarise(total_claims = n_distinct(claim_id)) %>% 
  ungroup() %>% 
  mutate(pct_claims = (total_claims/sum(total_claims))*100,
         pct_claims = round(pct_claims, 0),
         pct_claims = paste0(pct_claims, "%", sep = ""),
         pct_claims = case_when(pct_claims == "0%" ~ "<0%", TRUE ~ pct_claims)) %>% 
  arrange(pct_claims)

PRES_gg_medicaid_top_diagnoses <- top_primary_diagnoses_grouped %>%
  ggplot(aes(x = reorder(dx_prmry_clinical_classification_new, total_claims), 
             y = total_claims, fill=factor(ifelse(dx_prmry_clinical_classification_new=="Opioid-related disorders","Highlighted","Normal")))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "area", values=c(jri_green,"gray")) +
      geom_text(aes(label = comma(total_claims), fontface = 'bold'
                    ), 
                color = ifelse(top_primary_diagnoses_grouped$dx_prmry_clinical_classification_new=="Opioid-related disorders", jri_green, "black"), 
                hjust = -.1, size = 7.5, family = "Franklin Gothic Book") +
  xlab("") + ylab("\nNumber of Claims") +
  scale_y_continuous(labels = label_number(suffix = "k", scale = 1e-3, big.mark = ","),
                     expand = c(0,0),
                     limits = c(0,350000),
                     breaks=c(0, 50000, 100000, 150000, 200000, 250000, 300000)) +
  coord_flip() +
  theme_no_grid_no_labels +
  theme(legend.position = "none",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"),
        
        panel.grid.major.x = element_line(linewidth = 0.5),
        axis.text.y = element_text(face = c("plain", "plain", "plain", "plain", "plain", "plain", "plain",  "plain", "bold"), 
                                   color = c( "black","black","black","black","black","black","black","black","#557e39" )),

        axis.title   = element_text(size = 22, color = "black"),
        axis.title.y = element_text(size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        # axis.text.y  = element_text(size = 22, color = "black"),
        axis.text.x  = element_text(size = 22, color = "black"))
```

```{r, out.width="150%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_top_diagnoses, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_top_diagnoses.png"), width = 12,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_top_diagnoses.png"))
```







<br><br>

### Common primary diagnoses for SMI-related disorders Medicaid claims between FY2019-2021.

The majority of SMI-related Medicaid claims were for schizophrenia spectrum and other psychotic disorders.  

```{r}
# Find top primary diagnoses and the proportion of claims for each
smi_primary_diagnoses <- medicaid_encounters_cleaned_2018_2021 %>% 
  filter(dx_prmry_clinical_classification_new == "SMI-related disorders") %>% 
  group_by(dx_prmry_clinical_classification) %>% 
  summarise(total_claims = n_distinct(claim_id)) %>% 
  ungroup() %>% 
  mutate(pct_claims = (total_claims/sum(total_claims))*100,
         pct_claims = round(pct_claims, 0),
         pct_claims = paste0(pct_claims, "%", sep = ""),
         pct_claims = case_when(pct_claims == "0%" ~ "<0%", TRUE ~ pct_claims)) %>% 
  arrange(total_claims)

# Which labels to bold and color
bold.labels <- smi_primary_diagnoses %>% 
  mutate(bold = ifelse(dx_prmry_clinical_classification == "Schizophrenia spectrum and other psychotic disorders", yes = "bold", no = "plain"))
bold.labels <- bold.labels$bold
color.labels <- smi_primary_diagnoses %>% 
  mutate(color = ifelse(dx_prmry_clinical_classification == "Schizophrenia spectrum and other psychotic disorders", yes = jri_orange, no = "black"))
color.labels <- color.labels$color

PRES_gg_medicaid_smi_primary_diagnoses <- smi_primary_diagnoses %>%
  ggplot(aes(x = reorder(dx_prmry_clinical_classification, total_claims), 
             y = total_claims, fill=factor(ifelse(dx_prmry_clinical_classification=="Schizophrenia spectrum and other psychotic disorders","Highlighted","Normal")))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(name = "area", values=c(jri_orange,"gray")) +
      geom_text(aes(label = comma(total_claims), fontface = 'bold'
                    ), 
                color = ifelse(smi_primary_diagnoses$dx_prmry_clinical_classification=="Schizophrenia spectrum and other psychotic disorders", jri_orange, "black"), 
                hjust = -.1, size = 7.5, family = "Franklin Gothic Book") +
  xlab("") + ylab("\nNumber of Claims") +
  scale_y_continuous(labels = label_number(suffix = "k", scale = 1e-3, big.mark = ","),
                     expand = c(0,0),
                     limits = c(0,45000),
                     breaks=c(0, 10000, 20000, 30000, 40000)) +
  coord_flip() +
  theme_no_grid_no_labels +
  theme(legend.position = "none",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 22, color = "black"),
        
        panel.grid.major.x = element_line(linewidth = 0.5),
        axis.text.y = element_text(face = bold.labels, color = color.labels),

        axis.title   = element_text(size = 22, color = "black"),
        axis.title.y = element_text(size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        # axis.text.y  = element_text(size = 22, color = "black"),
        axis.text.x  = element_text(size = 22, color = "black"))

```
```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_medicaid_smi_primary_diagnoses, file=paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_smi_primary_diagnoses.png"), width = 12,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_medicaid_smi_primary_diagnoses.png"))
```

<br>

Of those with a history of SMI, high utilizers were more likely to have a primary diagnosis claim for schizophrenia spectrum and other psychotic disorders compared to non-high utilizers.  

```{r}
# Find top primary diagnoses and the proportion of claims for each
# by hu_group_overall
smi_primary_diagnoses_hu <- medicaid_encounters_cleaned_2018_2021 %>% 
    filter(dx_prmry_clinical_classification_new == "SMI-related disorders") %>% 
    group_by(hu_group_overall) %>% 
    summarise(`Individuals w/ SMI (N)` = n_distinct(unique_person_id[dx_prmry_clinical_classification_new == "SMI-related disorders"]),
              
              `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Schizophrenia spectrum and other psychotic disorders"]),
              `Individuals w/ schizophrenia spectrum and other psychotic disorders (%)`= `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ depressive disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Depressive disorders"]),
              `Individuals w/ depressive disorders (%)`= `Individuals w/ depressive disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ bipolar and related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Bipolar and related disorders"]),
              `Individuals w/ bipolar and related disorders (%)`= `Individuals w/ bipolar and related disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ trauma- and stressor-related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Trauma- and stressor-related disorders"]),
              `Individuals w/ trauma- and stressor-related disorders (%)`= `Individuals w/ trauma- and stressor-related disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ personality disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Personality disorders"]),
              `Individuals w/ personality disorders (%)`= `Individuals w/ personality disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ other specified and unspecified mood disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Other specified and unspecified mood disorders"]),
              `Individuals w/ other specified and unspecified mood disorders (%)`= `Individuals w/ other specified and unspecified mood disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ obsessive-compulsive and related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Obsessive-compulsive and related disorders"]),
              `Individuals w/ obsessive-compulsive and related disorders (%)`= `Individuals w/ obsessive-compulsive and related disorders (N)`/`Individuals w/ SMI (N)`
              ) %>% 
  select(-c(
    `Individuals w/ SMI (N)`,
    `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)`,
    `Individuals w/ depressive disorders (N)`,
    `Individuals w/ bipolar and related disorders (N)`,
    `Individuals w/ trauma- and stressor-related disorders (N)`,
    `Individuals w/ personality disorders (N)`,
    `Individuals w/ other specified and unspecified mood disorders (N)`,
    `Individuals w/ obsessive-compulsive and related disorders (N)`
  ))

# change from wide to long format
# factor level for ggplot bar order
smi_primary_diagnoses_hu <- gather(smi_primary_diagnoses_hu, diagnosis, pct, `Individuals w/ schizophrenia spectrum and other psychotic disorders (%)`:`Individuals w/ obsessive-compulsive and related disorders (%)`, factor_key=TRUE)
smi_primary_diagnoses_hu <- smi_primary_diagnoses_hu %>%
  mutate(pct = round(pct*100, 0),
         hu_group_overall = as.character(hu_group_overall),
         diagnosis = factor(diagnosis,
                            levels = c(
                                      "Individuals w/ obsessive-compulsive and related disorders (%)",
                                      "Individuals w/ other specified and unspecified mood disorders (%)",
                                      "Individuals w/ personality disorders (%)",
                                      "Individuals w/ bipolar and related disorders (%)",
                                      "Individuals w/ schizophrenia spectrum and other psychotic disorders (%)",
                                      "Individuals w/ trauma- and stressor-related disorders (%)",
                                      "Individuals w/ depressive disorders (%)"),
                            labels = c(
                                      "Individuals w/ obsessive-compulsive and related disorders",
                                      "Individuals w/ other specified and unspecified mood disorders",
                                      "Individuals w/ personality disorders",
                                      "Individuals w/ bipolar and related disorders",
                                      "Individuals w/ schizophrenia spectrum and other psychotic disorders",
                                      "Individuals w/ trauma- and stressor-related disorders",
                                      "Individuals w/ depressive disorders"
                            )
                            )
         ) 

# Which labels to bold
bold.labels <- smi_primary_diagnoses_hu %>% filter(hu_group_overall == "High Utilizer") %>% arrange(pct) %>% 
  mutate(bold = ifelse(diagnosis == "Individuals w/ schizophrenia spectrum and other psychotic disorders", yes = "bold", no = "plain"))
bold.labels <- bold.labels$bold

# ggplot diverging barchart showing the average and media cost of reimbursement for the diagnosis categories
PRES_gg_smi_primary_diagnoses_hu <- smi_primary_diagnoses_hu %>%
  mutate(pct = ifelse(hu_group_overall == "High Utilizer", pct, -1*pct)) %>% 
  ggplot(aes(x = diagnosis, y = pct, fill = hu_group_overall))+
  geom_bar(stat = "identity") +
  labs(x = "", y = "Proportion of Individuals\n(Out of those with an SMI)") +
 geom_text(aes(label = paste0(abs(pct), "%")),
            size = 7.5, family = "Franklin Gothic Book",
            hjust = ifelse(smi_primary_diagnoses_hu$hu_group_overall == "High Utilizer", -.1, 1.1),
            color = ifelse(smi_primary_diagnoses_hu$hu_group_overall == "High Utilizer", jri_orange, "black"),
            fontface = "bold"
              ) +
  scale_y_continuous(limits = c(-100, 100)) +
  scale_fill_manual(values=c(jri_orange, "gray")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(face = c("plain", "plain", "plain", "plain", "bold", 
                                            "plain", "plain", "plain", "plain", "plain", "plain")),
        axis.title.y = element_text(angle = 90, size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top",
        legend.justification = c(0.5, 0),
        legend.title=element_blank())

```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_smi_primary_diagnoses_hu, file=paste0(sp_data_path, "analysis/img/PRES_gg_smi_primary_diagnoses_hu.png"), width = 14,  height = 7, dpi = 100, bg = 'transparent')
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_smi_primary_diagnoses_hu.png"))
```

```{r}
# Find top SMI primary diagnoses and the proportion of people for each
# by hu_group_overall
smi_primary_diagnoses_hu <- medicaid_encounters_cleaned_2018_2021 %>% 
    filter(dx_prmry_clinical_classification_new == "SMI-related disorders") %>% 
    group_by(hu_group_exclusive) %>% 
    summarise(`Individuals w/ SMI (N)` = n_distinct(unique_person_id[dx_prmry_clinical_classification_new == "SMI-related disorders"]),
              
              `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Schizophrenia spectrum and other psychotic disorders"]),
              `Individuals w/ schizophrenia spectrum and other psychotic disorders (%)`= `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ depressive disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Depressive disorders"]),
              `Individuals w/ depressive disorders (%)`= `Individuals w/ depressive disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ bipolar and related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Bipolar and related disorders"]),
              `Individuals w/ bipolar and related disorders (%)`= `Individuals w/ bipolar and related disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ trauma- and stressor-related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Trauma- and stressor-related disorders"]),
              `Individuals w/ trauma- and stressor-related disorders (%)`= `Individuals w/ trauma- and stressor-related disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ personality disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Personality disorders"]),
              `Individuals w/ personality disorders (%)`= `Individuals w/ personality disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ other specified and unspecified mood disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Other specified and unspecified mood disorders"]),
              `Individuals w/ other specified and unspecified mood disorders (%)`= `Individuals w/ other specified and unspecified mood disorders (N)`/`Individuals w/ SMI (N)`,
              
              `Individuals w/ obsessive-compulsive and related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Obsessive-compulsive and related disorders"]),
              `Individuals w/ obsessive-compulsive and related disorders (%)`= `Individuals w/ obsessive-compulsive and related disorders (N)`/`Individuals w/ SMI (N)`
              ) %>% 
  select(-c(
    `Individuals w/ SMI (N)`,
    `Individuals w/ schizophrenia spectrum and other psychotic disorders (N)`,
    `Individuals w/ depressive disorders (N)`,
    `Individuals w/ bipolar and related disorders (N)`,
    `Individuals w/ trauma- and stressor-related disorders (N)`,
    `Individuals w/ personality disorders (N)`,
    `Individuals w/ other specified and unspecified mood disorders (N)`,
    `Individuals w/ obsessive-compulsive and related disorders (N)`
  )) %>% 
  filter(hu_group_exclusive == "Tier 1 HU" | hu_group_exclusive == "Non-HU")

# change from wide to long format
# factor level for ggplot bar order
smi_primary_diagnoses_hu <- gather(smi_primary_diagnoses_hu, diagnosis, pct, `Individuals w/ schizophrenia spectrum and other psychotic disorders (%)`:`Individuals w/ obsessive-compulsive and related disorders (%)`, factor_key=TRUE)
smi_primary_diagnoses_hu <- smi_primary_diagnoses_hu %>%
  mutate(pct = round(pct*100, 0),
         hu_group_exclusive = as.character(hu_group_exclusive),
         diagnosis = factor(diagnosis,
                            levels = c(
                                      "Individuals w/ obsessive-compulsive and related disorders (%)",
                                      "Individuals w/ other specified and unspecified mood disorders (%)",
                                      "Individuals w/ personality disorders (%)",
                                      "Individuals w/ bipolar and related disorders (%)",
                                      "Individuals w/ schizophrenia spectrum and other psychotic disorders (%)",
                                      "Individuals w/ trauma- and stressor-related disorders (%)",
                                      "Individuals w/ depressive disorders (%)"),
                            labels = c(
                                      "Individuals w/ obsessive-compulsive and related disorders",
                                      "Individuals w/ other specified and unspecified mood disorders",
                                      "Individuals w/ personality disorders",
                                      "Individuals w/ bipolar and related disorders",
                                      "Individuals w/ schizophrenia spectrum and other psychotic disorders",
                                      "Individuals w/ trauma- and stressor-related disorders",
                                      "Individuals w/ depressive disorders"
                            )
                            )
         ) 

# Which labels to bold
bold.labels <- smi_primary_diagnoses_hu %>% filter(hu_group_exclusive == "Tier 1 HU") %>% arrange(pct) %>% 
  mutate(bold = ifelse(diagnosis == "Individuals w/ schizophrenia spectrum and other psychotic disorders", yes = "bold", no = "plain"))
bold.labels <- bold.labels$bold

# ggplot diverging barchart showing the average and media cost of reimbursement for the diagnosis categories
PRES_gg_smi_primary_diagnoses_tier1hu <- smi_primary_diagnoses_hu %>%
  mutate(pct = ifelse(hu_group_exclusive == "Tier 1 HU", pct, -1*pct),
         hu_group_exclusive = factor(hu_group_exclusive, levels = c("Tier 1 HU","Non-HU"
                                                                  ))) %>% 
  ggplot(aes(x = diagnosis, y = pct, fill = hu_group_exclusive))+
  geom_bar(stat = "identity") +
  labs(x = "", y = "Proportion of Individuals\n(Out of those with an SMI)") +
 geom_text(aes(label = paste0(abs(pct), "%")),
            size = 7.5, family = "Franklin Gothic Book",
            hjust = ifelse(smi_primary_diagnoses_hu$hu_group_exclusive == "Tier 1 HU", -.1, 1.1),
            color = ifelse(smi_primary_diagnoses_hu$hu_group_exclusive == "Tier 1 HU", jri_light_blue, "black"),
            fontface = "bold"
              ) +
  scale_y_continuous(limits = c(-100, 100)) +
  scale_fill_manual(values=c(jri_light_blue, jri_gray)) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(face = c("plain", "plain", "plain", "plain", "bold", 
                                            "plain", "plain", "plain", "plain", "plain", "plain")),
        axis.title.y = element_text(angle = 90, size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top",
        legend.justification = c(0.5, 0),
        legend.title=element_blank())

```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_smi_primary_diagnoses_tier1hu, file=paste0(sp_data_path, "analysis/img/PRES_gg_smi_primary_diagnoses_tier1hu.png"), width = 14,  height = 7, dpi = 100, bg = 'transparent')
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_smi_primary_diagnoses_tier1hu.png"))
```
<br><br>







### Primary diagnosis for "suicidal ideation/attempt/intentional self-harm" Medicaid claims between FY2019-2021.

High utilizers were more likely to have a primary diagnosis for suicidal ideation/attempt/intentional self-harm.  

```{r}
# Find number and proportion of people with primary diagnosis for "suicidal ideation/attempt/intentional self-harm" 
# by hu_group_overall
smi_suicide_related_hu <- medicaid_encounters_cleaned_2018_2021 %>% 
  group_by(hu_group_exclusive) %>% 
  summarise(`Individuals w/ Medicaid Match (N)` = (n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
            
            `Individuals w/ suicidal ideation/attempt/intentional self-harm (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification_new == "Suicidal ideation/attempt/intentional self-harm"]),
            `Individuals w/ suicidal ideation/attempt/intentional self-harm (%)`= `Individuals w/ suicidal ideation/attempt/intentional self-harm (N)`/`Individuals w/ Medicaid Match (N)`,
            `Individuals w/out suicidal ideation/attempt/intentional self-harm (%)` = 1-`Individuals w/ suicidal ideation/attempt/intentional self-harm (%)`) 
  
# by state
smi_suicide_related_hu_state <- medicaid_encounters_cleaned_2018_2021 %>% 
  summarise(`Individuals w/ Medicaid Match (N)` = (n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
            
            `Individuals w/ suicidal ideation/attempt/intentional self-harm (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification_new == "Suicidal ideation/attempt/intentional self-harm"]),
            `Individuals w/ suicidal ideation/attempt/intentional self-harm (%)`= `Individuals w/ suicidal ideation/attempt/intentional self-harm (N)`/`Individuals w/ Medicaid Match (N)`,
            `Individuals w/out suicidal ideation/attempt/intentional self-harm (%)` = 1-`Individuals w/ suicidal ideation/attempt/intentional self-harm (%)`) %>% 
  mutate(hu_group_exclusive = "State")

# combine data
smi_suicide_related_hu <- rbind(smi_suicide_related_hu, smi_suicide_related_hu_state)

# change from wide to long format
smi_suicide_related_hu <- gather(smi_suicide_related_hu, population, pct, `Individuals w/ suicidal ideation/attempt/intentional self-harm (%)`:`Individuals w/out suicidal ideation/attempt/intentional self-harm (%)`, factor_key=TRUE) 
smi_suicide_related_hu <- smi_suicide_related_hu %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out suicidal ideation/attempt/intentional self-harm (%)",
                                        "Individuals w/ suicidal ideation/attempt/intentional self-harm (%)"),
                             labels = c("Individuals w/out suicidal ideation/attempt/intentional self-harm",
                                        "Individuals w/ suicidal ideation/attempt/intentional self-harm")))

PRES_gg_smi_suicide_related_hu <- 
  ggplot(smi_suicide_related_hu,
         aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_light_blue),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(smi_suicide_related_hu$population == "Individuals w/ suicidal ideation/attempt/intentional self-harm" ~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        # legend.position = "right",
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_smi_suicide_related_hu, file=paste0(sp_data_path, "analysis/img/PRES_gg_smi_suicide_related_hu.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_smi_suicide_related_hu.png"))
```

<br><br>

### Primary diagnosis for "alcohol-related disorders" Medicaid claims between FY2019-2021.

```{r}
# Find number and proportion of people with primary diagnosis for "alcohol-related disorders" 
# by hu_group_overall
alcohol_related_hu <- medicaid_encounters_cleaned_2018_2021 %>% 
  group_by(hu_group_exclusive) %>% 
  summarise(`Individuals w/ Medicaid Match (N)` = (n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
            
            `Individuals w/ alcohol-related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Alcohol-related disorders"]),
            `Individuals w/ alcohol-related disorders (%)`= `Individuals w/ alcohol-related disorders (N)`/`Individuals w/ Medicaid Match (N)`,
            `Individuals w/out alcohol-related disorders (%)` = 1-`Individuals w/ alcohol-related disorders (%)`) 
  
# by state
alcohol_related_hu_state <- medicaid_encounters_cleaned_2018_2021 %>% 
  summarise(`Individuals w/ Medicaid Match (N)` = (n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1])),
            
            `Individuals w/ alcohol-related disorders (N)` =  n_distinct(unique_person_id[dx_prmry_clinical_classification == "Alcohol-related disorders"]),
            `Individuals w/ alcohol-related disorders (%)`= `Individuals w/ alcohol-related disorders (N)`/`Individuals w/ Medicaid Match (N)`,
            `Individuals w/out alcohol-related disorders (%)` = 1-`Individuals w/ alcohol-related disorders (%)`) %>% 
  mutate(hu_group_exclusive = "State")

# combine data
alcohol_related_hu <- rbind(alcohol_related_hu, alcohol_related_hu_state)

# change from wide to long format
alcohol_related_hu <- gather(alcohol_related_hu, population, pct, `Individuals w/ alcohol-related disorders (%)`:`Individuals w/out alcohol-related disorders (%)`, factor_key=TRUE) 
alcohol_related_hu <- alcohol_related_hu %>% 
  mutate(population = factor(population, 
                             levels = c("Individuals w/out alcohol-related disorders (%)",
                                        "Individuals w/ alcohol-related disorders (%)"),
                             labels = c("Individuals w/out alcohol-related disorders",
                                        "Individuals w/ alcohol-related disorders")))

PRES_gg_alcohol_related_hu <- 
  ggplot(alcohol_related_hu,
         aes(x = reorder(hu_group_exclusive, desc(hu_group_exclusive)), y = pct, fill = population)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1.3)) +
  scale_fill_manual(values=c("gray",jri_green),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 7.5, family = "Franklin Gothic Book",
            color = case_when(alcohol_related_hu$population == "Individuals w/ alcohol-related disorders" ~ "white",
                              TRUE ~ "black")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        # legend.position = "right",
        legend.justification = c(0.5, 0.5),
        legend.direction = "vertical",
        legend.box = "horizontal",
        legend.position = "bottom",
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", color = "black"))
```

```{r, out.width="100%", echo=FALSE, layout = "l-body"}
ggsave(PRES_gg_alcohol_related_hu, file=paste0(sp_data_path, "analysis/img/PRES_gg_alcohol_related_hu.png"), width = 10,  height = 6, dpi = 100)
knitr::include_graphics(paste0(sp_data_path, "analysis/img/PRES_gg_alcohol_related_hu.png"))
```


<br><br>

**See full notes and business rules for variable creation in data dictionary for individual-level analytic file here: https://csgorg.sharepoint.com/:x:/s/Team-JC-Research/EUJfEABIuNNBvKARa4Kq1nwBvSLwsK4aH7K9oZDOWxbc1w?e=zLytTB**

<br><br>
