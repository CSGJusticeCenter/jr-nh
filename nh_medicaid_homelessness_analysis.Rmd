---
title: "Medicaid Match Analysis: Homelessness"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
---

```{r include=FALSE}
### set chunk output 
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

# Load functions, packages, and data
source("code/00_library.R")
source("code/01_functions.R")
source("code/rdas.R")
```

```{r include=FALSE}
######################
# MEDICAID DATA
######################

### import adm_all -- jail administrative that we'll compare to the numbers from the medicaid match files
load(paste0(sp_data_path, "/Data/analysis/r_data/adm_all.Rda", 
            sep = "")) 

### de-dup by individual and booking -- these are the two units of analysis for comparisons to the medicaid data
### here we are de-duping bookings with multiple charges as we don't need that information for this comparison
adm_all_dedup <- adm_all %>% 
  ungroup() %>% 
  distinct(id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs


### import medicaid_jail_all -- medicaid jail data that we'll compare to the numbers from the jail administrative files
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
medicaid_jail_all <- read_rds("D:/Analytic/medicaid_jail_all.rds") 

### de-dup (there are a few duplicate bookings) and create booking id for analysis
medicaid_jail_all_dedup <- medicaid_jail_all %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

### import jail_medicaid_analytic_individual_booking_level -- the individual-level analytic file created with all DHHS files
### file is unique by individual/booking
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
jail_medicaid_analytic_individual_booking_level <- read_rds("D:/Analytic/jail_medicaid_analytic_individual_booking_level.rds") 

### de-dup (there are a few duplicate bookings) and create booking id for analysis
jail_medicaid_analytic_individual_booking_level_dedup <- jail_medicaid_analytic_individual_booking_level %>% 
  distinct(unique_person_id, 
           booking_id,
           .keep_all = TRUE) %>% 
  mutate(unique_person_booking_id = paste0(unique_person_id,
                                    booking_id)) ### creating unique booking id with both individual and booking IDs

### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
jail_medicaid_analytic_individual_booking_level_dedup_hu_recode <- fnc_hu_group_exclusive(jail_medicaid_analytic_individual_booking_level_dedup) 

##########
# Update medicaid data with urban vs rural variable
# Update: now using USDA classification for binary variable (either rural or urban): see https://www.ers.usda.gov/data-products/rural-urban-continuum-codes.aspx for county-level classification
##########
jail_medicaid_analytic_individual_booking_level_dedup_urban_rural <- jail_medicaid_analytic_individual_booking_level_dedup %>% 
  mutate(usda_urban_rural_classification = case_when(
    county%in%c("Hillsborough","Strafford","Rockingham") ~ "Metro",
    county%in%c("Belknap","Carroll","Cheshire","Coos","Merrimack","Sullivan") ~ "Non-Metro", 
    TRUE ~ as.character(NA)))
```         

# DHHS Medicaid Match and Jail Booking Descriptive Analysis: Individuals Experiencing Homelessness

<br>

## Tables


### Table 1. Percentage of Individuals/Bookings who were Experiencing Homelessness at time of Medicaid Eligibility

Note: Since we only have homelessness data for individuals who matched to Medicaid enrollment data, our denominator for these metrics will be the sample of individuals who have at least one Medicaid enrollment during the study window (i.e., individuals who did not match to Medicaid data are excluded here). Because of this decision as well as the fact that the DHHS data notes whether an individual was experiencing homelessness at the beginning of a given Medicaid enrollment period. In other words, we wouldn't know if someone had housing at the beginning of enrollment and then experienced homelessness afterwards). 

**Because of these factors, we should all discuss how we understand and explain this measure. At the very least, we probably want to acknowledge that this is likely an under count** 


**Update**: I am currently using all homelessness data from the Medicaid Encounter file that occurred either before or during the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")


```{r echo=FALSE,message=FALSE,warning=FALSE}
### create table of highlighting the percentage of the medicaid sample that experienced homelessness at the beginning of any medicaid enrollment period in DHHS pull

# by county
medicaid_jail_homelessness_county_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(county) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  ungroup() %>% 
  dplyr::rename(`Jail` = county) 

# statewide
medicaid_jail_homelessness_overall_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
   dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  dplyr::mutate(`Jail` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_county_statewide_table <- rbind(medicaid_jail_homelessness_county_table,
                                                           medicaid_jail_homelessness_overall_table)

### print table via kableextra
kable(medicaid_jail_homelessness_county_statewide_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(10, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(7, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br>

**From 2019 to 2021, 26% of people who were matched to Medicaid had experienced homelessness.**    

```{r include = FALSE}
# Create homeless and not homeless dataframes for ggplot
homeless_by_county <- medicaid_jail_homelessness_county_statewide_table %>% 
  clean_names() %>% 
  select(county    = jail,
         total_pop = individuals_w_medicaid_match_n,
         total     = individuals_w_any_experience_of_homelessness_n) %>% 
  mutate(pct   = total/total_pop,
         type = "Homeless") %>% 
  filter(county != "Statewide") 
not_homeless_by_county <- homeless_by_county %>% 
  mutate(total = total_pop - total,
         pct = total/total_pop,
         type = "Not Homeless") %>% 
  select(county, 
         total_pop,
         total,
         pct,
         type)

# Add data togerther and arrange for display
df_homeless_by_county <- rbind(homeless_by_county, not_homeless_by_county)
arrange(df_homeless_by_county, county)

# Horizontal ggplot showing the proportion of people who experienced homelessness
ggplot(df_homeless_by_county, aes(x = county, y = pct, fill=forcats::fct_rev(type))) +
  geom_col(colour = "white", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_manual(values=c("gray",jri_dark_blue),
                    na.value = "white") +
  geom_text(aes(label = paste(round(pct*100, 0), "%", sep = ""), 
                fontface = 'bold'),
            position = position_fill(vjust = 0.5),
            vjust = 0.8,
            size = 10, family = "Franklin Gothic Book",
            color = case_when(df_homeless_by_county$type == "Homeless" ~ "white",
                              TRUE ~ "black")) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 0.85, size = 28, color = "black"),
        axis.text.y = element_text(size = 28, color = "black"),
        legend.position = "right",
        legend.justification = c(1, 0.5),
        legend.title=element_blank(),
        legend.text = element_text(family = "Franklin Gothic Book", size = 28, color = "black")) 

# ggsave(PRES_gg_homeless_county, file=paste0(sp_data_path, "/analysis/img/PRES_gg_homeless_county.png"), width = 12,  height = 6, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_homeless_county.png"))

ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_homeless_county.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    width = 12,
    height = 6,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

### Table 2. Percentage of Individuals/Bookings who were Experiencing Homelessness at time of Medicaid Eligibility by County Type (by rural/urban classification)

Note: Since we only have homelessness data for individuals who matched to Medicaid enrollment data, our denominator for these metrics will be the sample of individuals who have at least one Medicaid enrollment during the study window (i.e., individuals who did not match to Medicaid data are excluded here). Because of this decision as well as the fact that the DHHS data notes whether an individual was experiencing homelessness at the beginning of a given Medicaid enrollment period. In other words, we wouldn't know if someone had housing at the beginning of enrollment and then experienced homelessness afterwards). 

**Because of these factors, we should all discuss how we understand and explain this measure. At the very least, we probably want to acknowledge that this is likely an under count** 

**County-level USDA rural/urban county classification comes from https://www.ers.usda.gov/data-products/rural-urban-continuum-codes.aspx**


**Update**: I am currently using all homelessness data from the Medicaid Encounter file that occurred either before or during the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")


```{r echo=FALSE,message=FALSE,warning=FALSE}
### create table of highlighting the percentage of the medicaid sample that experienced homelessness at the beginning of any medicaid enrollment period in DHHS pull

# by county
medicaid_jail_homelessness_usda_table <- jail_medicaid_analytic_individual_booking_level_dedup_urban_rural %>% 
  dplyr::group_by(usda_urban_rural_classification) %>% 
  dplyr::summarise(`Number of Counties (N)` = n_distinct(county,
                                                         na.rm = TRUE),
                   `Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  ungroup() %>% 
  dplyr::rename(`USDA County Classification` = usda_urban_rural_classification) 

# statewide
medicaid_jail_homelessness_overall_table <- jail_medicaid_analytic_individual_booking_level_dedup_urban_rural %>% 
   dplyr::summarise(`Number of Counties (N)` = n_distinct(county,
                                                         na.rm = TRUE),
                    `Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                    `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                    `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                    `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                    `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                    `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  dplyr::mutate(`USDA County Classification` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_usda_statewide_table <- rbind(medicaid_jail_homelessness_usda_table,
                                                           medicaid_jail_homelessness_overall_table)

### print table via kableextra
kable(medicaid_jail_homelessness_usda_statewide_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(3, bold = TRUE) %>% 
  column_spec(5, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br><br>

### Table 3. Percentage of High Utilizer Individuals/Bookings who were Experiencing Homelessness at time of Medicaid Eligibility

Note: Since we only have homelessness data for individuals who matched to Medicaid enrollment data, our denominator for these metrics will be the sample of individuals who have at least one Medicaid enrollment during the study window (i.e., individuals who did not match to Medicaid data are excluded here). Because of this decision as well as the fact that the DHHS data notes whether an individual was experiencing homelessness at the beginning of a given Medicaid enrollment period. In other words, we wouldn't know if someone had housing at the beginning of enrollment and then experienced homelessness afterwards). 

**Because of these factors, we should all discuss how we understand and explain this measure. At the very least, we probably want to acknowledge that this is likely an under count** 

**Statistics for individuals who are high utilizers of jail are based on the top 10% percentile of statewide bookings.**


**Update**: I am currently using all homelessness data from the Medicaid Encounter file that occurred either before or during the study period (Medicaid eligibility start date <= 6/30/2021). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample")


```{r echo=FALSE,message=FALSE,warning=FALSE}
### create table of highlighting the percentage of the medicaid sample that experienced homelessness at the beginning of any medicaid enrollment period in DHHS pull

# by county
medicaid_jail_homelessness_hu_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

# statewide
medicaid_jail_homelessness_hu_overall_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>%  
  dplyr::mutate(`High Utilizer Percentiles` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_hu_statewide_table <- rbind(medicaid_jail_homelessness_hu_table,
                                                              medicaid_jail_homelessness_hu_overall_table)

### print table via kableextra
kable(medicaid_jail_homelessness_hu_statewide_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(7, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br><br>

### Table 4. Percentage of High Utilizer Individuals/Bookings who were Experiencing Homelessness at time of Medicaid Eligibility (**study period only for comparison**)

Note: Since we only have homelessness data for individuals who matched to Medicaid enrollment data, our denominator for these metrics will be the sample of individuals who have at least one Medicaid enrollment during the study window (i.e., individuals who did not match to Medicaid data are excluded here). Because of this decision as well as the fact that the DHHS data notes whether an individual was experiencing homelessness at the beginning of a given Medicaid enrollment period. In other words, we wouldn't know if someone had housing at the beginning of enrollment and then experienced homelessness afterwards). Percentages reflect the percentage of the Medicaid sample unless otherwise stated (e.g. "% of Overall Sample").

**Because of these factors, we should all discuss how we understand and explain this measure. At the very least, we probably want to acknowledge that this is likely an under count** 

**Statistics for individuals who are high utilizers of jail are based on the top 10% percentile of statewide bookings.**


```{r echo=FALSE,message=FALSE,warning=FALSE}
### create table of highlighting the percentage of the medicaid sample that experienced homelessness at the beginning of any medicaid enrollment period in DHHS pull

# by county
medicaid_jail_homelessness_hu_county_study_period_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[(study_homeless_on_eligibility_begin_flag==1)]),
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[(study_homeless_on_eligibility_begin_flag==1)]),
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

# statewide
medicaid_jail_homelessness_hu_overall_study_period_table <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[(study_homeless_on_eligibility_begin_flag==1)]),
                   `Individuals w/ any experience of homelessness (%)` = scales::percent(`Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`),
                   `Bookings w/ Medicaid Match (N)` = n_distinct(unique_person_booking_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Bookings w/ any experience of homelessness (N)` = n_distinct(unique_person_booking_id[(study_homeless_on_eligibility_begin_flag==1)]),
                   `Bookings w/ any experience of homelessness (%)` = scales::percent(`Bookings w/ any experience of homelessness (N)`/`Bookings w/ Medicaid Match (N)`))  %>%   
  dplyr::mutate(`High Utilizer Percentiles` = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_hu_county_statewide_study_period_table <- rbind(medicaid_jail_homelessness_hu_county_study_period_table,
                                                              medicaid_jail_homelessness_hu_overall_study_period_table)

### print table via kableextra
kable(medicaid_jail_homelessness_hu_county_statewide_study_period_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(7, bold = TRUE) %>% 
  scroll_box(width = "130%")

```

<br><br>

```{r}
# prepare data to analyze homelessness by race
# remove Carroll, Hillsborough, and Stafford bc of missing ethnicity data
nh_eight_county_medicaid_match_final_race_two_counties_excluded <- jail_medicaid_analytic_individual_booking_level_dedup_hu_recode %>% 
  # filter(medicaid_match_flag==1) %>% 
  mutate(race = ifelse(jail_race=="Black Hispanic",
                       "Black",
                       jail_race),
         race= ifelse(jail_race=="American Indian/Alaskan Native",
                                 "American Indian/Alaska Native",
                                 jail_race),
         race = ifelse(is.na(jail_race)==TRUE,
                       "Missing",
                       jail_race)) %>% 
  filter(!race%in%c("Missing","Unknown"),
         !county%in%c("Carroll","Hillsborough","Strafford")) %>% 
  ### dropping HU variables b/c we need to re-calculate for new sample w/o carroll and hillsborough
  dplyr::select(-c(num_entrances,high_utilizer_4_times:high_utilizer_10_pct,hu_group_exclusive,hu_group_overall))

nh_eight_county_medicaid_match_final_race_two_counties_excluded <- nh_eight_county_medicaid_match_final_race_two_counties_excluded %>% 
  mutate(race = case_when(
    race == "American Indian/Alaskan Native" ~ "Other",
    race == "Asian/Pacific Islander" ~ "Other",
    TRUE ~ race
  )) %>% 
  filter(!is.na(jail_dob_year),
         !is.na(booking_date)) %>% 
  mutate(jail_dob_age_clean = as.numeric(jail_dob_year),
         jail_booking_age_clean = year(ymd(as_date(booking_date))),
         age_at_booking_years = jail_booking_age_clean-jail_dob_age_clean) %>% 
  mutate(age_at_booking_bin = case_when(
    age_at_booking_years<25 ~ 1,
    age_at_booking_years>=25 & age_at_booking_years<=34 ~ 2,
    age_at_booking_years>34 & age_at_booking_years<=45 ~ 3,
    age_at_booking_years>45 ~ 4,
    TRUE ~ as.numeric(NA)),
    age_at_booking_bin = factor(age_at_booking_bin,
         levels = c(1,2,3,4),
         labels = c("18 to 24", "25 to 34", "35 to 45", "46+"))) %>%  ### use factor function to assign labels to values
    dplyr::filter(!is.na(age_at_booking_bin)==TRUE,
                  age_at_booking_years<100)

# create high utilizer variables using custom function
# create temporary id to use function then remove
nh_eight_county_medicaid_match_final_race_two_counties_excluded$id  <- nh_eight_county_medicaid_match_final_race_two_counties_excluded$unique_person_id

medicaid_jail_all_hus <- fnc_create_high_utilizer_variables(nh_eight_county_medicaid_match_final_race_two_counties_excluded)

nh_eight_county_medicaid_match_final_race <- nh_eight_county_medicaid_match_final_race_two_counties_excluded %>%
  left_join(medicaid_jail_all_hus, by = "id") %>%
  dplyr::select(-id) %>% 
  # Recoded HU variable
  mutate(hu_group_exclusive = case_when(high_utilizer_10_pct =="No"     ~ 4,
                                        high_utilizer_10_pct =="Yes" & 
                                          high_utilizer_5_pct=="No" & 
                                          high_utilizer_1_pct=="No"     ~ 3,
                                        high_utilizer_5_pct  =="Yes" & 
                                          high_utilizer_1_pct=="No"     ~ 2,
                                        high_utilizer_1_pct  =="Yes"    ~ 1,
                                        TRUE ~ as.numeric(NA)),
         hu_group_exclusive = factor(hu_group_exclusive, 
                                     levels = c(1,2,3,4),
                                     labels = c("Tier 1 HU", "Tier 2 HU", "Tier 3 HU", "Non-HU"))) %>% 
  # Overall HU variable
  mutate(hu_group_overall = case_when(high_utilizer_10_pct == "No"  ~ 2,
                                      high_utilizer_10_pct == "Yes" ~ 1,
                                      TRUE ~ as.numeric(NA)),
         hu_group_overall = factor(hu_group_overall,
                                   levels = c(1,2),
                                   labels = c("High Utilizer", "Non-High Utilizer")))
```

```{r}
# Homelessness by race
# by hu_group_overall
medicaid_jail_homelessness_hu_county_table <- nh_eight_county_medicaid_match_final_race %>% 
  dplyr::group_by(race, hu_group_overall) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>% 
  ungroup() %>% 
  dplyr::rename(`Race/Ethnicity` = race) 

# statewide
medicaid_jail_homelessness_hu_overall_table <- nh_eight_county_medicaid_match_final_race %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>%  
  dplyr::mutate(`Race/Ethnicity` = "Statewide",
                hu_group_overall = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_hu_county_statewide_table <- rbind(medicaid_jail_homelessness_hu_county_table,
                                                              medicaid_jail_homelessness_hu_overall_table)

# reactable table
reactable(medicaid_jail_homelessness_hu_county_statewide_table,
          pagination = FALSE,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(minWidth = 150,
            format = colFormat(separators = TRUE), align = "left"),
          compact = TRUE,
          fullWidth = FALSE,
          rowStyle = function(index) {
            if (index %in% c(9)) {
              list(`border-top` = "thin solid",
                   fontWeight = "bold")
            }
          },
          columns = list(
            `Race/Ethnicity` = colDef(minWidth = 150, name = "Race/Ethnicity", style = list(fontWeight = "bold")),
            hu_group_overall    = colDef(minWidth = 150, name = "Population", style = list(position = "sticky", borderRight = "1px solid #d3d3d3")),
            `Individuals w/ any experience of homelessness (%)` = colDef(format = colFormat(percent = TRUE, digits = 1)
            )))
```

```{r}
# prepare data to see homelessness by gender and hu group overall
medicaid_jail_homelessness_hu_county_statewide_data <- medicaid_jail_homelessness_hu_county_statewide_table %>% 
  mutate(pct = `Individuals w/ any experience of homelessness (%)`) %>%
  mutate(pct = round(pct, 2),
         pct_label = paste0(round(pct*100,0), "%")) %>% 
  filter(`Race/Ethnicity` != "Statewide") %>% 
  mutate(`Race/Ethnicity` = factor(`Race/Ethnicity`,
                                   levels = c("Hispanic",
                                              "White",
                                              "Black",
                                              "Other")))

# ggplot showing homelessness by hu_group_overall
medicaid_jail_homelessness_hu_county_statewide_data %>%
  mutate(pct = ifelse(hu_group_overall == "High Utilizer", pct, -1*pct)) %>% 
  ggplot(aes(x = `Race/Ethnicity`, y = pct, fill = hu_group_overall))+
  geom_bar(stat = "identity") +
  labs(x = "Race/Ethnicity\n", y = "Proportion of Individuals\n") +
   geom_text(aes(label = ifelse(pct > .02 | pct < 0, pct_label, "")),
            size = 7.5, family = "Franklin Gothic Book",
            hjust = ifelse(medicaid_jail_homelessness_hu_county_statewide_data$hu_group_overall == "High Utilizer", -.1, 1.1),
            color = ifelse(medicaid_jail_homelessness_hu_county_statewide_data$hu_group_overall == "High Utilizer", jri_orange, "black"),
            fontface = "bold"
              ) +
  scale_y_continuous(limits = c(-.55, .65)) +
  scale_fill_manual(values=c(jri_orange, "gray")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(face = "bold"),
        axis.title.y = element_text(angle = 90, size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top",
        legend.justification = c(.5, 0),
        legend.title=element_blank())

# ggsave(PRES_gg_diverge_race, file=paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_race.png"), width = 8,  height = 4, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_race.png"))

ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_race.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    width = 8,
    height = 4,
    units = "in",
    bg = "transparent"
  )
```

<br><br>

```{r}
# homelessness by gender
# by hu_group_overall
medicaid_jail_homelessness_hu_table <- nh_eight_county_medicaid_match_final_race %>% 
  filter(!is.na(gender)) %>% 
  dplyr::group_by(gender, hu_group_overall) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>% 
  ungroup() %>% 
  dplyr::rename(`Gender` = gender) 

# statewide
medicaid_jail_homelessness_hu_overall_table <- nh_eight_county_medicaid_match_final_race %>% 
  filter(!is.na(gender)) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>%  
  dplyr::mutate(`Gender` = "Statewide",
                hu_group_overall = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_hu_statewide_table <- rbind(medicaid_jail_homelessness_hu_table,
                                                              medicaid_jail_homelessness_hu_overall_table)

# reactable table
reactable(medicaid_jail_homelessness_hu_statewide_table,
          pagination = FALSE,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(minWidth = 150,
            format = colFormat(separators = TRUE), align = "left"),
          compact = TRUE,
          fullWidth = FALSE,
          rowStyle = function(index) {
            if (index %in% c(5)) {
              list(`border-top` = "thin solid",
                   fontWeight = "bold")
            }
          },
          columns = list(
            `Race/Ethnicity` = colDef(minWidth = 150, name = "", style = list(fontWeight = "bold")),
            hu_group_overall    = colDef(minWidth = 150, name = "Population", style = list(position = "sticky", borderRight = "1px solid #d3d3d3")),
            `Individuals w/ any experience of homelessness (%)` = colDef(format = colFormat(percent = TRUE, digits = 1)
            )))
```

<br><br>

```{r}
# by county
medicaid_jail_homelessness_hu_table <- nh_eight_county_medicaid_match_final_race %>% 
  filter(!is.na(age_at_booking_bin)) %>% 
  dplyr::group_by(age_at_booking_bin, hu_group_overall) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>% 
  ungroup() %>% 
  dplyr::rename(`Age Category` = age_at_booking_bin) 

# statewide
medicaid_jail_homelessness_hu_overall_table <- nh_eight_county_medicaid_match_final_race %>% 
  filter(!is.na(age_at_booking_bin)) %>% 
  dplyr::summarise(`Individuals w/ Medicaid Match (N)` = n_distinct(unique_person_id[pre_or_study_window_medicaid_match_flag_overall==1]),
                   `Individuals w/ any experience of homelessness (N)` = n_distinct(unique_person_id[pre_or_study_homeless_on_eligibility_begin_flag==1]),
                   `Individuals w/ any experience of homelessness (%)` = `Individuals w/ any experience of homelessness (N)`/`Individuals w/ Medicaid Match (N)`)  %>%  
  dplyr::mutate(`Age Category` = "Statewide",
                hu_group_overall = "Statewide") 

# rbind county and statewide files 
medicaid_jail_homelessness_hu_statewide_table <- rbind(medicaid_jail_homelessness_hu_table,
                                                              medicaid_jail_homelessness_hu_overall_table)

# reactable table
reactable(medicaid_jail_homelessness_hu_statewide_table,
          pagination = FALSE,
          style = list(fontFamily = "Franklin Gothic Book", fontSize = "1.0rem"),
          theme = reactableTheme(cellStyle = list(display = "flex", flexDirection = "column", justifyContent = "center")),
          defaultColDef = reactable::colDef(minWidth = 150,
            format = colFormat(separators = TRUE), align = "left"),
          compact = TRUE,
          fullWidth = FALSE,
          rowStyle = function(index) {
            if (index %in% c(9)) {
              list(`border-top` = "thin solid",
                   fontWeight = "bold")
            }
          },
          columns = list(
            `Race/Ethnicity` = colDef(minWidth = 150, name = "", style = list(fontWeight = "bold")),
            hu_group_overall    = colDef(minWidth = 150, name = "Population", style = list(position = "sticky", borderRight = "1px solid #d3d3d3")),
            `Individuals w/ any experience of homelessness (%)` = colDef(format = colFormat(percent = TRUE, digits = 1)
            )))
```

```{r}
medicaid_jail_homelessness_hu_statewide_data <- medicaid_jail_homelessness_hu_statewide_table %>% 
  mutate(pct = `Individuals w/ any experience of homelessness (%)`) %>%
  mutate(pct = round(pct, 2),
         pct_label = paste0(round(pct*100,0), "%")) %>% 
  filter(`Age Category` != "Statewide") %>% 
  mutate(`Age Category` = factor(`Age Category`,
                               levels = c("46+",
                                          "35 to 45",
                                          "25 to 34",
                                          "18 to 24")))

medicaid_jail_homelessness_hu_statewide_data %>%
  mutate(pct = ifelse(hu_group_overall == "High Utilizer", pct, -1*pct)) %>% 
  ggplot(aes(x = `Age Category`, y = pct, fill = hu_group_overall))+
  geom_bar(stat = "identity") +
  labs(x = "Age (Years)\n", y = "Proportion of Individuals\n") +
   geom_text(aes(label = ifelse(pct > .02 | pct < 0, pct_label, "")),
            size = 7.5, family = "Franklin Gothic Book",
            hjust = ifelse(medicaid_jail_homelessness_hu_statewide_data$hu_group_overall == "High Utilizer", -.1, 1.1),
            color = ifelse(medicaid_jail_homelessness_hu_statewide_data$hu_group_overall == "High Utilizer", jri_orange, "black"),
            fontface = "bold"
              ) +
  scale_y_continuous(limits = c(-.55, .65)) +
  scale_fill_manual(values=c(jri_orange, "gray")) +
  theme_no_grid_no_labels +
  coord_flip() +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(face = "bold"),
        axis.title.y = element_text(angle = 90, size = 22, color = "black"),
        axis.title.x = element_text(size = 22, color = "black"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.position = "top",
        legend.justification = c(.5, 0),
        legend.title=element_blank())

# ggsave(PRES_gg_diverge_age, file=paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_age.png"), width = 8,  height = 4, dpi = 100)
# knitr::include_graphics(paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_age.png"))

ggsave(
    filename = paste0(sp_data_path, "/analysis/img/PRES_gg_diverge_age.png"),
    plot = last_plot(),
    device = ragg::agg_png,
    dpi = 300,
    width = 8,
    height = 4,
    units = "in",
    bg = "transparent"
  )
```



















<br><br>
