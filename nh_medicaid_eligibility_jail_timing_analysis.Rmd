---
title: "Timing of Medicaid Eligibility and Jail Bookings"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
---

```{r include=FALSE}
# load packages
source("data_cleaning/00_library.R")
```

```{r include=FALSE}
### set chunk output 
knitr::opts_chunk$set(
  echo=FALSE, 
  message=FALSE, 
  warning=FALSE,
  dev = "ragg_png",
  cache = FALSE
  )

### set path using csg_sp_path
sp_data_path <- csg_sp_path(file.path("JR_NH"))
```


# DHHS Medicaid Match and Jail Booking Descriptive Analysis: Loss of Medicaid Coverage and Jail Bookings

<br>

## Tables


### Table 1: Timing of Medicaid Eligiblity End Dates and Jail Bookings (Enrollment-level)

**The following three tables explore the question on slide 44 -- Is Medicaid enrollment starting again when people are released from jail?**

**NOTE: While these tables indicate loss of Medicaid enrollment/eligibility/coverage that occurs during or soon after incarceration in jail, we cannot definitively attribute the reason for the loss to be incarceration because we don't have data on reasons for enrollment eligibility loss from DHHS. It will be important to acknowledge this if we present these data**

**For definitions of each column/flag created in the analytic file, see full data dictionary here (Enrollment-level File tab): https://csgorg.sharepoint.com/:x:/s/Team-JC-Research/EUJfEABIuNNBvKARa4Kq1nwBvSLwsK4aH7K9oZDOWxbc1w?e=JADcH8**


This table explores the percentages of Medicaid enrollments (ONLY for individuals who matched to Medicaid data) where enrollment/eligibility ended during incarceration as well as within 20 days of release from jail


```{r echo=FALSE,message=FALSE,warning=FALSE} 
### import medicaid_enrollment_jail_timing_all -- the analytic file with flags based on timing/overlap of medicaid eligibility end dates and jail booking/release dates
### this file lives on the external hard drive (created and exported in `14_medicaid.R`)
medicaid_enrollment_jail_timing_all <- read_rds("D:/Analytic/medicaid_enrollment_jail_timing_all.rds") 

# statewide
medicaid_enrollment_jail_timing_all_overall_table <- medicaid_enrollment_jail_timing_all %>% 
  dplyr::summarise(`Overall Medicaid Enrollments (N)` = n_distinct(unique_medicaid_enrollment_id),
                   `Enrollments Ending in or within 20 days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]),
                   `Enrollments Ending in or within 20 days of Release from Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Enrollments Ending in Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_jail==1]),
                   `Enrollments Ending in Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_jail==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Enrollments Ending within 5 Days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_5_days==1]),
                   `Enrollments Ending within 5 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_5_days==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Enrollments Ending 5-10 Days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_10_days==1]),
                   `Enrollments Ending 5-10 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_10_days==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Enrollments Ending 10-15 Days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_15_days==1]),
                   `Enrollments Ending 10-15 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_15_days==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Enrollments Ending 15-20 Days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_20_days==1]),
                   `Enrollments Ending 15-20 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_after_jail_within_20_days==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1)) 

### print table via kableextra
kable(medicaid_enrollment_jail_timing_all_overall_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br><br>

### Table 2: Timing of Medicaid Eligiblity End Dates and Jail Bookings (Individual-level)

**NOTE: While these tables indicate loss of Medicaid enrollment/eligibility/coverage that occurs during or soon after incarceration in jail, we cannot definitively attribute the reason for the loss to be incarceration because we don't have data on reasons for enrollment eligibility loss from DHHS. It will be important to acknowledge this if we present these data**

This table explores the percentage of individuals (ONLY for individuals who matched to Medicaid data) who experienced Medicaid enrollments where eligibility ended during incarceration as well as within 20 days of release from jail


We should probably think through the best way to talk about the enrollment-level versus individual-level analysis and why the numbers look so different

```{r echo=FALSE,message=FALSE,warning=FALSE} 
# statewide
medicaid_enrollment_jail_timing_all_individual_table <- medicaid_enrollment_jail_timing_all %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending in Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1]),
                   `Individuals w/ Enrollments Ending in Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1]),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1]),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1]),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1]),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1])/`Overall Individuals (N)`, accuracy=.1)) 

### print table via kableextra
kable(medicaid_enrollment_jail_timing_all_individual_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br><br>

### Table 3: Timing of Medicaid Eligiblity End Dates and Jail Bookings by HU Grouping (Individual-level)

**NOTE: While these tables indicate loss of Medicaid enrollment/eligibility/coverage that occurs during or soon after incarceration in jail, we cannot definitively attribute the reason for the loss to be incarceration because we don't have data on reasons for enrollment eligibility loss from DHHS. It will be important to acknowledge this if we present these data**

This table explores the percentage of individuals (ONLY for individuals who matched to Medicaid data) who experienced Medicaid enrollments where eligibility ended during incarceration as well as within 20 days of release from jail


We should probably think through the best way to talk about the enrollment-level versus individual-level analysis and why the numbers look so different

```{r echo=FALSE,message=FALSE,warning=FALSE} 
### to recode high utlizer percentile grouping, we don't need to group_by as the percentile grouping is already grouped across individual from Mari's cleaning
medicaid_enrollment_jail_timing_all_hu_recode <- medicaid_enrollment_jail_timing_all %>% 
  ### to ensure each individual/booking is in correct grouping, start with Non-HU, then 10% and move down to 1%
  mutate(hu_group_exclusive = case_when(
    high_utilizer_10_pct=="No" ~ 4,
    high_utilizer_10_pct=="Yes" & high_utilizer_5_pct=="No" & high_utilizer_1_pct=="No" ~ 3,
    high_utilizer_5_pct=="Yes" & high_utilizer_1_pct=="No" ~ 2,
    high_utilizer_1_pct=="Yes" ~ 1,
    TRUE ~ as.numeric(NA)),
    hu_group_exclusive = factor(hu_group_exclusive,
         levels = c(1,2,3,4),
         labels = c("Top 1%", "Top 5%", "Top 10%", "Non-HU")))

# HU grouping
medicaid_enrollment_jail_timing_hu_individual_table <- medicaid_enrollment_jail_timing_all_hu_recode %>% 
  dplyr::group_by(hu_group_exclusive) %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending in Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1]),
                   `Individuals w/ Enrollments Ending in Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1]),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1]),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1]),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1]),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1])/`Overall Individuals (N)`, accuracy=.1)) %>% 
  ungroup() %>% 
  dplyr::rename(`High Utilizer Percentiles` = hu_group_exclusive) 

# statewide
medicaid_enrollment_jail_timing_overall_individual_table <- medicaid_enrollment_jail_timing_all_hu_recode %>% 
  dplyr::summarise(`Overall Individuals (N)` = n_distinct(unique_person_id),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]),
                   `Individuals w/ Enrollments Ending in or within 20 days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending in Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1]),
                   `Individuals w/ Enrollments Ending in Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_jail==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1]),
                   `Individuals w/ Enrollments Ending within 5 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_5_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1]),
                   `Individuals w/ Enrollments Ending 5-10 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_10_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1]),
                   `Individuals w/ Enrollments Ending 10-15 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_15_days==1])/`Overall Individuals (N)`, accuracy=.1),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1]),
                   `Individuals w/ Enrollments Ending 15-20 Days of Release from Jail (%)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_after_jail_within_20_days==1])/`Overall Individuals (N)`, accuracy=.1)) %>% 
  dplyr::mutate(`High Utilizer Percentiles` = "Statewide") 

# rbind county and statewide files 
medicaid_enrollment_jail_timing_hu_overall_individual_table <- rbind(medicaid_enrollment_jail_timing_hu_individual_table,
                                                                 medicaid_enrollment_jail_timing_overall_individual_table)

### print table via kableextra
kable(medicaid_enrollment_jail_timing_hu_overall_individual_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") %>% 
  row_spec(5, bold = TRUE) %>% 
  column_spec(4, bold = TRUE) %>% 
  column_spec(6, bold = TRUE) %>% 
  column_spec(8, bold = TRUE) %>% 
  column_spec(10, bold = TRUE) %>% 
  column_spec(12, bold = TRUE) %>% 
  column_spec(14, bold = TRUE)
```

<br><br>

### Table 4: How long does Medicaid re-enrollment take? (Enrollment-level)

**NOTE: While these tables indicate loss of Medicaid enrollment/eligibility/coverage that occurs during or soon after incarceration in jail, we cannot definitively attribute the reason for the loss to be incarceration because we don't have data on reasons for enrollment eligibility loss from DHHS. It will be important to acknowledge this if we present these data**

**To do: how should we understand/treat overlapping enrollment periods? It is fairly rare, but does result in some weird calculations of time differences between the ending of one enrollment period and the beginning of the next. For now I'm filtering out differences of less than 0 days in calculations of mean and median**

This table explores the average number of days from the end of Medicaid eligibility (when it occurs during or within 20 days after incarceration) to re-enrollment/the following Medicaid eligibility start date for an individual. Analysis is at the enrollment-level


```{r echo=FALSE,message=FALSE,warning=FALSE} 
# statewide
medicaid_enrollment_jail_timing_to_re_enroll_table <- medicaid_enrollment_jail_timing_all %>% 
  dplyr::summarise(`Overall Medicaid Enrollments (N)` = n_distinct(unique_medicaid_enrollment_id),
                   `Enrollments Ending in or within 20 days of Release from Jail (% of all enrollments)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Mean Time to Medicaid Re-enrollment/Next Eligibility Start Date (Days)` = round(mean(medicaid_eligibility_end_next_begin_diff_days[medicaid_enroll_ends_during_or_within_20_days_jail==1 & medicaid_eligibility_end_next_begin_diff_days>=0], na.rm = TRUE), digits = 1),
                   `Median Time to Medicaid Re-enrollment/Next Eligibility Start Date (Days)` = round(median(medicaid_eligibility_end_next_begin_diff_days[medicaid_enroll_ends_during_or_within_20_days_jail==1 & medicaid_eligibility_end_next_begin_diff_days>=0], na.rm = TRUE), digits = 1),
                   `Enrollments Ending in or within 20 days of Release from Jail, No Re-enrollment Records (N)` = n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1 & medicaid_eligibility_end_no_new_begin_flag==1]),
                   `Enrollments Ending in or within 20 days of Release from Jail, No Re-enrollment Records (% of enrollments that ended)` = scales::percent(n_distinct(unique_person_id[medicaid_enroll_ends_during_or_within_20_days_jail==1 & medicaid_eligibility_end_no_new_begin_flag==1])/n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]), accuracy=.1)) 

### print table via kableextra
kable(medicaid_enrollment_jail_timing_to_re_enroll_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br><br>

### Table 5: Average Jail Length of Stay when Medicaid Enrollment/Eligibility Ends (Enrollment-level)

**NOTE: While these tables indicate loss of Medicaid enrollment/eligibility/coverage that occurs during or soon after incarceration in jail, we cannot definitively attribute the reason for the loss to be incarceration because we don't have data on reasons for enrollment eligibility loss from DHHS. It will be important to acknowledge this if we present these data**

This table explores the average number of days spent in jail when Medicaid enrollment/eligibility ends either during incarceration or within 20 days of release from jail

```{r echo=FALSE,message=FALSE,warning=FALSE} 
# statewide
medicaid_enrollment_ends_average_jail_los_table <- medicaid_enrollment_jail_timing_all %>% 
  dplyr::summarise(`Overall Medicaid Enrollments (N)` = n_distinct(unique_medicaid_enrollment_id),
                    `Enrollments Ending in or within 20 days of Release from Jail (N)` = n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1]),
                   `Enrollments Ending in or within 20 days of Release from Jail (% of all enrollments)` = scales::percent(n_distinct(unique_medicaid_enrollment_id[medicaid_enroll_ends_during_or_within_20_days_jail==1])/`Overall Medicaid Enrollments (N)`, accuracy=.1),
                   `Mean Jail Length of Stay (Days)` = round(mean(jail_los_medicaid_enroll_ends, na.rm = TRUE), digits = 1),
                   `Median Jail Length of Stay (Days)` = round(median(jail_los_medicaid_enroll_ends, na.rm = TRUE), digits = 1)) 

### print table via kableextra
kable(medicaid_enrollment_ends_average_jail_los_table, 
      format.args = list(big.mark = ","), 
      align=rep('c')) %>%
  kable_styling(bootstrap_options = c("striped", 
                                       "hover", 
                                       "condensed", 
                                       "responsive"), 
                 row_label_position = "l") 
```

<br><br>


## Visuals

TBD


<br><br>

